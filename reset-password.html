<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Nazakat</title>
    <link rel="icon" href="images/icons/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="logo">
                    <a href="index.html">Nazakat</a>
                </div>
                <h2 id="page-title">üîê Reset Your Password</h2>
                <p id="page-description">Enter your new password below.</p>
            </div>

            <!-- Loading State -->
            <div id="loading-section" class="auth-section">
                <div class="loading-spinner"></div>
                <p>Validating reset link...</p>
            </div>

            <!-- Password Reset Form -->
            <div id="reset-form-section" class="auth-section" style="display: none;">
                <form id="password-reset-form">
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <div class="password-field">
                            <input type="password" id="new-password" placeholder="Enter new password" required>
                            <i class="fas fa-eye password-toggle" id="toggle-new-password"></i>
                        </div>
                        <div class="password-requirements">
                            <small>Password must be at least 6 characters long</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <div class="password-field">
                            <input type="password" id="confirm-password" placeholder="Confirm new password" required>
                            <i class="fas fa-eye password-toggle" id="toggle-confirm-password"></i>
                        </div>
                    </div>

                    <div id="reset-error-message" class="error-message" style="display: none;"></div>
                    <div id="reset-success-message" class="success-message" style="display: none;"></div>

                    <button type="submit" class="auth-button" id="reset-password-button">Reset Password</button>
                </form>
            </div>

            <!-- Error State -->
            <div id="error-section" class="auth-section" style="display: none;">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Invalid or Expired Link</h3>
                <p id="error-message">This password reset link is invalid or has expired.</p>
                <a href="login.html" class="auth-button secondary">Back to Login</a>
            </div>

            <!-- Success State -->
            <div id="success-section" class="auth-section" style="display: none;">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Password Reset Successfully!</h3>
                <p>Your password has been updated. You can now log in with your new password.</p>
                <a href="login.html" class="auth-button">Go to Login</a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDmqhXGfxV8gOKWayKlAjf9b-jF2FdlAJ4",
            authDomain: "auric-a0c92.firebaseapp.com",
            projectId: "auric-a0c92",
            storageBucket: "auric-a0c92.appspot.com",
            messagingSenderId: "576050124885",
            appId: "1:576050124885:web:8dd7f78f89a3d0123b1f2a"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
    </script>

    <script src="js/firebase/firebase-auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Add a small delay to ensure Firebase is fully loaded
            await new Promise(resolve => setTimeout(resolve, 500));
            
            console.log('üî• Firebase available:', typeof firebase !== 'undefined');
            console.log('üî• FirebaseAuth available:', typeof window.FirebaseAuth !== 'undefined');
            
            if (typeof window.FirebaseAuth === 'undefined') {
                console.error('‚ùå FirebaseAuth not loaded');
                showErrorState('System initialization failed. Please refresh the page.');
                return;
            }
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');

            const loadingSection = document.getElementById('loading-section');
            const resetFormSection = document.getElementById('reset-form-section');
            const errorSection = document.getElementById('error-section');
            const successSection = document.getElementById('success-section');
            const errorMessage = document.getElementById('error-message');

            // Password visibility toggle
            function setupPasswordToggle(inputId, toggleId) {
                const passwordInput = document.getElementById(inputId);
                const toggleButton = document.getElementById(toggleId);
                
                if (passwordInput && toggleButton) {
                    toggleButton.addEventListener('click', function() {
                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);
                        toggleButton.classList.toggle('fa-eye');
                        toggleButton.classList.toggle('fa-eye-slash');
                    });
                }
            }

            setupPasswordToggle('new-password', 'toggle-new-password');
            setupPasswordToggle('confirm-password', 'toggle-confirm-password');

            // Show error message
            function showError(message) {
                const resetErrorMessage = document.getElementById('reset-error-message');
                if (resetErrorMessage) {
                    resetErrorMessage.textContent = message;
                    resetErrorMessage.style.display = 'block';
                }
            }

            // Show success message
            function showSuccess(message) {
                const resetSuccessMessage = document.getElementById('reset-success-message');
                if (resetSuccessMessage) {
                    resetSuccessMessage.textContent = message;
                    resetSuccessMessage.style.display = 'block';
                }
            }

            // Validate reset token
            async function validateResetToken() {
                if (!token || !email) {
                    showErrorState('Missing reset token or email address.');
                    return false;
                }

                try {
                    console.log('üîê Validating reset token for:', email);
                    const result = await FirebaseAuth.validatePasswordResetToken(email, token);
                    
                    if (result.success) {
                        console.log('‚úÖ Reset token is valid');
                        return true;
                    } else {
                        console.error('‚ùå Reset token validation failed:', result.error);
                        showErrorState(result.error || 'Invalid or expired reset link.');
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Error validating reset token:', error);
                    showErrorState('Unable to validate reset link. Please try again.');
                    return false;
                }
            }

            // Show error state
            function showErrorState(message) {
                loadingSection.style.display = 'none';
                resetFormSection.style.display = 'none';
                errorSection.style.display = 'block';
                successSection.style.display = 'none';
                errorMessage.textContent = message;
            }

            // Show form state
            function showFormState() {
                loadingSection.style.display = 'none';
                resetFormSection.style.display = 'block';
                errorSection.style.display = 'none';
                successSection.style.display = 'none';
            }

            // Show success state
            function showSuccessState() {
                loadingSection.style.display = 'none';
                resetFormSection.style.display = 'none';
                errorSection.style.display = 'none';
                successSection.style.display = 'block';
            }

            // Initialize page
            const isValid = await validateResetToken();
            if (isValid) {
                showFormState();
            }

            // Handle password reset form submission
            const passwordResetForm = document.getElementById('password-reset-form');
            if (passwordResetForm) {
                passwordResetForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;
                    const resetButton = document.getElementById('reset-password-button');

                    // Clear previous messages
                    document.getElementById('reset-error-message').style.display = 'none';
                    document.getElementById('reset-success-message').style.display = 'none';

                    // Validate passwords
                    if (!newPassword || !confirmPassword) {
                        showError('Please fill in all fields.');
                        return;
                    }

                    if (newPassword.length < 6) {
                        showError('Password must be at least 6 characters long.');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        showError('Passwords do not match.');
                        return;
                    }

                    // Disable button and show loading
                    resetButton.disabled = true;
                    resetButton.textContent = 'Resetting Password...';

                    try {
                        console.log('üîê Attempting to reset password for:', email);
                        const result = await FirebaseAuth.resetPassword(email, token, newPassword);

                        if (result.success) {
                            console.log('‚úÖ Password reset successful');
                            showSuccessState();
                        } else {
                            console.error('‚ùå Password reset failed:', result.error);
                            showError(result.error || 'Failed to reset password. Please try again.');
                        }
                    } catch (error) {
                        console.error('‚ùå Password reset error:', error);
                        showError('Failed to reset password. Please try again.');
                    } finally {
                        resetButton.disabled = false;
                        resetButton.textContent = 'Reset Password';
                    }
                });
            }
        });
    </script>
</body>
</html>