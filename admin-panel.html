<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nazakat Professional Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/out-of-stock-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        /* Professional Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: white;
            border-right: 1px solid #e2e8f0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar.show {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: #2563eb;
        }

        .sidebar-nav {
            padding: 16px 0;
        }

        .nav-item {
            display: block;
            padding: 12px 24px;
            color: #64748b;
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: #f1f5f9;
            color: #2563eb;
        }

        .nav-item.active {
            background-color: #eff6ff;
            color: #2563eb;
            border-left-color: #2563eb;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }

        /* Main Content Area */
        .main-container {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-container.full-width {
            margin-left: 0;
        }

        /* Header */
        .main-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: #64748b;
            cursor: pointer;
        }

        .mobile-close {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            z-index: 1002;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Content Area */
        .content {
            padding: 24px;
        }

        /* Cards */
        .card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .card-content {
            padding: 24px;
        }

        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stat-title {
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 12px;
            color: #64748b;
        }

        .stat-change.positive {
            color: #059669;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        /* Color scheme for stat cards */
        .stat-orders .stat-icon { background-color: #dc2626; }
        .stat-revenue .stat-icon { background-color: #059669; }
        .stat-customers .stat-icon { background-color: #7c3aed; }
        .stat-inventory .stat-icon { background-color: #ea580c; }

        /* Order status badges */
        .stat-badge {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-new { background-color: #fef3c7; color: #92400e; }
        .status-confirmed { background-color: #d1fae5; color: #065f46; }
        .status-cancelled { background-color: #fecaca; color: #991b1b; }

        /* Action buttons */
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #e2e8f0;
            color: #64748b;
        }

        .btn-outline:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
        }

        /* Remove top progress indicator - only use bottom scrollbar */

        /* Force scrollbars to always be visible in admin panel sections */
        .table-container::-webkit-scrollbar {
            height: 15px;
            -webkit-appearance: none;
        }

        .table-container::-webkit-scrollbar:horizontal {
            height: 15px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #cbd5e1, #94a3b8);
            border-radius: 8px;
            border: 2px solid #f1f5f9;
            min-width: 30px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #94a3b8, #64748b);
        }

        .table-container::-webkit-scrollbar-thumb:active {
            background: linear-gradient(to bottom, #64748b, #475569);
        }

        /* Additional styles to ensure scrollbars don't auto-hide */
        .table-container {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: auto;
        }

        /* Restore normal card content padding */
        .card-content {
            padding: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px; /* Ensure tables are wide enough to scroll */
        }

        th {
            background-color: #f8fafc;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-success {
            background-color: #059669;
            color: white;
        }

        .btn-success:hover {
            background-color: #047857;
        }

        .btn-danger {
            background-color: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        /* Product Management Styles */
        .product-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .product-image-container {
            width: 100%;
            height: 200px;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0; /* Start hidden, show on load */
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .product-category {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 12px;
        }

        .product-info {
            text-align: center;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e293b;
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-price {
            color: #2563eb;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .product-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-outline {
            background-color: transparent;
            color: #2563eb;
            border: 1px solid #2563eb;
        }

        .btn-outline:hover {
            background-color: #2563eb;
            color: white;
        }

        /* Section Tabs */
        .section-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Horizontal scrolling for section tabs on small screens */
        @media (max-width: 640px) {
            .section-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                scrollbar-width: thin;
                scrollbar-color: #cbd5e1 transparent;
                padding-bottom: 8px;
            }
            
            .section-tabs::-webkit-scrollbar {
                height: 6px;
            }
            
            .section-tabs::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .section-tabs::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            
            .section-tabs::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
            
            .section-tab {
                padding: 12px 16px;
                font-size: 14px;
                min-width: 120px;
            }
        }

        .section-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: auto;
        }

        .section-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .section-tab:hover {
            color: #2563eb;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #64748b;
        }

        .loading i {
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Status Indicators */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-confirmed {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Inventory Management Styles */
        .inventory-tab-content {
            margin-top: 16px;
        }

        .stock-count {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .stock-count.zero {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .stock-count.low {
            background-color: #fef3c7;
            color: #f59e0b;
        }

        .stock-count.normal {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .out-of-stock-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10;
        }

        .out-of-stock-badge.low-stock {
            background-color: #f59e0b;
        }

        .product-image-container {
            position: relative;
            overflow: hidden;
        }

        .product-image-container.out-of-stock {
            opacity: 0.6;
        }

        .product-image-container.out-of-stock::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(220, 38, 38, 0.1);
            z-index: 5;
        }

        .notification-count-badge.low-stock {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .nav-item {
            position: relative;
        }

        #inventory-nav .notification-count-badge {
            position: absolute;
            top: 8px;
            right: 16px;
        }

        /* Notification Badge Styles */
        .notification-count-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 12px;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 10;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .notification-unread-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background-color: #dc2626;
            border-radius: 50%;
            z-index: 11;
            border: 1px solid white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Notification Item Styles */
        .notification-item {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item:hover {
            background-color: #f8fafc;
        }

        .notification-item.unread {
            background-color: #f0f9ff;
            border-left: 4px solid #0ea5e9;
        }

        .notification-time {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .unread-indicator {
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            position: absolute;
            top: 12px;
            right: 12px;
        }

        .pending-order-notification {
            border-radius: 6px;
            padding: 2px 6px;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-info {
            padding: 16px;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e293b;
        }

        .product-price {
            font-size: 18px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 12px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        /* Button Styles */
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .btn-success {
            background: #059669;
            color: white;
            border-color: #059669;
        }

        .btn-success:hover {
            background: #047857;
            border-color: #047857;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        /* Period Selector Styles */
        .period-btn {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .period-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            color: #2563eb;
        }

        .period-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .period-btn i {
            font-size: 12px;
        }

        /* Custom Confirmation Modal Styling */
        .custom-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        /* Delete Product Modal Styling */
        .delete-product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(6px);
            z-index: 15000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease;
        }

        .delete-product-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.25);
            max-width: 520px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideInScale 0.4s ease;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .delete-product-header {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            padding: 32px 32px 24px;
            text-align: center;
            border-bottom: 1px solid #fecaca;
        }

        .delete-product-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: white;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 24px rgba(239, 68, 68, 0.4);
            }
        }

        /* Mobile responsiveness for delete product modal */
        @media (max-height: 700px) {
            .delete-product-content {
                max-height: 95vh;
            }
            .delete-product-header {
                padding: 24px 24px 20px;
            }
            .delete-product-body {
                padding: 20px 24px;
            }
            .delete-product-actions {
                padding: 20px 24px 24px;
            }
        }

        @media (max-height: 600px) {
            .delete-product-icon {
                width: 60px;
                height: 60px;
                font-size: 28px;
                margin-bottom: 16px;
            }
            .delete-product-title {
                font-size: 20px;
            }
            .delete-product-header {
                padding: 20px 20px 16px;
            }
            .delete-product-body {
                padding: 16px 20px;
            }
            .delete-product-actions {
                padding: 16px 20px 20px;
                gap: 12px;
            }
        }

        .delete-product-title {
            font-size: 24px;
            font-weight: 700;
            color: #dc2626;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .delete-product-subtitle {
            font-size: 16px;
            color: #7f1d1d;
            margin: 0;
            font-weight: 500;
        }

        .delete-product-body {
            padding: 32px;
            flex: 1;
            overflow-y: auto;
        }

        .delete-product-message {
            font-size: 16px;
            color: #374151;
            line-height: 1.6;
            margin: 0 0 24px 0;
            text-align: center;
        }

        .delete-product-info {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
            text-align: left;
        }

        .delete-product-info h4 {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .delete-product-info p {
            font-size: 14px;
            color: #64748b;
            margin: 6px 0;
            line-height: 1.5;
        }

        .delete-product-info strong {
            color: #374151;
            font-weight: 600;
        }

        .delete-warning-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .delete-warning-box .warning-icon {
            font-size: 24px;
            color: #d97706;
            margin-bottom: 12px;
        }

        .delete-warning-box p {
            color: #92400e;
            font-weight: 600;
            margin: 0;
            font-size: 15px;
            line-height: 1.4;
        }

        .delete-product-actions {
            padding: 24px 32px 32px;
            display: flex;
            gap: 16px;
            justify-content: center;
            background: #fafbfc;
            border-top: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .delete-product-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .delete-product-btn.cancel {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            color: #64748b;
            border: 2px solid #cbd5e1;
        }

        .delete-product-btn.cancel:hover {
            background: linear-gradient(135deg, #f1f5f9, #cbd5e1);
            color: #475569;
            border-color: #94a3b8;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .delete-product-btn.confirm {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: 2px solid #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .delete-product-btn.confirm:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .delete-product-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .delete-product-btn .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes slideInScale {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-40px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .custom-confirm-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
            max-width: 480px;
            width: 90%;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        .custom-confirm-header {
            padding: 24px 32px 16px;
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
        }

        .custom-confirm-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
        }

        .custom-confirm-icon.confirm-action {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .custom-confirm-icon.cancel-action {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .custom-confirm-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 8px 0;
        }

        .custom-confirm-subtitle {
            font-size: 14px;
            color: #64748b;
            margin: 0;
        }

        .custom-confirm-body {
            padding: 24px 32px;
            text-align: center;
        }

        .custom-confirm-message {
            font-size: 16px;
            color: #374151;
            line-height: 1.6;
            margin: 0 0 24px 0;
        }

        .custom-confirm-order-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: left;
        }

        .custom-confirm-order-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 12px 0;
        }

        .custom-confirm-order-info p {
            font-size: 13px;
            color: #64748b;
            margin: 4px 0;
        }

        .custom-confirm-actions {
            padding: 20px 32px 32px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .custom-confirm-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .custom-confirm-btn.primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .custom-confirm-btn.primary:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        .custom-confirm-btn.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .custom-confirm-btn.success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .custom-confirm-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .custom-confirm-btn.danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        .custom-confirm-btn.secondary {
            background: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .custom-confirm-btn.secondary:hover {
            background: #f1f5f9;
            color: #475569;
            border-color: #cbd5e1;
        }

        .custom-confirm-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .custom-confirm-btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1001;
            }

            .sidebar.show {
                transform: translateX(0);
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            }

            .main-container {
                margin-left: 0;
            }

            .mobile-toggle {
                display: block;
            }

            .mobile-close {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header-title {
                font-size: 20px;
            }

            .content {
                padding: 16px;
            }

            /* Add overlay when sidebar is open on mobile */
            .sidebar.show::after {
                content: '';
                position: fixed;
                top: 0;
                left: 280px;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: -1;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                Nazakat Admin
            </div>
            <button class="mobile-close" onclick="closeSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            <a href="#" class="nav-item" onclick="showSection('products')">
                <i class="fas fa-box"></i>
                Products
            </a>
            <a href="#" class="nav-item" onclick="showSection('inventory')" id="inventory-nav">
                <i class="fas fa-warehouse"></i>
                Inventory
                <span id="inventory-alert-badge" class="notification-count-badge" style="display: none;">0</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('orders')">
                <i class="fas fa-shopping-cart"></i>
                Orders
            </a>
            <a href="#" class="nav-item" onclick="showSection('customers')">
                <i class="fas fa-users"></i>
                Customers
            </a>
            <!-- <a href="#" class="nav-item" onclick="showSection('inventory')">
                <i class="fas fa-warehouse"></i>
                Inventory
            </a>
            <a href="#" class="nav-item" onclick="showSection('analytics')">
                <i class="fas fa-chart-line"></i>
                Analytics
            </a> -->
            <a href="index.html" class="nav-item">
                <i class="fas fa-home"></i>
                Back to Store
            </a>
        </nav>
    </div>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Header -->
        <header class="main-header">
            <div class="header-left">
                <button class="mobile-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="header-title"> Admin panel</h1>
            </div>
            <div class="header-actions">
                <div style="position: relative; display: inline-block;">
                    <button class="btn btn-outline" onclick="showSection('notifications')" style="position: relative;">
                        <i class="fas fa-bell"></i>
                        Notifications
                    </button>
                    <span class="notification-count-badge" id="notification-count" style="display: none;">0</span>
                </div>
                <button class="btn btn-primary" onclick="openProductsAdmin()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <!-- Time Period Selector -->
                <div style="margin-bottom: 24px; background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px;">Analytics Period</h3>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="period-btn" onclick="changePeriod('today')" id="period-today">
                            <i class="fas fa-calendar-day"></i> Today
                        </button>
                        <button class="period-btn" onclick="changePeriod('week')" id="period-week">
                            <i class="fas fa-calendar-week"></i> This Week
                        </button>
                        <button class="period-btn active" onclick="changePeriod('month')" id="period-month">
                            <i class="fas fa-calendar-alt"></i> This Month
                        </button>
                        <button class="period-btn" onclick="changePeriod('year')" id="period-year">
                            <i class="fas fa-calendar"></i> This Year
                        </button>
                        <button class="period-btn" onclick="changePeriod('overall')" id="period-overall">
                            <i class="fas fa-infinity"></i> Overall
                        </button>
                    </div>
                </div>

                <!-- Statistics Grid -->
                <div class="stats-grid">
                    <div class="stat-card stat-orders">
                        <div class="stat-header">
                            <div class="stat-title">Total Orders</div>
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="total-orders">0</div>
                        <div class="stat-change" id="orders-change">Loading...</div>
                    </div>

                    <div class="stat-card stat-revenue">
                        <div class="stat-header">
                            <div class="stat-title">Total Revenue</div>
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="total-revenue">₹0</div>
                        <div class="stat-change" id="revenue-change">Loading...</div>
                    </div>

                    <div class="stat-card stat-customers">
                        <div class="stat-header">
                            <div class="stat-title">Total Customers</div>
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="total-customers">0</div>
                        <div class="stat-change" id="customers-change">Loading...</div>
                    </div>

                    <div class="stat-card stat-inventory">
                        <div class="stat-header">
                            <div class="stat-title">Inventory Value</div>
                            <div class="stat-icon">
                                <i class="fas fa-warehouse"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="inventory-value">₹0</div>
                        <div class="stat-change" id="inventory-change">Loading...</div>
                    </div>
                </div>

                <!-- New Orders (Pending) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">New Orders (Pending)</h2>
                        <div class="stat-badge" id="new-orders-count">0</div>
                    </div>
                    <div class="card-content">
                        <div id="new-orders-loading" class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading new orders...
                        </div>
                        <div class="table-container" style="display: none;" id="new-orders-table-container">
                            <table id="new-orders-table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Amount</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div id="new-orders-empty" style="display: none; text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-inbox fa-3x" style="margin-bottom: 16px; opacity: 0.3;"></i>
                            <h3>No New Orders</h3>
                            <p>All caught up! No pending orders to process.</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Orders</h2>
                        <button class="btn btn-outline" onclick="showSection('orders')">
                            <i class="fas fa-eye"></i>
                            View All
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="recent-orders-loading" class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading confirmed orders...
                        </div>
                        <div id="orders-table" style="display: none;">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orders-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="products" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Product Management</h2>
                        <button class="btn btn-secondary" onclick="loadProducts()">
                            <i class="fas fa-refresh"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-content">
                        <!-- Search Bar for Products -->
                        <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <input type="text" id="productSearchInput" placeholder="Search products by name..."
                                           style="width: 100%; padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;"
                                           oninput="searchProducts()" onkeydown="handleProductSearchKeydown(event)">
                                </div>
                                <button class="btn btn-outline" onclick="clearProductSearch()" style="padding: 10px 16px;">
                                    <i class="fas fa-times"></i>
                                    Clear
                                </button>
                                <div id="productSearchResults" style="font-size: 12px; color: #64748b; margin-left: 8px;">
                                    <!-- Search results count will appear here -->
                                </div>
                            </div>
                        </div>

                        <div class="section-tabs">
                            <button class="section-tab active" onclick="filterProducts('all')">All Products</button>
                            <button class="section-tab" onclick="filterProducts('featured-collection')">Featured Collection</button>
                            <button class="section-tab" onclick="filterProducts('new-arrivals')">New Arrivals</button>
                            <button class="section-tab" onclick="filterProducts('saree-collection')">Saree Collection</button>
                        </div>
                        <div id="products-loading" class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading products...
                        </div>
                        <div id="products-grid" class="product-grid" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventory" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Inventory Management</h2>
                        <button class="btn btn-secondary" onclick="refreshInventoryData()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-content">
                        <!-- Inventory Summary Cards -->
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card" style="border-left: 4px solid #dc2626;">
                                <div class="stat-header">
                                    <div class="stat-title">Out of Stock</div>
                                    <div class="stat-icon">
                                        <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="out-of-stock-count">0</div>
                                <div class="stat-change" style="color: #dc2626;">Requires immediate attention</div>
                            </div>

                            <div class="stat-card" style="border-left: 4px solid #f59e0b;">
                                <div class="stat-header">
                                    <div class="stat-title">Low Stock</div>
                                    <div class="stat-icon">
                                        <i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="low-stock-count">0</div>
                                <div class="stat-change" style="color: #f59e0b;">≤ 5 items remaining</div>
                            </div>

                            <div class="stat-card" style="border-left: 4px solid #10b981;">
                                <div class="stat-header">
                                    <div class="stat-title">In Stock</div>
                                    <div class="stat-icon">
                                        <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="in-stock-count">0</div>
                                <div class="stat-change" style="color: #10b981;">Available for sale</div>
                            </div>

                            <div class="stat-card" style="border-left: 4px solid #6366f1;">
                                <div class="stat-header">
                                    <div class="stat-title">Total Products</div>
                                    <div class="stat-icon">
                                        <i class="fas fa-cube" style="color: #6366f1;"></i>
                                    </div>
                                </div>
                                <div class="stat-value" id="total-products-count">0</div>
                                <div class="stat-change" style="color: #6366f1;">Across all categories</div>
                            </div>
                        </div>

                        <!-- Stock Alerts Tabs -->
                        <div class="section-tabs">
                            <button class="section-tab active" onclick="showInventoryTab('out-of-stock')">
                                <i class="fas fa-times-circle" style="color: #dc2626; margin-right: 4px;"></i>
                                Out of Stock
                                <span id="out-of-stock-tab-count" class="notification-count-badge" style="margin-left: 8px; position: relative; top: auto; right: auto;">0</span>
                            </button>
                            <button class="section-tab" onclick="showInventoryTab('low-stock')">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-right: 4px;"></i>
                                Low Stock
                                <span id="low-stock-tab-count" class="notification-count-badge low-stock" style="margin-left: 8px; position: relative; top: auto; right: auto; background: #f59e0b;">0</span>
                            </button>
                            <button class="section-tab" onclick="showInventoryTab('all-products')">
                                <i class="fas fa-list"></i>
                                All Products
                            </button>
                        </div>

                        <!-- Out of Stock Products -->
                        <div id="out-of-stock-products" class="inventory-tab-content">
                            <div id="out-of-stock-loading" class="loading">
                                <i class="fas fa-spinner"></i>
                                Loading out-of-stock products...
                            </div>
                            <div id="out-of-stock-list" style="display: none;">
                                <div class="product-grid" id="out-of-stock-grid">
                                    <!-- Out of stock products will be loaded here -->
                                </div>
                            </div>
                            <div id="out-of-stock-empty" style="display: none; text-align: center; padding: 40px; color: #64748b;">
                                <i class="fas fa-check-circle fa-3x" style="margin-bottom: 16px; opacity: 0.3; color: #10b981;"></i>
                                <h3>All Products In Stock</h3>
                                <p>Great! No products are currently out of stock.</p>
                            </div>
                        </div>

                        <!-- Low Stock Products -->
                        <div id="low-stock-products" class="inventory-tab-content" style="display: none;">
                            <div id="low-stock-loading" class="loading">
                                <i class="fas fa-spinner"></i>
                                Loading low-stock products...
                            </div>
                            <div id="low-stock-list" style="display: none;">
                                <div class="product-grid" id="low-stock-grid">
                                    <!-- Low stock products will be loaded here -->
                                </div>
                            </div>
                            <div id="low-stock-empty" style="display: none; text-align: center; padding: 40px; color: #64748b;">
                                <i class="fas fa-check-circle fa-3x" style="margin-bottom: 16px; opacity: 0.3; color: #10b981;"></i>
                                <h3>No Low Stock Products</h3>
                                <p>All products have adequate stock levels.</p>
                            </div>
                        </div>

                        <!-- All Products Inventory View -->
                        <div id="all-products-inventory" class="inventory-tab-content" style="display: none;">
                            <div id="all-inventory-loading" class="loading">
                                <i class="fas fa-spinner"></i>
                                Loading all products inventory...
                            </div>
                            <div id="all-inventory-list" style="display: none;">
                                <div class="table-container">
                                    <table id="inventory-table">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Category</th>
                                                <th>Price</th>
                                                <th>Stock Level</th>
                                                <th>Status</th>
                                                <th>Last Updated</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventory-tbody">
                                            <!-- All products inventory will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Order Management</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="loadOrders()">
                                <i class="fas fa-refresh"></i>
                                Refresh Orders
                            </button>
                            <!-- <button class="btn btn-primary" onclick="createShipmentForVisibleOrders()">
                                <i class="fas fa-truck"></i> Ship Selected
                            </button> -->
                        </div>
                    </div>
                    <div class="card-content">
                        <!-- Search Bar -->
                        <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <input type="text" id="orderSearchInput" placeholder="Search by Order ID, Customer Name, Email, or Phone..."
                                           style="width: 100%; padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;"
                                           oninput="searchOrders()" onkeydown="handleSearchKeydown(event)">
                                </div>
                                <button class="btn btn-outline" onclick="clearSearch()" style="padding: 10px 16px;">
                                    <i class="fas fa-times"></i>
                                    Clear
                                </button>
                                <div id="searchResults" style="font-size: 12px; color: #64748b; margin-left: 8px;">
                                    <!-- Search results count will appear here -->
                                </div>
                            </div>
                        </div>

                        <div class="section-tabs">
                            <button class="section-tab active" onclick="filterOrders('all')">All Orders</button>
                            <button class="section-tab" onclick="filterOrders('pending')">Pending</button>
                            <button class="section-tab" onclick="filterOrders('confirmed')">Confirmed</button>
                            <button class="section-tab" onclick="filterOrders('cancelled')">Cancelled</button>
                        </div>
                        <div id="orders-section-loading" class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading orders...
                        </div>
                        <div id="orders-section-table" style="display: none;">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Date</th>
                                            <th>Items</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orders-section-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers Section -->
            <div id="customers" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Customer Management</h2>
                        <button class="btn btn-secondary" onclick="loadCustomers()">
                            <i class="fas fa-refresh"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-content">
                        <!-- Search Bar for Customers -->
                        <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 300px;">
                                    <input type="text" id="customerSearchInput" placeholder="Search by UID, Name, or Email..."
                                           style="width: 100%; padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;"
                                           oninput="searchCustomers()" onkeydown="handleCustomerSearchKeydown(event)">
                                </div>
                                <button class="btn btn-outline" onclick="clearCustomerSearch()" style="padding: 10px 16px;">
                                    <i class="fas fa-times"></i>
                                    Clear
                                </button>
                                <div id="customerSearchResults" style="font-size: 12px; color: #64748b; margin-left: 8px;">
                                    <!-- Search results count will appear here -->
                                </div>
                            </div>
                        </div>

                        <div id="customers-loading" class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading customers...
                        </div>
                        <div id="customers-table" style="display: none;">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>UID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Orders</th>
                                            <th>Total Spent</th>
                                            <th>Last Order</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customers-tbody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventory" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Inventory Overview</h2>
                        <button class="btn btn-secondary" onclick="loadInventoryData()">
                            <i class="fas fa-refresh"></i>
                            Refresh
                        </button>
                        <button class="btn btn-primary" onclick="testDataLoading()" style="margin-left: 8px;">
                            <i class="fas fa-bug"></i>
                            Debug All Data
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="inventory-loading" class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading inventory data...
                        </div>
                        <div id="inventory-content">
                            <p>Inventory management features will be displayed here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Analytics & Reports</h2>
                        <button class="btn btn-secondary">
                            <i class="fas fa-download"></i>
                            Export Report
                        </button>
                    </div>
                    <div class="card-content">
                        <p>Analytics and reporting features will be implemented here.</p>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            <div id="notifications" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Notifications</h2>
                        <button class="btn btn-secondary" onclick="loadNotifications()">
                            <i class="fas fa-refresh"></i>
                            Refresh Notifications
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="notifications-loading" class="loading">
                            <i class="fas fa-spinner"></i>
                            Loading notifications...
                        </div>
                        <div id="notifications-list" style="display: none;">
                            <!-- Notification items will be loaded here -->
                        </div>
                        <div id="notifications-empty" style="display: none; text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-bell-slash fa-3x" style="margin-bottom: 16px; opacity: 0.3;"></i>
                            <h3>No New Notifications</h3>
                            <p>All caught up! No new notifications to display.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Stock Management System -->
    <script src="js/stock-manager.js"></script>
    <script src="js/out-of-stock-handler.js"></script>

    <!-- Verification Modal -->
    <div id="verificationModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 20000; display: none; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);">
            <div style="margin-bottom: 30px;">
                <i class="fas fa-shield-alt" style="font-size: 48px; color: #2563eb; margin-bottom: 15px;"></i>
                <h2 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">Admin Panel Access</h2>
                <p style="margin: 0; color: #64748b;">Enter the 4-digit verification code to access admin panel</p>
            </div>
            
            <div style="margin-bottom: 25px;">
                <input type="password" id="verificationCode" placeholder="Enter 4-digit code" maxlength="4" 
                       style="width: 200px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold; letter-spacing: 3px;" 
                       oninput="handleCodeInput(this)" onkeydown="handleCodeKeydown(event)">
            </div>
            
            <div id="verificationError" style="color: #dc2626; margin-bottom: 20px; font-size: 14px; display: none;">
                <i class="fas fa-exclamation-triangle"></i> Incorrect verification code. Please try again.
            </div>
            
            <button onclick="verifyCode()" style="background: #2563eb; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                <i class="fas fa-unlock"></i> Verify Access
            </button>
        </div>
    </div>

    <script>
        // Initialize Firebase - using same config as checkout page
        const firebaseConfig = {
            apiKey: "AIzaSyCrLCButDevLeILcBjrUCd9e7amXVjW-uI",
            authDomain: "auric-a0c92.firebaseapp.com",
            projectId: "auric-a0c92",
            storageBucket: "auric-a0c92.appspot.com",
            messagingSenderId: "869158319434",
            appId: "1:869158319434:web:e8c27b3d4763b7b5c11d03"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Admin access without authentication (rules allow this)
        let authInitialized = false;
        async function initializeAdminAuth() {
            console.log('🔄 Admin dashboard using unauthenticated access (rules allow this)');
            // Skip authentication entirely - Firestore rules now allow unauthenticated access
            authInitialized = true;
            return true;
        }

        // Global variables - EXACT copy from working admin-dashboard.html
        let allOrders = [];
        let newOrders = [];
        let confirmedOrders = [];
        let cancelledOrders = [];
        let allCustomers = [];
        let currentProductCategory = 'all';
        let currentOrderFilter = 'all';
        let notifications = []; // Array to store notifications with read/unread status
        let notificationIdCounter = 0; // Counter for unique notification IDs
        let currentPeriod = 'month'; // Current analytics period
        let selectedOrderIds = new Set(); // For bulk actions
        let productsCache = null; // Cache for product data
        let isLoadingProducts = false; // Flag to prevent multiple product loads

        // Create demo data for testing when Firebase is unavailable
        function createDemoData() {
            console.log('Creating demo data for admin dashboard...');

            // Demo orders data
            const demoOrdersData = [
                {
                    orderId: 'ORDER_001',
                    userId: 'demo_user_1',
                    orderReference: 'AUR-2025-001',
                    date: new Date('2025-01-10'),
                    amount: 25000,
                    customerName: 'Priya Sharma',
                    customerEmail: 'priya.sharma@example.com',
                    customerPhone: '+91 9876543210',
                    customerAddress: '123 MG Road, Bangalore 560001',
                    paymentMethod: 'Razorpay',
                    products: [
                        { name: 'Gold Diamond Necklace', price: 25000, quantity: 1 }
                    ],
                    notes: 'Gift wrapping requested',
                    status: 'new'
                },
                {
                    orderId: 'ORDER_002',
                    userId: 'demo_user_2',
                    orderReference: 'AUR-2025-002',
                    date: new Date('2025-01-11'),
                    amount: 15000,
                    customerName: 'Arjun Reddy',
                    customerEmail: 'arjun.reddy@example.com',
                    customerPhone: '+91 8765432109',
                    customerAddress: '456 Park Street, Mumbai 400001',
                    paymentMethod: 'COD',
                    products: [
                        { name: 'Silver Earrings', price: 15000, quantity: 1 }
                    ],
                    notes: '',
                    status: 'confirmed',
                    adminConfirmed: true
                },
                {
                    orderId: 'ORDER_003',
                    userId: 'demo_user_3',
                    orderReference: 'AUR-2025-003',
                    date: new Date('2025-01-12'),
                    amount: 35000,
                    customerName: 'Sneha Patel',
                    customerEmail: 'sneha.patel@example.com',
                    customerPhone: '+91 7654321098',
                    customerAddress: '789 Anna Salai, Chennai 600002',
                    paymentMethod: 'Razorpay',
                    products: [
                        { name: 'Gold Bracelet', price: 35000, quantity: 1 }
                    ],
                    notes: 'Urgent delivery required',
                    status: 'cancelled'
                }
            ];

            // Demo customers data
            const demoCustomersData = [
                {
                    id: 'demo_user_1',
                    firstName: 'Priya',
                    lastName: 'Sharma',
                    email: 'priya.sharma@example.com',
                    phone: '+91 9876543210',
                    totalOrders: 3,
                    totalSpent: 75000,
                    lastOrderDate: new Date('2025-01-10')
                },
                {
                    id: 'demo_user_2',
                    firstName: 'Arjun',
                    lastName: 'Reddy',
                    email: 'arjun.reddy@example.com',
                    phone: '+91 8765432109',
                    totalOrders: 1,
                    totalSpent: 15000,
                    lastOrderDate: new Date('2025-01-11')
                },
                {
                    id: 'demo_user_3',
                    firstName: 'Sneha',
                    lastName: 'Patel',
                    email: 'sneha.patel@example.com',
                    phone: '+91 7654321098',
                    totalOrders: 2,
                    totalSpent: 45000,
                    lastOrderDate: new Date('2025-01-12')
                }
            ];

            // Set demo data to global variables
            allOrders = demoOrdersData;
            newOrders = demoOrdersData.filter(order => order.status === 'new');
            confirmedOrders = demoOrdersData.filter(order => order.status === 'confirmed');
            cancelledOrders = demoOrdersData.filter(order => order.status === 'cancelled');
            allCustomers = demoCustomersData;

            console.log(`✅ Created demo data: ${allOrders.length} orders, ${allCustomers.length} customers`);
        }

        // Load orders from Firebase - EXACT copy from working admin-dashboard.html
        async function loadOrders() {
            try {
                console.log('Loading orders from Firestore...');

                // Show loading for dashboard orders
                const ordersLoading = document.getElementById('orders-loading');
                const ordersTable = document.getElementById('orders-table');
                if (ordersLoading) ordersLoading.style.display = 'flex';
                if (ordersTable) ordersTable.style.display = 'none';

                // Show loading for new orders section
                const newOrdersLoading = document.getElementById('new-orders-loading');
                if (newOrdersLoading) newOrdersLoading.style.display = 'flex';

                // Show loading for orders section page
                if (document.getElementById('orders-section-loading')) {
                    document.getElementById('orders-section-loading').style.display = 'flex';
                }
                if (document.getElementById('orders-section-table')) {
                    document.getElementById('orders-section-table').style.display = 'none';
                }

                const usersSnapshot = await db.collection('users').get();
                console.log(`Found ${usersSnapshot.size} users in Firestore`);

                allOrders = [];
                newOrders = [];
                confirmedOrders = [];
                cancelledOrders = [];

                if (usersSnapshot.size === 0) {
                    console.log('⚠️ No users found in Firestore - this means no customers have registered yet');
                }

                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    console.log(`🔍 Checking orders for user: ${userId}`);
                    const ordersSnapshot = await userDoc.ref.collection('orders').get();

                    console.log(`📝 Found ${ordersSnapshot.size} orders for user ${userId}`);

                    ordersSnapshot.forEach(orderDoc => {
                        const orderData = orderDoc.data();

                        // Process order data with comprehensive fallbacks
                        const processedOrder = {
                            orderId: orderDoc.id,
                            userId: userId,
                            orderReference: orderData.orderReference || orderData.id || orderDoc.id,
                            date: orderData.timestamp?.toDate() ||
                                  (orderData.createdAt ? new Date(orderData.createdAt) : new Date()),
                            amount: calculateOrderAmount(orderData),
                            customerName: extractCustomerName(orderData),
                            customerEmail: extractCustomerEmail(orderData),
                            customerPhone: extractCustomerPhone(orderData),
                            customerAddress: extractCustomerAddress(orderData),
                            paymentMethod: orderData.paymentMethod || 'Not specified',
                            products: orderData.products || orderData.items || [],
                            notes: orderData.notes || orderData.specialInstructions || ''
                        };

                        allOrders.push(processedOrder);

                        // Categorize orders by status with proper error handling
                        try {
                            if (orderData.status === 'confirmed' || processedOrder.adminConfirmed) {
                                processedOrder.status = 'confirmed';
                                confirmedOrders.push(processedOrder);
                            } else if (orderData.status === 'cancelled') {
                                processedOrder.status = 'cancelled';
                                cancelledOrders.push(processedOrder);
                            } else {
                                processedOrder.status = 'pending';
                                newOrders.push(processedOrder);
                            }
                        } catch (statusError) {
                            console.warn('Error categorizing order:', statusError);
                            // Default to pending order if there's an issue
                            processedOrder.status = 'pending';
                            newOrders.push(processedOrder);
                        }
                    });
                }

                console.log(`✅ Loaded ${allOrders.length} total orders from Firebase`);
                console.log(`✅ New orders: ${newOrders.length}, Confirmed orders: ${confirmedOrders.length}, Cancelled orders: ${cancelledOrders.length}`);

                updateOrdersDisplay();
                updateOrdersStats();
                updateNewOrdersDisplay();
                updateRecentOrdersDisplay();

                // Update notifications when orders change
                await loadNotifications();

                // Ensure notification badge is updated
                updateNotificationBadges();

            } catch (error) {
                console.error('❌ Error loading orders:', error.message, error);

                // Initialize empty arrays to prevent undefined errors
                allOrders = [];
                newOrders = [];
                confirmedOrders = [];
                cancelledOrders = [];

                // Update displays with empty state
                updateOrdersDisplay();
                updateOrdersStats();
                updateNewOrdersDisplay();
                updateRecentOrdersDisplay();

                // Show error in console but don't break the UI
                if (typeof showError === 'function') {
                    showError('orders-error', `Error loading orders: ${error.message}`);
                }
            }
        }

        // Helper functions for order processing - EXACT copy from working admin-dashboard.html
        function calculateOrderAmount(orderData) {
            if (orderData.totalAmount) return parseFloat(orderData.totalAmount);
            if (orderData.total) return parseFloat(orderData.total);
            if (orderData.orderTotal) return parseFloat(orderData.orderTotal);

            if (orderData.products && orderData.products.length > 0) {
                return orderData.products.reduce((total, item) => {
                    const price = parseFloat(item.price || 0);
                    const quantity = parseInt(item.quantity || 1);
                    return total + (price * quantity);
                }, 0);
            }

            return 0;
        }

        function extractCustomerName(orderData) {
            if (orderData.customer?.name) return orderData.customer.name;
            if (orderData.customer?.firstName && orderData.customer?.lastName) {
                return `${orderData.customer.firstName} ${orderData.customer.lastName}`;
            }
            if (orderData.firstName && orderData.lastName) {
                return `${orderData.firstName} ${orderData.lastName}`;
            }
            if (orderData.customer?.firstName) return orderData.customer.firstName;
            if (orderData.firstName) return orderData.firstName;
            if (orderData.customer?.email) return orderData.customer.email.split('@')[0];
            if (orderData.email) return orderData.email.split('@')[0];
            return 'Unknown Customer';
        }

        function extractCustomerEmail(orderData) {
            return orderData.customer?.email || orderData.email || 'No email provided';
        }

        function extractCustomerPhone(orderData) {
            return orderData.customer?.phone || orderData.phone || orderData.customer?.phoneNumber || 'Not provided';
        }

        function extractCustomerAddress(orderData) {
            if (orderData.customer?.address) {
                const addr = orderData.customer;
                return `${addr.address || ''}, ${addr.city || ''}, ${addr.state || ''} - ${addr.postalCode || ''}`.replace(/,\s*,/g, ',').trim();
            }
            if (orderData.address) {
                return `${orderData.address}, ${orderData.city || ''}, ${orderData.state || ''} - ${orderData.postalCode || ''}`.replace(/,\s*,/g, ',').trim();
            }
            return 'Address not provided';
        }

        // Update orders display - Show only confirmed and cancelled orders in Recent Orders
        function updateOrdersDisplay() {
            try {
                const ordersLoading = document.getElementById('recent-orders-loading');
                const ordersTable = document.getElementById('orders-table');
                const ordersTbody = document.getElementById('orders-tbody');

                if (ordersLoading) ordersLoading.style.display = 'none';

                // Combine confirmed and cancelled orders for Recent Orders section
                const recentOrdersList = [...confirmedOrders, ...cancelledOrders];

                if (recentOrdersList.length === 0) {
                    if (ordersTable) ordersTable.style.display = 'block';
                    if (ordersTbody) {
                        ordersTbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #64748b;">
                                    <h3>No processed orders found</h3>
                                    <p>Confirmed and cancelled orders will appear here.</p>
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }

                // Sort orders by date (newest first) and show recent 10
                const recentOrders = recentOrdersList.sort((a, b) => b.date - a.date).slice(0, 10);

                if (ordersTbody) {
                    ordersTbody.innerHTML = recentOrders.map(order => {
                        const formattedDate = order.date.toLocaleDateString('en-IN');
                        const formattedTime = order.date.toLocaleTimeString('en-IN');
                        const formattedAmount = `₹${order.amount.toLocaleString('en-IN')}`;
                        let statusClass, statusText;
                        if (order.status === 'confirmed') {
                            statusClass = 'status-confirmed';
                            statusText = 'CONFIRMED';
                        } else if (order.status === 'cancelled') {
                            statusClass = 'status-cancelled';
                            statusText = 'CANCELLED';
                        } else {
                            statusClass = 'status-pending';
                            statusText = 'PENDING';
                        }

                        return `
                            <tr>
                                <td><strong>${(order.orderReference || order.orderId).substring(0, 15)}...</strong></td>
                                <td>
                                    <div><strong>${order.customerName}</strong></div>
                                    <small style="color: #64748b;">${order.customerEmail}</small>
                                </td>
                                <td>
                                    <div>${formattedDate}</div>
                                    <small style="color: #64748b;">${formattedTime}</small>
                                </td>
                                <td><strong>${formattedAmount}</strong></td>
                                <td>
                                    <span class="status-badge ${statusClass}">
                                        ${statusText}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="viewOrderDetails('${order.orderId}', '${order.userId}')" style="margin-right: 8px;">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                    ${order.status === 'confirmed' ?
                                        '<span class="btn btn-sm" style="background: #d1fae5; color: #065f46; cursor: default;">Processed</span>' :
                                        '<span class="btn btn-sm" style="background: #fee2e2; color: #991b1b; cursor: default;">Cancelled</span>'
                                    }
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                if (ordersTable) ordersTable.style.display = 'block';
            } catch (error) {
                console.error('Error in updateOrdersDisplay:', error);
            }
        }

        // Period change function
        function changePeriod(period) {
            currentPeriod = period;

            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`period-${period}`).classList.add('active');

            // Update statistics
            updateOrdersStats();
            updateCustomersStats();
        }

        // Get date range for current period
        function getCurrentPeriodRange() {
            const now = new Date();
            let startDate = new Date();
            let periodLabel = '';

            switch (currentPeriod) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    periodLabel = 'today';
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    startDate.setDate(now.getDate() - daysToMonday);
                    startDate.setHours(0, 0, 0, 0);
                    periodLabel = 'this week';
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    periodLabel = 'this month';
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    periodLabel = 'this year';
                    break;
                case 'overall':
                    startDate = new Date(0); // Beginning of time
                    periodLabel = 'overall';
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    periodLabel = 'this month';
            }

            return { startDate, periodLabel };
        }

        // Update orders statistics with period filtering
        function updateOrdersStats() {
            try {
                const totalOrdersElement = document.getElementById('total-orders');
                const totalRevenueElement = document.getElementById('total-revenue');
                const ordersChangeElement = document.getElementById('orders-change');
                const revenueChangeElement = document.getElementById('revenue-change');

                const { startDate, periodLabel } = getCurrentPeriodRange();

                // Filter confirmed orders by current period
                const periodOrders = confirmedOrders.filter(order => order.date >= startDate);
                const periodRevenue = periodOrders.reduce((sum, order) => sum + order.amount, 0);

                // Update display
                if (totalOrdersElement) {
                    totalOrdersElement.textContent = periodOrders.length.toLocaleString('en-IN');
                }
                if (totalRevenueElement) {
                    totalRevenueElement.textContent = `₹${periodRevenue.toLocaleString('en-IN')}`;
                }

                if (ordersChangeElement) {
                    ordersChangeElement.textContent = `${periodOrders.length} confirmed ${periodLabel}`;
                }
                if (revenueChangeElement) {
                    revenueChangeElement.textContent = `₹${periodRevenue.toLocaleString('en-IN')} ${periodLabel}`;
                }
            } catch (error) {
                console.error('Error in updateOrdersStats:', error);
            }
        }

        // Update customers statistics with period filtering
        function updateCustomersStats() {
            try {
                const totalCustomersElement = document.getElementById('total-customers');
                const customersChangeElement = document.getElementById('customers-change');

                const { startDate, periodLabel } = getCurrentPeriodRange();

                // Filter customers who placed orders in current period
                const periodCustomers = allCustomers.filter(customer => {
                    const customerOrders = confirmedOrders.filter(order =>
                        order.userId === customer.uid && order.date >= startDate
                    );
                    return customerOrders.length > 0;
                });

                // Update display - show total customers, not period customers
                if (totalCustomersElement) {
                    totalCustomersElement.textContent = allCustomers.length.toLocaleString('en-IN');
                }
                if (customersChangeElement) {
                    if (periodLabel === 'overall') {
                        customersChangeElement.textContent = `${allCustomers.filter(c => c.orders > 0).length} customers with orders`;
                    } else {
                        customersChangeElement.textContent = `${periodCustomers.length} active customers ${periodLabel}`;
                    }
                }
            } catch (error) {
                console.error('Error in updateCustomersStats:', error);
            }
        }

        // Load customers with UID and search functionality
        async function loadCustomers() {
            try {
                console.log('Loading customers from Firestore...');

                const customersLoading = document.getElementById('customers-loading');
                const customersTable = document.getElementById('customers-table');
                if (customersLoading) customersLoading.style.display = 'flex';
                if (customersTable) customersTable.style.display = 'none';

                const usersSnapshot = await db.collection('users').get();
                allCustomers = [];

                console.log(`Found ${usersSnapshot.size} registered customers in Firestore`);

                for (const userDoc of usersSnapshot.docs) {
                    const userData = userDoc.data();
                    const userId = userDoc.id; // Get the UID

                    // Get user's confirmed orders only
                    const userOrders = confirmedOrders.filter(order => order.userId === userId);
                    const totalSpent = userOrders.reduce((sum, order) => sum + order.amount, 0);
                    const lastOrder = userOrders.length > 0 ?
                        Math.max(...userOrders.map(order => order.date.getTime())) : null; // Use getTime() for comparison

                    allCustomers.push({
                        uid: userId, // Add UID to customer data
                        name: userData.displayName || userData.email?.split('@')[0] || 'Unknown User',
                        email: userData.email || 'No email provided',
                        phone: userData.phoneNumber || 'Not provided',
                        orders: userOrders.length,
                        totalSpent: Math.round(totalSpent),
                        lastOrder: lastOrder ? new Date(lastOrder).toLocaleDateString('en-IN') : 'Never'
                    });
                }

                console.log(`✅ Loaded ${allCustomers.length} customers`);
                updateCustomersDisplay();
                updateCustomersStats();

            } catch (error) {
                console.error('❌ Error loading customers:', error);
                showError('customers-error', `Error loading customers: ${error.message}`);
            }
        }

        // Update customers display with UID and search support
        function updateCustomersDisplay(customersToShow = null) {
            const customersLoading = document.getElementById('customers-loading');
            const customersTable = document.getElementById('customers-table');
            const customersTbody = document.getElementById('customers-tbody');
            const totalCustomersElement = document.getElementById('total-customers');
            const customersChangeElement = document.getElementById('customers-change');

            if (customersLoading) customersLoading.style.display = 'none';

            // Use filtered customers if provided, otherwise use all customers
            const displayCustomers = customersToShow || allCustomers;

            // Customer count is now handled by updateCustomersStats function

            if (displayCustomers.length === 0) {
                if (customersTable) customersTable.style.display = 'block';
                if (customersTbody) {
                    const isSearching = customersToShow !== null && customersToShow !== allCustomers;
                    customersTbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">
                                <h3>${isSearching ? 'No customers found' : 'No customers found in database'}</h3>
                                <p>${isSearching ? 'No customers match your search criteria.' : 'Customer data will appear here when users sign up.'}</p>
                                ${isSearching ? '<button class="btn btn-primary" onclick="clearCustomerSearch()">Clear Search</button>' : ''}
                            </td>
                        </tr>
                    `;
                }
                return;
            }

            // Sort customers by total spent
            const sortedCustomers = [...displayCustomers].sort((a, b) => b.totalSpent - a.totalSpent);

            if (customersTbody) {
                customersTbody.innerHTML = sortedCustomers.map(customer => {
                    // Highlight search terms if search is active
                    const customerSearchTerm = document.getElementById('customerSearchInput')?.value.toLowerCase().trim() || '';

                    let displayUID = customer.uid || 'N/A';
                    let displayName = customer.name;
                    let displayEmail = customer.email;

                    if (customerSearchTerm) {
                        const highlightText = (text, term) => {
                            if (!text) return text;
                            const regex = new RegExp(`(${term})`, 'gi');
                            return text.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px;">$1</mark>');
                        };

                        displayUID = highlightText(customer.uid, customerSearchTerm);
                        displayName = highlightText(customer.name, customerSearchTerm);
                        displayEmail = highlightText(customer.email, customerSearchTerm);
                    }

                    return `
                        <tr>
                            <td><small style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">${displayUID}</small></td>
                            <td><strong>${displayName}</strong></td>
                            <td>${displayEmail}</td>
                            <td>${customer.phone}</td>
                            <td><span style="background: #e0f2fe; color: #0277bd; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">${customer.orders}</span></td>
                            <td><strong>₹${customer.totalSpent.toLocaleString('en-IN')}</strong></td>
                            <td>${customer.lastOrder}</td>
                        </tr>
                    `;
                }).join('');
            }

            if (customersTable) customersTable.style.display = 'block';
        }

        // Load inventory data - EXACT copy from working admin-dashboard.html
        async function loadInventoryData() {
            try {
                console.log('Loading inventory data...');

                let totalProducts = 0;
                let totalValue = 0;
                let categoryDetails = [];

                // Load products from each category using the working Netlify functions
                const categories = ['featured-collection', 'new-arrivals', 'saree-collection'];

                for (const category of categories) {
                    try {
                        // Use the same endpoint structure that's working in the server logs
                        const response = await fetch(`/.netlify/functions/load-products?category=${category}&cacheBust=${Date.now()}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.products && Array.isArray(data.products)) {
                                const categoryCount = data.products.length;
                                const categoryValue = data.products.reduce((sum, product) => {
                                    return sum + (parseFloat(product.price) || 0);
                                }, 0);

                                totalProducts += categoryCount;
                                totalValue += categoryValue;
                                categoryDetails.push(`${category}: ${categoryCount} products (₹${categoryValue.toLocaleString('en-IN')})`);
                                console.log(`✅ ${category}: ${categoryCount} products, value: ₹${categoryValue.toLocaleString('en-IN')}`);
                            } else {
                                console.warn(`❌ ${category}: No products found or invalid response`);
                                categoryDetails.push(`${category}: 0 products`);
                            }
                        } else {
                            console.warn(`Server returned ${response.status} for ${category}`);
                            categoryDetails.push(`${category}: Error - ${response.statusText}`);
                        }
                    } catch (error) {
                        console.warn(`Could not load ${category} products:`, error);
                        categoryDetails.push(`${category}: Error - ${error.message}`);
                    }
                }

                console.log(`✅ Loaded ${totalProducts} products, inventory value: ₹${totalValue.toLocaleString('en-IN')}`);
                console.log('Category breakdown:', categoryDetails);

                // Update UI with loaded data
                const inventoryValueElement = document.getElementById('inventory-value');
                const inventoryChangeElement = document.getElementById('inventory-change');

                if (inventoryValueElement) {
                    inventoryValueElement.textContent = `₹${Math.round(totalValue).toLocaleString('en-IN')}`;
                    console.log(`Updated inventory value display: ${inventoryValueElement.textContent}`);
                } else {
                    console.error('❌ inventory-value element not found');
                }

                if (inventoryChangeElement) {
                    inventoryChangeElement.textContent = `${totalProducts} products in inventory`;
                    console.log(`Updated inventory change display: ${inventoryChangeElement.textContent}`);
                } else {
                    console.error('❌ inventory-change element not found');
                }

            } catch (error) {
                console.error('❌ Error loading inventory:', error);

                const inventoryValueElement = document.getElementById('inventory-value');
                const inventoryChangeElement = document.getElementById('inventory-change');

                if (inventoryValueElement) {
                    inventoryValueElement.textContent = '₹0';
                }
                if (inventoryChangeElement) {
                    inventoryChangeElement.textContent = 'Error loading inventory';
                }
            }
        }

        // Debug function to test data loading
        async function testDataLoading() {
            console.log('🐛 DEBUG: Testing all data loading...');

            // Test Firestore connectivity
            try {
                console.log('🐛 Testing Firestore connection...');
                const testSnapshot = await db.collection('users').limit(1).get();
                console.log(`🐛 Firestore connected. Found ${testSnapshot.size} users.`);

                // Test orders collection
                const ordersTest = await db.collection('users').get();
                let totalOrders = 0;
                for (const userDoc of ordersTest.docs) {
                    const ordersSnapshot = await userDoc.ref.collection('orders').get();
                    totalOrders += ordersSnapshot.size;
                }
                console.log(`🐛 Found ${totalOrders} total orders across all users.`);

                if (totalOrders === 0) {
                    console.log('ℹ️ No real orders found - this is why demo data is being used');
                } else {
                    console.log('✅ Real order data exists');
                }

            } catch (error) {
                console.error('🐛 Firestore connection error:', error);
            }
        }

        // Debug function to test inventory loading
        async function testInventoryLoading() {
            console.log('🐛 DEBUG: Starting inventory loading test...');

            // Check if elements exist
            const inventoryValueElement = document.getElementById('inventory-value');
            const inventoryChangeElement = document.getElementById('inventory-change');

            console.log('🐛 DEBUG: inventory-value element:', inventoryValueElement);
            console.log('🐛 DEBUG: inventory-change element:', inventoryChangeElement);

            // Test one category directly
            try {
                console.log('🐛 DEBUG: Testing featured-collection API call...');
                const testUrl = `/.netlify/functions/load-products?category=featured-collection&cacheBust=${Date.now()}`;
                console.log('🐛 DEBUG: URL:', testUrl);

                const response = await fetch(testUrl);
                console.log('🐛 DEBUG: Response status:', response.status);
                console.log('🐛 DEBUG: Response headers:', [...response.headers.entries()]);

                const data = await response.json();
                console.log('🐛 DEBUG: Response data:', data);

                if (data.success && data.products) {
                    console.log('🐛 DEBUG: Found products:', data.products.length);
                    const totalValue = data.products.reduce((sum, product) => sum + (parseFloat(product.price) || 0), 0);
                    console.log('🐛 DEBUG: Total value:', totalValue);

                    // Test UI update
                    if (inventoryValueElement) {
                        inventoryValueElement.textContent = `₹${totalValue.toLocaleString('en-IN')}`;
                        inventoryValueElement.style.backgroundColor = '#90EE90'; // Light green to show it changed
                        console.log('🐛 DEBUG: Updated inventory value element');
                    }

                    if (inventoryChangeElement) {
                        inventoryChangeElement.textContent = `${data.products.length} products (DEBUG TEST)`;
                        inventoryChangeElement.style.backgroundColor = '#90EE90'; // Light green to show it changed
                        console.log('🐛 DEBUG: Updated inventory change element');
                    }
                } else {
                    console.log('🐛 DEBUG: No products or failed response');
                }

            } catch (error) {
                console.error('🐛 DEBUG: Error in test:', error);
            }

            console.log('🐛 DEBUG: Test completed. Check elements for green background.');
        }

        // Action loader functions for immediate feedback
        function showActionLoader(message = 'Processing...') {
            // Remove existing loader if any
            hideActionLoader();

            const loader = document.createElement('div');
            loader.id = 'actionLoader';
            loader.className = 'custom-confirm-modal';
            loader.innerHTML = `
                <div class="custom-confirm-content">
                    <div class="custom-confirm-header">
                        <div class="custom-confirm-icon confirm-action" style="background: linear-gradient(135deg, #64748b, #475569);">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <h3 class="custom-confirm-title">Loading...</h3>
                    </div>

                    <div class="custom-confirm-body">
                        <p class="custom-confirm-message">${message}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(loader);
        }

        function hideActionLoader() {
            const existingLoader = document.getElementById('actionLoader');
            if (existingLoader) {
                existingLoader.remove();
            }
        }

        // Success modal function using global loader system
        function showSuccessModal(options) {
            // The global loader is already showing, so we just need to show success after delay
            setTimeout(() => {
                // Hide the global loader
                hideGlobalLoader();

                // Show success modal
                const modal = document.createElement('div');
                modal.className = 'custom-confirm-modal';
                modal.style.zIndex = '10000';

                modal.innerHTML = `
                    <div class="custom-confirm-content">
                        <div class="custom-confirm-header">
                            <div class="custom-confirm-icon confirm-action">
                                ${options.icon}
                            </div>
                            <h3 class="custom-confirm-title">${options.title}</h3>
                        </div>

                        <div class="custom-confirm-body">
                            <p class="custom-confirm-message">${options.message}</p>
                        </div>

                        <div class="custom-confirm-actions">
                            <button class="custom-confirm-btn primary" onclick="this.closest('.custom-confirm-modal').remove();">
                                <i class="fas fa-check"></i>
                                OK
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }, 1500); // Show success after 1.5 seconds
        }

        // Cancellation reason modal function
        function showCancellationReasonModal(order) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'custom-confirm-modal';

                modal.innerHTML = `
                    <div class="custom-confirm-content">
                        <div class="custom-confirm-header">
                            <div class="custom-confirm-icon cancel-action">
                                ⚠
                            </div>
                            <h3 class="custom-confirm-title">Cancel Order</h3>
                            <p class="custom-confirm-subtitle">Please select a reason for cancellation</p>
                        </div>

                        <div class="custom-confirm-body">
                            ${order ? `
                                <div class="custom-confirm-order-info">
                                    <h4>Order Details</h4>
                                    <p><strong>Order:</strong> ${order.orderReference || order.orderId}</p>
                                    <p><strong>Customer:</strong> ${order.customerName}</p>
                                    <p><strong>Amount:</strong> ₹${order.amount?.toLocaleString('en-IN') || '0'}</p>
                                </div>
                            ` : ''}

                            <div style="margin: 20px 0;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151;">
                                    Cancellation Reason:
                                </label>
                                <select id="cancellationReason" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;">
                                    <option value="">Select a reason...</option>
                                    <option value="Out of stock">Out of stock</option>
                                    <option value="Customer requested cancellation">Customer requested cancellation</option>
                                    <option value="Payment issues">Payment issues</option>
                                    <option value="Unable to deliver to location">Unable to deliver to location</option>
                                    <option value="Product quality issues">Product quality issues</option>
                                    <option value="Inventory management">Inventory management</option>
                                    <option value="Pricing error">Pricing error</option>
                                    <option value="Suspicious order">Suspicious order</option>
                                    <option value="Operational issues">Operational issues</option>
                                    <option value="Other">Other (specify below)</option>
                                </select>
                            </div>

                            <div style="margin: 20px 0;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151;">
                                    Additional Note (Optional):
                                </label>
                                <textarea id="cancellationNote" placeholder="Add any additional details for the customer..."
                                         style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical; min-height: 80px; font-family: inherit;"></textarea>
                            </div>
                        </div>

                        <div class="custom-confirm-actions">
                            <button class="custom-confirm-btn secondary" onclick="window.cancelReasonResolve(null);">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button class="custom-confirm-btn danger" onclick="confirmCancellation();">
                                <i class="fas fa-ban"></i>
                                Cancel Order
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Set up resolve function
                window.cancelReasonResolve = (result) => {
                    modal.remove();
                    delete window.cancelReasonResolve;
                    delete window.confirmCancellation;
                    resolve(result);
                };

                // Confirm cancellation function
                window.confirmCancellation = () => {
                    const reasonSelect = document.getElementById('cancellationReason');
                    const noteTextarea = document.getElementById('cancellationNote');

                    const selectedReason = reasonSelect.value.trim();
                    const additionalNote = noteTextarea.value.trim();

                    if (!selectedReason) {
                        // Highlight the select field
                        reasonSelect.style.borderColor = '#ef4444';
                        reasonSelect.focus();

                        // Show validation message
                        let errorMsg = document.getElementById('reasonError');
                        if (!errorMsg) {
                            errorMsg = document.createElement('div');
                            errorMsg.id = 'reasonError';
                            errorMsg.style.cssText = 'color: #ef4444; font-size: 12px; margin-top: 5px;';
                            errorMsg.textContent = 'Please select a cancellation reason';
                            reasonSelect.parentNode.appendChild(errorMsg);
                        }
                        return;
                    }

                    // If "Other" is selected, require additional note
                    if (selectedReason === 'Other' && !additionalNote) {
                        noteTextarea.style.borderColor = '#ef4444';
                        noteTextarea.focus();
                        noteTextarea.placeholder = 'Please specify the reason for cancellation...';
                        return;
                    }

                    // Prepare the cancellation data
                    let finalReason = selectedReason;
                    if (selectedReason === 'Other' && additionalNote) {
                        finalReason = additionalNote;
                    }

                    const cancellationData = {
                        reason: finalReason,
                        note: selectedReason !== 'Other' ? additionalNote : '',
                        originalSelection: selectedReason
                    };

                    window.cancelReasonResolve(cancellationData);
                };

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        window.cancelReasonResolve(null);
                    }
                });

                // Reset border color when user selects a reason
                setTimeout(() => {
                    const reasonSelect = document.getElementById('cancellationReason');
                    if (reasonSelect) {
                        reasonSelect.addEventListener('change', () => {
                            reasonSelect.style.borderColor = '#d1d5db';
                            const errorMsg = document.getElementById('reasonError');
                            if (errorMsg) {
                                errorMsg.remove();
                            }
                        });
                    }
                }, 100);
            });
        }

        // Admin verification system constants
        const ADMIN_CODE = '5634';
        const SESSION_KEY = 'adminVerified';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours

        // Check if already verified in localStorage
        function checkAdminSession() {
            const session = localStorage.getItem(SESSION_KEY);
            if (session) {
                const sessionData = JSON.parse(session);
                const now = Date.now();
                if (now - sessionData.timestamp < SESSION_DURATION) {
                    // Session is valid, hide modal
                    const modal = document.getElementById('verificationModal');
                    if (modal) modal.style.display = 'none';
                    return true;
                } else {
                    // Session expired
                    localStorage.removeItem(SESSION_KEY);
                }
            }
            return false;
        }

        // Show success message
        function showSuccessMessage() {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 25000;
                background: #059669; color: white; padding: 15px 20px;
                border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                font-weight: 600; display: flex; align-items: center; gap: 8px;
            `;
            successDiv.innerHTML = '<i class="fas fa-check-circle"></i> Admin access granted!';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Global loader management
        let globalLoader = null;

        function showGlobalLoader(message = 'Processing...') {
            // Remove any existing loaders
            hideGlobalLoader();

            globalLoader = document.createElement('div');
            globalLoader.className = 'custom-confirm-modal';
            globalLoader.style.zIndex = '20000'; // Higher than other modals
            globalLoader.innerHTML = `
                <div class="custom-confirm-content">
                    <div class="custom-confirm-header">
                        <div class="custom-confirm-icon confirm-action" style="background: linear-gradient(135deg, #64748b, #475569);">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <h3 class="custom-confirm-title">Processing...</h3>
                    </div>

                    <div class="custom-confirm-body">
                        <p class="custom-confirm-message">${message}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(globalLoader);
            globalLoader.offsetHeight; // Force reflow for immediate display
        }

        function hideGlobalLoader() {
            if (globalLoader) {
                globalLoader.remove();
                globalLoader = null;
            }
        }

        // Custom confirmation modal functions
        function showCustomConfirm(options) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'custom-confirm-modal';
                modal.style.zIndex = '10000';

                const iconClass = options.type === 'confirm' ? 'confirm-action' : 'cancel-action';
                const iconSymbol = options.type === 'confirm' ? '✓' : '⚠';

                modal.innerHTML = `
                    <div class="custom-confirm-content">
                        <div class="custom-confirm-header">
                            <div class="custom-confirm-icon ${iconClass}">
                                ${iconSymbol}
                            </div>
                            <h3 class="custom-confirm-title">${options.title}</h3>
                            <p class="custom-confirm-subtitle">${options.subtitle}</p>
                        </div>

                        <div class="custom-confirm-body">
                            <p class="custom-confirm-message">${options.message}</p>

                            ${options.orderInfo ? `
                                <div class="custom-confirm-order-info">
                                    <h4>
                                        <i class="fas fa-box" style="color: #059669;"></i>
                                        Order Details
                                    </h4>
                                    <p><strong>Order:</strong> ${options.orderInfo.reference}</p>
                                    <p><strong>Customer:</strong> ${options.orderInfo.customer}</p>
                                    <p><strong>Amount:</strong> ${options.orderInfo.amount}</p>
                                </div>
                            ` : ''}
                        </div>

                        <div class="custom-confirm-actions">
                            <button class="custom-confirm-btn secondary" onclick="window.confirmResolve(false);">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button class="custom-confirm-btn ${options.type === 'confirm' ? 'success' : 'danger'}" onclick="window.handleConfirmClick(true);">
                                <i class="fas fa-${options.type === 'confirm' ? 'check' : 'trash'}"></i>
                                ${options.confirmText}
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                window.confirmResolve = (result) => {
                    modal.remove();
                    delete window.confirmResolve;
                    delete window.handleConfirmClick;
                    resolve(result);
                };

                // Handle confirm button click with immediate global loader
                window.handleConfirmClick = (result) => {
                    if (result) {
                        // Show global loader immediately
                        showGlobalLoader('Please wait while we process your request...');

                        // Remove the confirmation modal immediately
                        modal.remove();

                        // Resolve immediately so the actual action can start
                        window.confirmResolve(true);
                    } else {
                        window.confirmResolve(false);
                    }
                };

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        delete window.confirmResolve;
                        delete window.handleConfirmClick;
                        resolve(false);
                    }
                });
            });
        }

        // Order action functions - Enhanced with custom modals
        async function confirmOrder(orderId, userId) {
            // Find order details for the modal
            const order = allOrders.find(o => o.orderId === orderId && o.userId === userId);

            const confirmed = await showCustomConfirm({
                type: 'confirm',
                title: 'Confirm Order',
                subtitle: 'This action will mark the order as confirmed',
                message: 'Are you sure you want to confirm this order?',
                confirmText: 'Confirm Order',
                orderInfo: order ? {
                    reference: order.orderReference || orderId,
                    customer: order.customerName || 'Unknown',
                    amount: `₹${order.amount?.toLocaleString('en-IN') || '0'}`
                } : null
            });

            if (!confirmed) {
                hideGlobalLoader(); // Hide loader if user cancels
                return;
            }

            try {
                console.log(`Confirming order ${orderId} for user ${userId}...`);

                // Update order in Firebase using user subcollection structure
                await db.collection('users')
                    .doc(userId)
                    .collection('orders')
                    .doc(orderId)
                    .update({
                        adminConfirmed: true,
                        confirmedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'confirmed'
                    });

                // Get order data for email
                const orderDoc = await db.collection('users')
                    .doc(userId)
                    .collection('orders')
                    .doc(orderId)
                    .get();

                const orderData = orderDoc.data();

                // Show success modal instead of alert
                showSuccessModal({
                    title: 'Order Confirmed!',
                    message: 'The order has been successfully confirmed.',
                    icon: '✅'
                });

                // Create a new notification for the confirmed order status
                const orderDetailsForNotification = {
                    userId: userId,
                    orderReference: orderData.orderReference || orderData.id,
                    customerName: extractCustomerName(orderData),
                    customerEmail: extractCustomerEmail(orderData),
                    customerPhone: extractCustomerPhone(orderData),
                    customerAddress: extractCustomerAddress(orderData),
                    amount: calculateOrderAmount(orderData),
                    paymentMethod: orderData.paymentMethod,
                    orderDate: (orderData.timestamp?.toDate() || new Date()).toISOString(),
                    products: orderData.products || orderData.items || [],
                    notes: orderData.notes || orderData.specialInstructions || ''
                };
                await addOrderStatusNotification(orderId, 'confirmed', orderDetailsForNotification);

                // Refresh orders
                await loadOrders();

            } catch (error) {
                console.error('❌ Error confirming order:', error);
                hideGlobalLoader(); // Hide loader on error
                alert(`Error confirming order: ${error.message}`);
            }
        }

        async function cancelOrder(orderId, userId) {
            // Find order details for the modal
            const order = allOrders.find(o => o.orderId === orderId && o.userId === userId);

            // First show cancellation reason modal
            const cancellationData = await showCancellationReasonModal(order);

            if (!cancellationData) {
                return; // User cancelled the action
            }

            // Show global loader immediately after reason is provided
            showGlobalLoader('Cancelling order and sending notification...');

            try {
                console.log(`Cancelling order ${orderId} for user ${userId}...`);

                // Get the order data first to use in the notification
                const orderDoc = await db.collection('users').doc(userId).collection('orders').doc(orderId).get();
                const orderData = orderDoc.data();

                if (!orderDoc.exists) {
                    throw new Error("Order not found for cancellation.");
                }

                await db.collection('users')
                    .doc(userId)
                    .collection('orders')
                    .doc(orderId)
                    .update({
                        status: 'cancelled',
                        cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
                        cancelledBy: 'admin'
                    });

                // Send cancellation email
                try {
                    // Prepare complete email data structure for cancellation
                    const emailData = {
                        orderReference: orderData.orderReference || orderData.id,
                        orderDate: orderData.orderDate || orderData.timestamp?.toDate?.() || new Date(),
                        orderTotal: orderData.total || orderData.orderTotal || 0,
                        paymentMethod: orderData.paymentMethod || 'Not specified',
                        status: 'cancelled', // Important: Include the status for email template selection
                        cancellationReason: cancellationData.reason, // Use the selected reason
                        cancellationNote: cancellationData.note, // Additional note if provided
                        customer: {
                            firstName: orderData.customer?.firstName || orderData.firstName || '',
                            lastName: orderData.customer?.lastName || orderData.lastName || '',
                            email: orderData.customer?.email || orderData.email || '',
                            phone: orderData.customer?.phone || orderData.phone || '',
                            address: orderData.customer?.address || orderData.address || '',
                            city: orderData.customer?.city || orderData.city || '',
                            state: orderData.customer?.state || orderData.state || '',
                            postalCode: orderData.customer?.postalCode || orderData.postalCode || ''
                        },
                        products: orderData.products || orderData.items || [],
                        notes: orderData.notes || orderData.specialInstructions || ''
                    };

                    console.log('Sending cancellation email with data:', emailData);

                    const emailResponse = await fetch('/.netlify/functions/send-order-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(emailData)
                    });

                    const emailResult = await emailResponse.json();

                    if (emailResult.success) {
                        console.log('✅ Cancellation email sent successfully');
                    } else {
                        console.warn('⚠️ Order cancelled but email failed:', emailResult.error || emailResult.message);
                        console.error('Email error details:', emailResult);
                    }
                } catch (emailError) {
                    console.warn('⚠️ Order cancelled but email service unavailable:', emailError);
                    console.error('Email error details:', emailError);
                }

                // Show success modal instead of alert
                showSuccessModal({
                    title: 'Order Cancelled',
                    message: `The order has been successfully cancelled with reason: "${cancellationData.reason}". Customer will receive cancellation email and any applicable refunds will be processed.`,
                    icon: '🚫'
                });

                // Create a new notification for the cancelled order status
                const orderDetailsForNotification = {
                    userId: userId,
                    orderReference: orderData.orderReference || orderData.id,
                    customerName: extractCustomerName(orderData),
                    customerEmail: extractCustomerEmail(orderData),
                    customerPhone: extractCustomerPhone(orderData),
                    customerAddress: extractCustomerAddress(orderData),
                    amount: calculateOrderAmount(orderData),
                    paymentMethod: orderData.paymentMethod,
                    orderDate: (orderData.timestamp?.toDate() || new Date()).toISOString(),
                    products: orderData.products || orderData.items || [],
                    notes: orderData.notes || orderData.specialInstructions || ''
                };
                await addOrderStatusNotification(orderId, 'cancelled', orderDetailsForNotification);

                // Refresh orders
                await loadOrders();

            } catch (error) {
                console.error('❌ Error cancelling order:', error);
                hideGlobalLoader(); // Hide loader on error
                alert(`Error cancelling order: ${error.message}`);
            }
        }

        // Navigation functions
        function showSection(sectionName) {
            console.log(`Switching to section: ${sectionName}`);

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Find and activate the clicked nav item
            const clickedItem = event ? event.target.closest('.nav-item') :
                document.querySelector(`.nav-item[onclick*="${sectionName}"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
                console.log(`Activated nav item for: ${sectionName}`);
            }

            // Update content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
                console.log(`Activated content section: ${sectionName}`);
            } else {
                console.error(`Section not found: ${sectionName}`);
            }

            // Load section-specific data
            if (sectionName === 'orders') {
                updateOrdersSectionDisplay();
            } else if (sectionName === 'products') {
                loadProducts();
            } else if (sectionName === 'inventory') {
                loadInventorySummary();
                showInventoryTab('out-of-stock'); // Show default tab
            } else if (sectionName === 'customers') {
                // Customers data is already loaded, just refresh display
                updateCustomersDisplay();
            } else if (sectionName === 'notifications') {
                loadNotifications(); // Load notifications when the section is shown
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');

            // For mobile, use 'show' class instead of toggling 'collapsed'
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
            } else {
                sidebar.classList.toggle('collapsed');
                mainContainer.classList.toggle('full-width');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');

            if (window.innerWidth <= 768) {
                sidebar.classList.remove('show');
            } else {
                sidebar.classList.add('collapsed');
                mainContainer.classList.add('full-width');
            }
        }

        // Search functionality for orders and customers
        let searchTerm = '';
        let filteredOrders = [];
        let customerSearchTerm = '';
        let filteredCustomers = [];
        let productSearchTerm = '';
        let filteredProducts = [];

        function searchOrders() {
            const searchInput = document.getElementById('orderSearchInput');
            searchTerm = searchInput.value.toLowerCase().trim();

            // Apply both search and filter
            applySearchAndFilter();
        }

        function clearSearch() {
            const searchInput = document.getElementById('orderSearchInput');
            searchInput.value = '';
            searchTerm = '';

            // Apply both search and filter
            applySearchAndFilter();
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                searchOrders();
            } else if (event.key === 'Escape') {
                clearSearch();
            }
        }

        // Customer search functionality
        function searchCustomers() {
            const searchInput = document.getElementById('customerSearchInput');
            customerSearchTerm = searchInput.value.toLowerCase().trim();

            if (customerSearchTerm) {
                filteredCustomers = allCustomers.filter(customer => {
                    // Search in UID
                    const uidMatch = (customer.uid || '').toLowerCase().includes(customerSearchTerm);

                    // Search in customer name
                    const nameMatch = (customer.name || '').toLowerCase().includes(customerSearchTerm);

                    // Search in customer email
                    const emailMatch = (customer.email || '').toLowerCase().includes(customerSearchTerm);

                    return uidMatch || nameMatch || emailMatch;
                });

                // Update search results count
                const searchResults = document.getElementById('customerSearchResults');
                if (searchResults) {
                    searchResults.textContent = `Found ${filteredCustomers.length} customer(s) matching "${customerSearchTerm}"`;
                }

                updateCustomersDisplay(filteredCustomers);
            } else {
                // Clear search results count
                const searchResults = document.getElementById('customerSearchResults');
                if (searchResults) {
                    searchResults.textContent = '';
                }

                updateCustomersDisplay();
            }
        }

        function clearCustomerSearch() {
            const searchInput = document.getElementById('customerSearchInput');
            searchInput.value = '';
            customerSearchTerm = '';

            // Clear search results count
            const searchResults = document.getElementById('customerSearchResults');
            if (searchResults) {
                searchResults.textContent = '';
            }

            updateCustomersDisplay();
        }

        function handleCustomerSearchKeydown(event) {
            if (event.key === 'Enter') {
                searchCustomers();
            } else if (event.key === 'Escape') {
                clearCustomerSearch();
            }
        }

        // Product search functionality
        function searchProducts() {
            const searchInput = document.getElementById('productSearchInput');
            productSearchTerm = searchInput.value.toLowerCase().trim();

            if (productSearchTerm) {
                // Get current category products first
                const categoryProducts = filterProductsByCategory(productsCache?.products || []);

                // Then filter by search term
                filteredProducts = categoryProducts.filter(product => {
                    const nameMatch = (product.name || '').toLowerCase().includes(productSearchTerm);
                    return nameMatch;
                });

                // Update search results count
                const searchResults = document.getElementById('productSearchResults');
                if (searchResults) {
                    searchResults.textContent = `Found ${filteredProducts.length} product(s) matching "${productSearchTerm}"`;
                }

                displayProducts(filteredProducts);
            } else {
                // Clear search results count
                const searchResults = document.getElementById('productSearchResults');
                if (searchResults) {
                    searchResults.textContent = '';
                }

                // Show all products for current category
                if (productsCache && productsCache.products) {
                    displayProducts(filterProductsByCategory(productsCache.products));
                }
            }
        }

        function clearProductSearch() {
            const searchInput = document.getElementById('productSearchInput');
            searchInput.value = '';
            productSearchTerm = '';

            // Clear search results count
            const searchResults = document.getElementById('productSearchResults');
            if (searchResults) {
                searchResults.textContent = '';
            }

            // Show all products for current category
            if (productsCache && productsCache.products) {
                displayProducts(filterProductsByCategory(productsCache.products));
            }
        }

        function handleProductSearchKeydown(event) {
            if (event.key === 'Enter') {
                searchProducts();
            } else if (event.key === 'Escape') {
                clearProductSearch();
            }
        }

        // Inventory Management Functions
        let inventoryCache = {
            outOfStock: [],
            lowStock: [],
            allProducts: []
        };
        
        let currentInventoryTab = 'out-of-stock';

        // Show inventory tab
        function showInventoryTab(tabName) {
            console.log(`Switching to inventory tab: ${tabName}`);
            currentInventoryTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('#inventory .section-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`#inventory .section-tab:nth-child(${tabName === 'out-of-stock' ? '1' : tabName === 'low-stock' ? '2' : '3'})`).classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.inventory-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show selected tab content
            const contentId = tabName === 'out-of-stock' ? 'out-of-stock-products' : 
                            tabName === 'low-stock' ? 'low-stock-products' : 'all-products-inventory';
            document.getElementById(contentId).style.display = 'block';
            
            // Load data for the tab if needed
            if (tabName === 'out-of-stock') {
                loadOutOfStockProducts();
            } else if (tabName === 'low-stock') {
                loadLowStockProducts();
            } else if (tabName === 'all-products') {
                loadAllProductsInventory();
            }
        }

        // Refresh inventory data
        async function refreshInventoryData() {
            console.log('Refreshing inventory data...');
            
            try {
                // Clear cache to force fresh data
                inventoryCache = {
                    outOfStock: [],
                    lowStock: [],
                    allProducts: []
                };
                
                // Load inventory summary
                await loadInventorySummary();
                
                // Reload current tab
                showInventoryTab(currentInventoryTab);
                
                console.log('Inventory data refreshed successfully');
            } catch (error) {
                console.error('Error refreshing inventory data:', error);
                alert('Error refreshing inventory data. Please try again.');
            }
        }

        // Load inventory summary stats
        async function loadInventorySummary() {
            try {
                console.log('Loading inventory summary...');
                
                if (typeof StockManager === 'undefined') {
                    console.warn('StockManager not available');
                    return;
                }
                
                // Get out-of-stock products
                const outOfStockProducts = await StockManager.getOutOfStockProducts();
                const lowStockProducts = await StockManager.getLowStockProducts();
                
                // Calculate totals
                const outOfStockCount = outOfStockProducts.length;
                const lowStockCount = lowStockProducts.length;
                
                // Load all products to get total count and in-stock count
                const allProductsData = await loadAllProductsData();
                const totalProductsCount = allProductsData.length;
                const inStockCount = totalProductsCount - outOfStockCount - lowStockCount;
                
                // Update summary cards
                document.getElementById('out-of-stock-count').textContent = outOfStockCount;
                document.getElementById('low-stock-count').textContent = lowStockCount;
                document.getElementById('in-stock-count').textContent = inStockCount;
                document.getElementById('total-products-count').textContent = totalProductsCount;
                
                // Update tab badges
                document.getElementById('out-of-stock-tab-count').textContent = outOfStockCount;
                document.getElementById('low-stock-tab-count').textContent = lowStockCount;
                
                // Update navigation badge
                const inventoryBadge = document.getElementById('inventory-alert-badge');
                if (outOfStockCount > 0) {
                    inventoryBadge.textContent = outOfStockCount;
                    inventoryBadge.style.display = 'flex';
                } else {
                    inventoryBadge.style.display = 'none';
                }
                
                // Cache the data
                inventoryCache.outOfStock = outOfStockProducts;
                inventoryCache.lowStock = lowStockProducts;
                inventoryCache.allProducts = allProductsData;
                
                console.log('Inventory summary loaded:', {
                    outOfStock: outOfStockCount,
                    lowStock: lowStockCount,
                    inStock: inStockCount,
                    total: totalProductsCount
                });
                
            } catch (error) {
                console.error('Error loading inventory summary:', error);
                // Set default values on error
                document.getElementById('out-of-stock-count').textContent = '0';
                document.getElementById('low-stock-count').textContent = '0';
                document.getElementById('in-stock-count').textContent = '0';
                document.getElementById('total-products-count').textContent = '0';
            }
        }

        // Load out-of-stock products
        async function loadOutOfStockProducts() {
            const loadingElement = document.getElementById('out-of-stock-loading');
            const listElement = document.getElementById('out-of-stock-list');
            const emptyElement = document.getElementById('out-of-stock-empty');
            const gridElement = document.getElementById('out-of-stock-grid');
            
            // Show loading
            loadingElement.style.display = 'flex';
            listElement.style.display = 'none';
            emptyElement.style.display = 'none';
            
            try {
                let outOfStockProducts = inventoryCache.outOfStock;
                
                if (outOfStockProducts.length === 0 && typeof StockManager !== 'undefined') {
                    outOfStockProducts = await StockManager.getOutOfStockProducts();
                    inventoryCache.outOfStock = outOfStockProducts;
                }
                
                loadingElement.style.display = 'none';
                
                if (outOfStockProducts.length === 0) {
                    emptyElement.style.display = 'block';
                } else {
                    // Display products
                    gridElement.innerHTML = '';
                    outOfStockProducts.forEach(product => {
                        const productCard = createInventoryProductCard(product, 'out-of-stock');
                        gridElement.appendChild(productCard);
                    });
                    listElement.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading out-of-stock products:', error);
                loadingElement.innerHTML = `
                    <div style="text-align: center; color: #dc2626;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading out-of-stock products
                    </div>
                `;
            }
        }

        // Load low-stock products
        async function loadLowStockProducts() {
            const loadingElement = document.getElementById('low-stock-loading');
            const listElement = document.getElementById('low-stock-list');
            const emptyElement = document.getElementById('low-stock-empty');
            const gridElement = document.getElementById('low-stock-grid');
            
            // Show loading
            loadingElement.style.display = 'flex';
            listElement.style.display = 'none';
            emptyElement.style.display = 'none';
            
            try {
                let lowStockProducts = inventoryCache.lowStock;
                
                if (lowStockProducts.length === 0 && typeof StockManager !== 'undefined') {
                    lowStockProducts = await StockManager.getLowStockProducts();
                    inventoryCache.lowStock = lowStockProducts;
                }
                
                loadingElement.style.display = 'none';
                
                if (lowStockProducts.length === 0) {
                    emptyElement.style.display = 'block';
                } else {
                    // Display products
                    gridElement.innerHTML = '';
                    lowStockProducts.forEach(product => {
                        const productCard = createInventoryProductCard(product, 'low-stock');
                        gridElement.appendChild(productCard);
                    });
                    listElement.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading low-stock products:', error);
                loadingElement.innerHTML = `
                    <div style="text-align: center; color: #f59e0b;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading low-stock products
                    </div>
                `;
            }
        }

        // Load all products inventory table
        async function loadAllProductsInventory() {
            const loadingElement = document.getElementById('all-inventory-loading');
            const listElement = document.getElementById('all-inventory-list');
            const tableBody = document.getElementById('inventory-tbody');
            
            // Show loading
            loadingElement.style.display = 'flex';
            listElement.style.display = 'none';
            
            try {
                let allProducts = inventoryCache.allProducts;
                
                if (allProducts.length === 0) {
                    allProducts = await loadAllProductsData();
                    inventoryCache.allProducts = allProducts;
                }
                
                loadingElement.style.display = 'none';
                
                // Clear table
                tableBody.innerHTML = '';
                
                // Populate table
                allProducts.forEach(product => {
                    const row = createInventoryTableRow(product);
                    tableBody.appendChild(row);
                });
                
                listElement.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading all products inventory:', error);
                loadingElement.innerHTML = `
                    <div style="text-align: center; color: #dc2626;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading inventory data
                    </div>
                `;
            }
        }

        // Create inventory product card
        function createInventoryProductCard(product, stockType) {
            const card = document.createElement('div');
            card.className = `product-card ${stockType}`;
            
            const stockBadgeText = stockType === 'out-of-stock' ? 'Out of Stock' : `${product.stock} left`;
            const stockBadgeClass = stockType === 'out-of-stock' ? 'out-of-stock-badge' : 'out-of-stock-badge low-stock';
            
            // Get the image URL - handle both mainImage and image properties
            const imageUrl = product.mainImage || product.image || '/images/placeholder-product.jpg';
            
            card.innerHTML = `
                <div class="product-image-container ${stockType === 'out-of-stock' ? 'out-of-stock' : ''}">
                    <img src="${imageUrl}" alt="${product.name}" class="product-image" 
                         onerror="this.src='/images/placeholder-product.jpg'">
                    <div class="${stockBadgeClass}">${stockBadgeText}</div>
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">₹${parseFloat(product.price || 0).toLocaleString('en-IN')}</div>
                    <div class="product-details" style="font-size: 12px; color: #64748b; margin-bottom: 12px;">
                        <div>Category: ${product.category || 'Unknown'}</div>
                        <div>Stock: <span class="stock-count ${stockType === 'out-of-stock' ? 'zero' : 'low'}">${product.stock || 0}</span></div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editProduct('${product.id}')">
                            <i class="fas fa-edit"></i>
                            Edit Stock
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Create inventory table row
        function createInventoryTableRow(product) {
            const row = document.createElement('tr');
            const stock = product.stock || 0;
            let statusClass = 'normal';
            let statusText = 'In Stock';
            
            if (stock === 0) {
                statusClass = 'zero';
                statusText = 'Out of Stock';
            } else if (stock <= 5) {
                statusClass = 'low';
                statusText = 'Low Stock';
            }
            
            const lastUpdated = product.updatedAt ? new Date(product.updatedAt).toLocaleDateString('en-IN') : 'Unknown';
            
            row.innerHTML = `
                <td>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="${product.mainImage || product.image || '/images/placeholder-product.jpg'}" 
                             alt="${product.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;"
                             onerror="this.src='/images/placeholder-product.jpg'">
                        <div>
                            <div style="font-weight: 600;">${product.name}</div>
                            <div style="font-size: 12px; color: #64748b;">ID: ${product.id}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="status-badge">${product.category || 'Unknown'}</span>
                </td>
                <td>₹${parseFloat(product.price || 0).toLocaleString('en-IN')}</td>
                <td><span class="stock-count ${statusClass}">${stock}</span></td>
                <td>
                    <span class="status-badge ${statusClass === 'zero' ? 'status-cancelled' : statusClass === 'low' ? 'status-pending' : 'status-confirmed'}">
                        ${statusText}
                    </span>
                </td>
                <td>${lastUpdated}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="editProduct('${product.id}')">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                </td>
            `;
            
            return row;
        }

        // Load all products data from all categories
        async function loadAllProductsData() {
            const categories = ['featured-collection', 'new-arrivals', 'saree-collection'];
            let allProducts = [];
            
            for (const category of categories) {
                try {
                    const response = await fetch(`/.netlify/functions/load-products?category=${category}&cacheBust=${Date.now()}`);
                    if (response.ok) {
                        const data = await response.json();
                        const products = data.products || [];
                        products.forEach(product => {
                            product.category = category;
                        });
                        allProducts.push(...products);
                    }
                } catch (error) {
                    console.error(`Error loading ${category} products:`, error);
                }
            }
            
            return allProducts;
        }

        function applySearchAndFilter() {
            // First apply the status filter
            let ordersToShow = allOrders;
            if (currentOrderFilter === 'pending') {
                ordersToShow = newOrders;
            } else if (currentOrderFilter === 'confirmed') {
                ordersToShow = confirmedOrders;
            } else if (currentOrderFilter === 'cancelled') {
                ordersToShow = cancelledOrders;
            }

            // Then apply search if there's a search term
            if (searchTerm) {
                filteredOrders = ordersToShow.filter(order => {
                    // Search in order ID
                    const orderIdMatch = (order.orderId || '').toLowerCase().includes(searchTerm);
                    const orderRefMatch = (order.orderReference || '').toLowerCase().includes(searchTerm);

                    // Search in customer name
                    const nameMatch = (order.customerName || '').toLowerCase().includes(searchTerm);

                    // Search in customer email
                    const emailMatch = (order.customerEmail || '').toLowerCase().includes(searchTerm);

                    // Search in customer phone
                    const phoneMatch = (order.customerPhone || '').toLowerCase().includes(searchTerm);

                    return orderIdMatch || orderRefMatch || nameMatch || emailMatch || phoneMatch;
                });

                // Update search results count
                const searchResults = document.getElementById('searchResults');
                if (searchResults) {
                    searchResults.textContent = `Found ${filteredOrders.length} order(s) matching "${searchTerm}"`;
                }

                ordersToShow = filteredOrders;
            } else {
                // Clear search results count
                const searchResults = document.getElementById('searchResults');
                if (searchResults) {
                    searchResults.textContent = '';
                }
            }

            // Update the display with filtered results
            updateOrdersSectionDisplayWithData(ordersToShow);
        }

        // Orders section display
        function updateOrdersSectionDisplay() {
            // Use the search and filter function instead
            applySearchAndFilter();
        }

        function updateOrdersSectionDisplayWithData(ordersToShow) {
            try {
                const ordersLoading = document.getElementById('orders-section-loading');
                const ordersTable = document.getElementById('orders-section-table');
                const ordersTbody = document.getElementById('orders-section-tbody');

            if (ordersLoading) ordersLoading.style.display = 'none';

            if (ordersToShow.length === 0) {
                if (ordersTable) ordersTable.style.display = 'block';
                if (ordersTbody) {
                    const isSearching = searchTerm.length > 0;
                    ordersTbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #64748b;">
                                <h3>${isSearching ? 'No orders found' : 'No orders found'}</h3>
                                <p>${isSearching ? `No orders match your search for "${searchTerm}"` : 'Order data will appear here when customers place orders.'}</p>
                                ${isSearching ? '<button class="btn btn-primary" onclick="clearSearch()">Clear Search</button>' : ''}
                            </td>
                        </tr>
                    `;
                }
                return;
            }

            // Sort by date (newest first)
            ordersToShow.sort((a, b) => b.date - a.date);

            if (ordersTbody) {
                ordersTbody.innerHTML = ordersToShow.map(order => {
                    const formattedDate = order.date.toLocaleDateString('en-IN');
                    const formattedTime = order.date.toLocaleTimeString('en-IN');
                    const formattedAmount = `₹${order.amount.toLocaleString('en-IN')}`;
                    const itemCount = order.products ? order.products.length : 0;
                    let statusClass, statusText;
                    if (order.status === 'confirmed') {
                        statusClass = 'status-confirmed';
                        statusText = 'CONFIRMED';
                    } else if (order.status === 'cancelled') {
                        statusClass = 'status-cancelled';
                        statusText = 'CANCELLED';
                    } else {
                        statusClass = 'status-pending';
                        statusText = 'PENDING';
                    }

                    // Highlight search terms in the display
                    let displayName = order.customerName;
                    let displayEmail = order.customerEmail;
                    let displayPhone = order.customerPhone;
                    let displayOrderRef = order.orderReference.substring(0, 15) + '...';

                    if (searchTerm) {
                        const highlightText = (text, term) => {
                            if (!text) return text;
                            const regex = new RegExp(`(${term})`, 'gi');
                            return text.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px;">$1</mark>');
                        };

                        displayName = highlightText(order.customerName, searchTerm);
                        displayEmail = highlightText(order.customerEmail, searchTerm);
                        displayPhone = highlightText(order.customerPhone, searchTerm);
                        displayOrderRef = highlightText(order.orderReference.substring(0, 15), searchTerm) + '...';
                    }

                    return `
                        <tr>
                            <td><strong>${displayOrderRef}</strong></td>
                            <td>
                                <div><strong>${displayName}</strong></div>
                                <small style="color: #64748b;">${displayEmail}</small>
                                ${order.customerPhone ? `<br><small style="color: #64748b;">${displayPhone}</small>` : ''}
                            </td>
                            <td>
                                <div>${formattedDate}</div>
                                <small style="color: #64748b;">${formattedTime}</small>
                            </td>
                            <td><span style="background: #f1f5f9; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${itemCount} items</span></td>
                            <td><strong>${formattedAmount}</strong></td>
                            <td>
                                <span class="status-badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>

                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewOrderDetails('${order.orderId}', '${order.userId}')" style="margin-right: 8px;">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                                ${order.status === 'pending' ? `
                                    <button class="btn btn-success btn-sm" onclick="confirmOrder('${order.orderId}', '${order.userId}')" style="margin-right: 8px;">
                                        <i class="fas fa-check"></i> Confirm
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="cancelOrder('${order.orderId}', '${order.userId}')">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                ` : order.status === 'confirmed' ?
                                    '<span class="btn btn-sm" style="background: #d1fae5; color: #065f46; cursor: default;">Processed</span>' :
                                    '<span class="btn btn-sm" style="background: #fee2e2; color: #991b1b; cursor: default;">Cancelled</span>'
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
                }

                if (ordersTable) ordersTable.style.display = 'block';
            } catch (error) {
                console.error('Error in updateOrdersSectionDisplayWithData:', error);
            }
        }

        // Update new orders display
        function updateNewOrdersDisplay() {
            try {
                const newOrdersLoading = document.getElementById('new-orders-loading');
                const newOrdersTableContainer = document.getElementById('new-orders-table-container');
                const newOrdersEmpty = document.getElementById('new-orders-empty');
                const newOrdersCount = document.getElementById('new-orders-count');
                const newOrdersTable = document.getElementById('new-orders-table');

                if (!newOrdersLoading || !newOrdersTableContainer || !newOrdersEmpty || !newOrdersCount || !newOrdersTable) {
                    console.log('New orders elements not found, skipping display update');
                    return; // Elements not found, skip
                }

                // Update count badge
                if (newOrdersCount) newOrdersCount.textContent = newOrders.length;

                // Hide loading
                if (newOrdersLoading) newOrdersLoading.style.display = 'none';

                if (newOrders.length === 0) {
                    if (newOrdersTableContainer) newOrdersTableContainer.style.display = 'none';
                    if (newOrdersEmpty) newOrdersEmpty.style.display = 'block';
                    return;
                }

                // Show table and populate with new orders
                if (newOrdersTableContainer) newOrdersTableContainer.style.display = 'block';
                if (newOrdersEmpty) newOrdersEmpty.style.display = 'none';

                // Sort by date (newest first)
                const sortedNewOrders = [...newOrders].sort((a, b) => b.date - a.date);

                const tbody = newOrdersTable.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = sortedNewOrders.slice(0, 10).map(order => `
                        <tr>
                            <td><strong>#${(order.orderReference || order.orderId).slice(-8)}</strong></td>
                            <td>
                                <div><strong>${order.customerName || 'Unknown'}</strong></div>
                                <small style="color: #64748b;">${order.customerEmail || 'No email'}</small>
                            </td>
                            <td>₹${order.amount.toLocaleString('en-IN')}</td>
                            <td>${order.date.toLocaleDateString('en-IN')}</td>
                            <td>
                                <span class="status-badge status-pending">
                                    PENDING
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="viewOrderDetails('${order.orderId}', '${order.userId}')" style="margin-right: 8px;">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                                <button class="btn btn-success btn-sm" onclick="confirmOrder('${order.orderId}', '${order.userId}')" style="margin-right: 8px;">
                                    <i class="fas fa-check"></i> Confirm
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="cancelOrder('${order.orderId}', '${order.userId}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error updating new orders display:', error);
            }
        }

        // Update recent confirmed orders display
        function updateRecentOrdersDisplay() {
            try {
                const recentOrdersLoading = document.getElementById('recent-orders-loading');

                if (recentOrdersLoading) {
                    recentOrdersLoading.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating recent orders display:', error);
            }
        }

        // Send order confirmation email
        async function sendOrderConfirmationEmail(orderData) {
            const emailData = {
                orderReference: orderData.orderReference || orderData.orderId,
                orderDate: orderData.date.toISOString(),
                orderTotal: orderData.amount,
                paymentMethod: orderData.paymentMethod || 'Not specified',
                customer: {
                    firstName: orderData.customerName.split(' ')[0] || '',
                    lastName: orderData.customerName.split(' ').slice(1).join(' ') || '',
                    email: orderData.customerEmail,
                    phone: orderData.customerPhone,
                    address: orderData.customerAddress
                },
                products: orderData.products || [],
                notes: orderData.notes || '',
                status: 'confirmed'
            };

            const response = await fetch('/.netlify/functions/send-order-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(emailData)
            });

            if (!response.ok) {
                throw new Error(`Email service returned ${response.status}`);
            }

            return await response.json();
        }

        // Send order cancellation email
        async function sendOrderCancellationEmail(orderData, reason) {
            const emailData = {
                orderReference: orderData.orderReference || orderData.orderId,
                orderDate: orderData.date ? orderData.date.toISOString() : new Date().toISOString(),
                orderTotal: orderData.amount,
                paymentMethod: orderData.paymentMethod || 'Not specified',
                customer: {
                    firstName: orderData.customerName.split(' ')[0] || '',
                    lastName: orderData.customerName.split(' ').slice(1).join(' ') || '',
                    email: orderData.customerEmail,
                    phone: orderData.customerPhone,
                    address: orderData.customerAddress
                },
                products: orderData.products || [],
                notes: orderData.notes || '',
                status: 'cancelled',
                cancellationReason: reason
            };

            console.log('Sending cancellation email with data:', emailData);

            const response = await fetch('/.netlify/functions/send-order-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(emailData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Email service error:', errorText);
                throw new Error(`Email service returned ${response.status}: ${errorText}`);
            }

            const result = await response.json();
            console.log('Cancellation email response:', result);
            return result;
        }

        function filterOrders(filter) {
            currentOrderFilter = filter;

            // Update tabs within orders section
            const ordersSection = document.getElementById('orders');
            if (ordersSection) {
                ordersSection.querySelectorAll('.section-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
            }

            // Apply both search and filter
            applySearchAndFilter();
        }

        // Products functionality - Load products from existing cached data
        async function loadProducts() {
            if (isLoadingProducts) return;
            isLoadingProducts = true;

            console.log('Loading products...');

            const productsLoading = document.getElementById('products-loading');
            const productsGrid = document.getElementById('products-grid');

            productsLoading.style.display = 'flex';
            productsGrid.style.display = 'none';

            try {
                // Use cached data if available and still fresh
                if (productsCache && (Date.now() - productsCache.timestamp) < 30000) {
                    console.log('Using cached product data');
                    displayProducts(filterProductsByCategory(productsCache.products));
                    productsLoading.style.display = 'none';
                    productsGrid.style.display = 'grid';
                    isLoadingProducts = false;
                    return;
                }

                let allProducts = [];
                const categories = ['featured-collection', 'new-arrivals', 'saree-collection'];

                // Load products from each category using the working Netlify functions
                for (const category of categories) {
                    try {
                        // Use the same endpoint structure that's working in the server logs
                        const response = await fetch(`/.netlify/functions/load-products?category=${category}&cacheBust=${Date.now()}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.products && Array.isArray(data.products)) {
                                const categoryProducts = data.products.map(product => ({
                                    ...product,
                                    category: category,
                                    categoryDisplay: category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())
                                }));
                                allProducts.push(...categoryProducts);
                                console.log(`✅ Loaded ${categoryProducts.length} products from ${category}`);
                            }
                        } else {
                            console.warn(`Server returned ${response.status} for ${category}`);
                        }
                    } catch (error) {
                        console.warn(`Could not load ${category} products:`, error);
                    }
                }

                // Cache the products
                productsCache = {
                    products: allProducts,
                    timestamp: Date.now()
                };

                console.log(`✅ Loaded ${allProducts.length} products for display`);
                displayProducts(filterProductsByCategory(allProducts));

            } catch (error) {
                console.error('❌ Error loading products:', error);
                productsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b;">
                        <h3>Error Loading Products</h3>
                        <p>Could not load product data. Checking connection...</p>
                        <button class="btn btn-primary" onclick="retryLoadProducts()">Try Again</button>
                    </div>
                `;
            } finally {
                // Always hide loading and show grid
                productsLoading.style.display = 'none';
                productsGrid.style.display = 'grid';
                isLoadingProducts = false;
            }
        }

        function filterProductsByCategory(products) {
            if (currentProductCategory === 'all') {
                return products;
            }
            return products.filter(product => product.category === currentProductCategory);
        }

        function retryLoadProducts() {
            productsCache = null; // Clear cache
            loadProducts();
        }

        // Display products in grid
        function displayProducts(products) {
            const productsGrid = document.getElementById('products-grid');

            if (products.length === 0) {
                const isSearching = productSearchTerm.length > 0;
                productsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b;">
                        <h3>${isSearching ? 'No Products Found' : 'No Products Available'}</h3>
                        <p>${isSearching ? `No products match your search for "${productSearchTerm}"` : 'No products available in the selected category.'}</p>
                        ${isSearching ? '<button class="btn btn-primary" onclick="clearProductSearch()">Clear Search</button>' : ''}
                    </div>
                `;
                productsGrid.style.display = 'grid';
                return;
            }

            // Sort products by category and name
            products.sort((a, b) => {
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                return a.name.localeCompare(b.name);
            });

            productsGrid.innerHTML = products.map(product => {
                // Handle the actual image structure from your Firebase data
                let imageUrl = '';

                // Debug logging for image issues
                if (!product.mainImage && (!product.images || product.images.length === 0)) {
                    console.warn(`Product ${product.id} (${product.name}) has no images`);
                }

                // First try mainImage (primary image)
                if (product.mainImage) {
                    imageUrl = product.mainImage;
                }
                // Then try the first image from images array
                else if (product.images && Array.isArray(product.images) && product.images.length > 0) {
                    // Find the main image or use the first one
                    const mainImg = product.images.find(img => img.isMain) || product.images[0];
                    imageUrl = mainImg.url || mainImg;  // Handle both object and string formats
                }
                // Check for legacy image field
                else if (product.image) {
                    imageUrl = product.image;
                }
                // Check for productImages array (legacy format)
                else if (product.productImages && Array.isArray(product.productImages) && product.productImages.length > 0) {
                    imageUrl = product.productImages[0];
                }
                // Fallback to placeholder
                else {
                    imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI4MCIgZmlsbD0iI0Y0RjRGNCIvPjx0ZXh0IHg9IjEwMCIgeT0iMTA1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOUM5Qzk3Ij5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';
                }

                const price = parseFloat(product.price || 0);
                let productName = product.name || 'Unnamed Product';

                // Highlight search terms if search is active
                if (productSearchTerm) {
                    const highlightText = (text, term) => {
                        if (!text) return text;
                        const regex = new RegExp(`(${term})`, 'gi');
                        return text.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px;">$1</mark>');
                    };
                    productName = highlightText(product.name || 'Unnamed Product', productSearchTerm);
                }

                return `
                    <div class="product-card">
                        <div class="product-image-container">
                            <img src="${imageUrl}" alt="${productName}" class="product-image"
                                 loading="lazy"
                                 onload="this.style.opacity='1'; this.parentElement.style.backgroundColor='transparent';"
                                 onerror="handleImageError(this, '${productName}')">
                        </div>
                        <div class="product-info">
                            <div class="product-name" title="${productName}">${productName}</div>
                            <div class="product-price">₹${price.toLocaleString('en-IN')}</div>
                            <div class="product-category">
                                Category: ${product.categoryDisplay}
                            </div>
                            <div class="product-actions">
                                <button class="btn btn-primary btn-sm" onclick="editProduct('${product.id}', '${product.category}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}', '${product.category}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            productsGrid.style.display = 'grid';
        }

        // Product management functions
        function editProduct(productId, category) {
            console.log(`Opening edit form for product ${productId} in category ${category}`);

            // Open products admin panel with edit parameters
            const editUrl = `products-admin-panel.html?category=${category}&edit=${productId}`;

            // Try to open in a new tab, with fallback handling
            try {
                const newWindow = window.open(editUrl, '_blank');

                // Check if popup was blocked
                setTimeout(() => {
                    if (!newWindow || newWindow.closed) {
                        // If popup blocked or failed, try same window
                        console.log('Popup blocked, redirecting in same window...');
                        window.location.href = editUrl;
                    }
                }, 100);

            } catch (error) {
                console.error('Error opening edit form:', error);
                // Fallback to same window
                window.location.href = editUrl;
            }
        }

        // Enhanced delete product function with custom modal
        async function deleteProduct(productId, category) {
            // Find product details for the modal
            const product = productsCache?.products?.find(p => p.id === productId);

            const confirmed = await showDeleteProductModal({
                productId: productId,
                category: category,
                productName: product?.name || 'Unknown Product',
                productPrice: product?.price || 0,
                productImage: product?.mainImage || product?.images?.[0]?.url || product?.image || null
            });

            if (!confirmed) {
                return;
            }

            // Show loading state immediately
            showGlobalLoader('Deleting product...');

            try {
                console.log(`Deleting product ${productId} from ${category}...`);

                const response = await fetch('/.netlify/functions/delete-product', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: productId,
                        category: category
                    })
                });

                console.log(`Delete response status: ${response.status}`);
                console.log(`Delete response headers:`, response.headers);

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                let result;

                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    // Handle non-JSON response (likely HTML error page)
                    const textResponse = await response.text();
                    console.error('Non-JSON response:', textResponse);
                    throw new Error('Server returned HTML instead of JSON. Status: ' + response.status);
                }

                if (result.success) {
                    // Show success modal
                    showSuccessModal({
                        title: 'Product Deleted!',
                        message: 'The product has been successfully removed from your inventory.',
                        icon: '🗑️'
                    });

                    // Clear cache to force refresh
                    productsCache = null;

                    // Reload products with fresh data
                    await loadProducts();

                    // Reload inventory stats
                    await loadInventoryData();
                } else {
                    throw new Error(result.error || 'Failed to delete product');
                }

            } catch (error) {
                console.error('❌ Error deleting product:', error);
                hideGlobalLoader(); // Hide loader on error

                // Provide more helpful error messages
                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Network error: Could not connect to server. Please check your internet connection.';
                } else if (error.message.includes('HTML instead of JSON')) {
                    errorMsg = 'Server error: The delete function is not responding properly. This might be a deployment issue.';
                }

                // Show error in styled modal instead of alert
                showErrorModal('Delete Failed', `Error deleting product: ${errorMsg}`);
            }
        }

        // Custom delete product confirmation modal
        function showDeleteProductModal(productData) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'delete-product-modal';
                modal.style.zIndex = '15000';

                const categoryDisplay = productData.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                const formattedPrice = `₹${parseFloat(productData.productPrice || 0).toLocaleString('en-IN')}`;

                modal.innerHTML = `
                    <div class="delete-product-content">
                        <div class="delete-product-header">
                            <div class="delete-product-icon">
                                🗑️
                            </div>
                            <h3 class="delete-product-title">Delete Product</h3>
                            <p class="delete-product-subtitle">This action cannot be undone!</p>
                        </div>

                        <div class="delete-product-body">
                            <p class="delete-product-message">
                                Are you absolutely sure you want to delete this product from your inventory?
                            </p>

                            <div class="delete-product-info">
                                <h4>
                                    <i class="fas fa-box" style="color: #059669;"></i>
                                    Product Details
                                </h4>
                                <p><strong>Name:</strong> ${productData.productName}</p>
                                <p><strong>Category:</strong> ${categoryDisplay}</p>
                                <p><strong>Price:</strong> ${formattedPrice}</p>
                                <p><strong>Product ID:</strong> <span style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">${productData.productId}</span></p>
                            </div>

                            <div class="delete-warning-box">
                                <div class="warning-icon">⚠️</div>
                                <p>
                                    This will permanently remove the product from all collections,
                                    customer wishlists, and search results. The product data
                                    cannot be recovered after deletion.
                                </p>
                            </div>
                        </div>

                        <div class="delete-product-actions">
                            <button class="delete-product-btn cancel" onclick="window.deleteProductResolve(false);">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button class="delete-product-btn confirm" onclick="window.handleDeleteConfirm();">
                                <i class="fas fa-trash"></i>
                                Delete Product
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Set up resolve function
                window.deleteProductResolve = (result) => {
                    modal.remove();
                    delete window.deleteProductResolve;
                    delete window.handleDeleteConfirm;
                    resolve(result);
                };

                // Handle confirm button click with loading state
                window.handleDeleteConfirm = () => {
                    const confirmBtn = modal.querySelector('.delete-product-btn.confirm');
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<div class="spinner"></div> Deleting...';

                    // Small delay to show the loading state, then resolve
                    setTimeout(() => {
                        modal.remove();
                        delete window.deleteProductResolve;
                        delete window.handleDeleteConfirm;
                        resolve(true);
                    }, 500);
                };

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        window.deleteProductResolve(false);
                    }
                });

                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        document.removeEventListener('keydown', handleEscape);
                        window.deleteProductResolve(false);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        }

        // Error modal function
        function showErrorModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'custom-confirm-modal';
            modal.style.zIndex = '15000';

            modal.innerHTML = `
                <div class="custom-confirm-content">
                    <div class="custom-confirm-header">
                        <div class="custom-confirm-icon cancel-action">
                            ❌
                        </div>
                        <h3 class="custom-confirm-title">${title}</h3>
                    </div>

                    <div class="custom-confirm-body">
                        <p class="custom-confirm-message">${message}</p>
                    </div>

                    <div class="custom-confirm-actions">
                        <button class="custom-confirm-btn primary" onclick="this.closest('.custom-confirm-modal').remove();">
                            <i class="fas fa-check"></i>
                            OK
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function filterProducts(category) {
            currentProductCategory = category;

            // Update tabs within products section
            const productsSection = document.getElementById('products');
            if (productsSection) {
                productsSection.querySelectorAll('.section-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                if (event && event.target) {
                    event.target.classList.add('active');
                }
            }

            // Clear product search when switching categories
            const searchInput = document.getElementById('productSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            productSearchTerm = '';

            // Clear search results count
            const searchResults = document.getElementById('productSearchResults');
            if (searchResults) {
                searchResults.textContent = '';
            }

            // Use cached data if available instead of reloading
            if (productsCache && productsCache.products) {
                console.log(`Filtering products for category: ${category}`);
                displayProducts(filterProductsByCategory(productsCache.products));
            } else {
                loadProducts();
            }
        }

        // Notification management functions
        function getStoredNotifications() {
            try {
                const stored = localStorage.getItem('adminNotifications');
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error loading stored notifications:', error);
                return [];
            }
        }

        function saveNotifications() {
            try {
                localStorage.setItem('adminNotifications', JSON.stringify(notifications));
            } catch (error) {
                console.error('Error saving notifications:', error);
            }
        }

        // Add notification function - Save to Firebase Firestore primarily
        async function addNotification(message, type = 'info', relatedData = null) {
            const currentTime = new Date();
            const notification = {
                id: ++notificationIdCounter,
                message: message,
                timestamp: currentTime.toISOString(),
                type: type,
                read: false,
                relatedData: relatedData,
                createdAt: currentTime.toISOString(),
                formattedDate: currentTime.toLocaleDateString('en-IN'),
                formattedTime: currentTime.toLocaleTimeString('en-IN')
            };

            // Add to local array for immediate UI update
            notifications.unshift(notification);
            console.log('✅ New notification added:', notification);

            // Save to Firebase Firestore first
            try {
                await db.collection('adminNotifications').doc(notification.id.toString()).set(notification);
                console.log('✅ Notification saved to Firestore');

                // Save to localStorage as backup only after Firebase success
                try {
                    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                    console.log('✅ Notification saved to localStorage backup');
                } catch (localError) {
                    console.warn('⚠️ Failed to save notification to localStorage backup:', localError);
                }
            } catch (firebaseError) {
                console.error('❌ Failed to save notification to Firestore:', firebaseError);
                // Still save to localStorage if Firebase fails
                try {
                    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                    console.log('✅ Notification saved to localStorage as fallback');
                } catch (localError) {
                    console.error('❌ Failed to save notification to localStorage fallback:', localError);
                }
            }

            updateNotificationDisplay();
            updateNotificationBadges(); // Ensure badges are updated
        }

        // Mark notification as read - Save to Firebase Firestore primarily
        async function markNotificationAsRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification && !notification.read) {
                console.log(`Marking notification ${notificationId} as read...`);
                notification.read = true;

                // Update in Firebase first
                try {
                    await db.collection('adminNotifications').doc(notificationId.toString()).update({
                        read: true
                    });
                    console.log('✅ Notification marked as read in Firestore');

                    // Update in localStorage as backup only after Firebase success
                    try {
                        localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                        console.log('✅ Notification status updated in localStorage backup');
                    } catch (error) {
                        console.warn('⚠️ Failed to update localStorage backup:', error);
                    }
                } catch (firebaseError) {
                    console.error('❌ Failed to update notification in Firestore:', firebaseError);
                    // Still update localStorage if Firebase fails
                    try {
                        localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                        console.log('✅ Notification status updated in localStorage as fallback');
                    } catch (error) {
                        console.error('❌ Failed to update localStorage fallback:', error);
                    }
                }

                // Force immediate update of display and badges
                updateNotificationDisplay();
                updateNotificationBadges();
                console.log(`✅ Notification ${notificationId} marked as read, badge should update`);
            } else if (notification && notification.read) {
                console.log(`Notification ${notificationId} is already marked as read`);
            } else {
                console.warn(`Notification ${notificationId} not found`);
            }
        }

        function updateNotificationBadges() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const countBadge = document.getElementById('notification-count');

            if (countBadge) {
                if (unreadCount > 0) {
                    // Show actual count numbers
                    countBadge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                    countBadge.style.display = 'flex';

                    // Adjust badge size based on count
                    if (unreadCount > 9) {
                        countBadge.style.minWidth = '24px';
                        countBadge.style.padding = '3px 8px';
                    } else {
                        countBadge.style.minWidth = '20px';
                        countBadge.style.padding = '3px 6px';
                    }
                } else {
                    countBadge.style.display = 'none';
                }
            }
        }

        function updateNotificationDisplay() {
            const notificationsContainer = document.getElementById('notifications-list'); // Corrected ID
            const notificationsEmpty = document.getElementById('notifications-empty');

            if (!notificationsContainer || !notificationsEmpty) return;

            if (notifications.length === 0) {
                notificationsContainer.style.display = 'none';
                notificationsEmpty.style.display = 'block';
                return;
            }

            // Clear existing list
            notificationsContainer.innerHTML = '';

            // Display latest notifications (limit to 10)
            const recentNotifications = notifications.slice(0, 10);

            recentNotifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                notificationElement.style.cursor = 'pointer';
                notificationElement.onclick = async () => {
                    console.log(`Clicking notification ${notification.id}, current read status: ${notification.read}`);
                    await handleNotificationClick(notification);
                };

                // Format timestamp
                const timeAgo = formatTimeAgo(notification.timestamp);

                // Add special styling for pending order notifications
                let extraClass = '';
                if (notification.type === 'admin-order-pending') {
                    extraClass = 'pending-order-notification';
                }

                notificationElement.innerHTML = `
                    <div class="notification-content ${extraClass}">
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                    ${!notification.read ? '<div class="unread-indicator"></div>' : ''}
                `;

                notificationsContainer.appendChild(notificationElement);
            });

            // Add mark all as read button if there are unread notifications
            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                const markAllReadButton = document.createElement('div');
                markAllReadButton.style.cssText = "padding: 12px; border-bottom: 2px solid #e2e8f0; background-color: #f8fafc;";
                markAllReadButton.innerHTML = `
                    <button class="btn btn-sm btn-secondary" onclick="markAllAsRead();">
                        Mark All as Read (${unreadCount})
                    </button>
                `;
                notificationsContainer.prepend(markAllReadButton);
            }

            notificationsContainer.style.display = 'block';
            notificationsEmpty.style.display = 'none';
            updateNotificationBadges(); // Ensure badges are updated after display
        }

        // Mark all notifications as read
        async function markAllAsRead() {
            try {
                const unreadNotifications = notifications.filter(n => !n.read);

                for (const notification of unreadNotifications) {
                    notification.read = true;

                    // Update in Firebase
                    try {
                        await db.collection('adminNotifications').doc(notification.id.toString()).update({
                            read: true
                        });
                    } catch (firebaseError) {
                        console.warn(`Failed to update notification ${notification.id} in Firestore:`, firebaseError);
                    }
                }

                // Update localStorage backup
                try {
                    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                } catch (error) {
                    console.warn('Failed to update localStorage backup:', error);
                }

                // Refresh display
                updateNotificationDisplay();

                console.log(`✅ Marked ${unreadNotifications.length} notifications as read`);
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        async function handleNotificationClick(notification) {
            console.log('Notification clicked with complete data:', notification);

            // Mark as read when clicked and wait for completion
            await markNotificationAsRead(notification.id);

            // Handle different notification types - fix the type check
            if ((notification.type === 'auto-new-order' || notification.type.startsWith('auto-order-') || notification.type.startsWith('admin-order-') || notification.type === 'pending-order-notification') && notification.relatedData) {
                console.log('Opening order details for:', notification.relatedData);

                // If we have complete order data in the notification, show it directly
                if (notification.relatedData.customerAddress && notification.relatedData.products) {
                    console.log('Using complete order data from notification');
                    showOrderDetailsFromNotification(notification.relatedData);
                } else {
                    // Fallback to loading from Firebase
                    console.log('Loading order details from Firebase');
                    viewOrderDetails(notification.relatedData.orderId, notification.relatedData.userId);
                }
            } else {
                console.log('No related data or wrong type for notification:', notification.type);
                // Show notification details in a simple modal for non-order notifications
                showNotificationDetailsModal(notification);
            }
        }

        // Show order details directly from notification data
        function showOrderDetailsFromNotification(orderData) {
            const order = {
                orderId: orderData.orderId,
                orderReference: orderData.orderReference,
                date: new Date(orderData.orderDate),
                amount: orderData.amount,
                customerName: orderData.customerName,
                customerEmail: orderData.customerEmail,
                customerPhone: orderData.customerPhone,
                customerAddress: orderData.customerAddress,
                paymentMethod: orderData.paymentMethod,
                products: orderData.products || [],
                notes: orderData.notes || '',
                status: orderData.status
            };

            console.log('Showing order details from notification with complete address:', order.customerAddress);

            // Create modal HTML with complete order data
            const modalHTML = `
                <div id="orderDetailsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 32px; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 16px;">
                            <h2 style="margin: 0; color: #1e293b; font-size: 24px;">Order Details (From Notification)</h2>
                            <button onclick="closeOrderModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; line-height: 1;">&times;</button>
                        </div>

                        <!-- Order Header -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                            <h3 style="margin: 0 0 8px 0; color: #2563eb; font-size: 18px;">Order #${order.orderReference}</h3>
                            <p style="margin: 0 0 8px 0; color: #64748b;">Date: ${order.date.toLocaleDateString('en-IN')} ${order.date.toLocaleTimeString('en-IN')}</p>
                            <p style="margin: 0; color: #64748b;">Status: <span style="background: ${order.status === 'confirmed' ? '#dcfce7; color: #166534' : order.status === 'cancelled' ? '#fee2e2; color: #991b1b' : '#fef3c7; color: #92400e'}; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; text-transform: uppercase;">${order.status}</span></p>
                        </div>

                        <!-- Customer Information -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="margin: 0 0 16px 0; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Customer Information</h4>
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
                                <p style="margin: 0 0 8px 0;"><strong>Name:</strong> ${order.customerName}</p>
                                <p style="margin: 0 0 8px 0;"><strong>Email:</strong> ${order.customerEmail}</p>
                                <p style="margin: 0 0 8px 0;"><strong>Phone:</strong> ${order.customerPhone}</p>
                                <p style="margin: 0;"><strong>Address:</strong> ${order.customerAddress}</p>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="margin: 0 0 16px 0; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Order Items</h4>
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                                ${order.products.map((item, index) => {
                                    const itemPrice = parseFloat(item.price || 0);
                                    const itemQuantity = parseInt(item.quantity || 1);
                                    const itemTotal = itemPrice * itemQuantity;

                                    return `
                                        <div style="padding: 16px; ${index < order.products.length - 1 ? 'border-bottom: 1px solid #f1f5f9;' : ''}">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div style="flex: 1;">
                                                    <h5 style="margin: 0 0 4px 0; color: #1e293b;">${item.name || item.productName || `Product #${item.id || index + 1}`}</h5>
                                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Qty: ${itemQuantity} × ₹${itemPrice.toLocaleString('en-IN')}</p>
                                                </div>
                                                <div style="text-align: right; font-weight: 600; color: #059669;">
                                                    ₹${itemTotal.toLocaleString('en-IN')}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="margin: 0 0 16px 0; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Payment Information</h4>
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
                                <p style="margin: 0 0 12px 0;"><strong>Method:</strong> ${order.paymentMethod}</p>
                                <p style="margin: 0; font-size: 18px;"><strong>Total Amount:</strong> <span style="color: #059669; font-size: 20px;">₹${order.amount.toLocaleString('en-IN')}</span></p>
                            </div>
                        </div>

                        <!-- Order Notes -->
                        ${order.notes ? `
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin: 0 0 16px 0; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Order Notes</h4>
                                <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px;">
                                    <p style="margin: 0; color: #92400e;">${order.notes}</p>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                            <button onclick="closeOrderModal()" class="btn btn-secondary">Close</button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close notification modal
        function closeNotificationModal() {
            const modal = document.getElementById('notificationDetailsModal');
            if (modal) {
                // Add closing animation
                modal.style.transition = 'opacity 0.3s ease, backdrop-filter 0.3s ease';
                modal.style.opacity = '0';
                modal.style.backdropFilter = 'blur(0px)';
                
                const modalContent = modal.querySelector('div[style*="background: white"]');
                if (modalContent) {
                    modalContent.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                    modalContent.style.transform = 'scale(0.9)';
                    modalContent.style.opacity = '0';
                }
                
                // Remove modal after animation
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }

        // View order details function - loads order from Firebase and shows modal
        async function viewOrderDetails(orderId, userId) {
            console.log(`Loading order details for order ${orderId} from user ${userId}`);
            
            try {
                // Show loading state
                showGlobalLoader('Loading order details...');

                // Find order in our cached data first
                let order = allOrders.find(o => o.orderId === orderId && o.userId === userId);
                
                if (!order) {
                    // If not found in cache, try to load from Firebase
                    console.log('Order not found in cache, loading from Firebase...');
                    
                    if (typeof firebase !== 'undefined' && firebase.firestore) {
                        const orderDoc = await firebase.firestore()
                            .collection('users')
                            .doc(userId)
                            .collection('orders')
                            .doc(orderId)
                            .get();
                            
                        if (orderDoc.exists) {
                            const orderData = orderDoc.data();
                            order = {
                                orderId: orderId,
                                userId: userId,
                                orderReference: orderData.orderReference || orderId,
                                date: orderData.timestamp?.toDate() || new Date(orderData.orderDate) || new Date(),
                                amount: orderData.total || orderData.orderTotal || 0,
                                customerName: extractCustomerName(orderData),
                                customerEmail: extractCustomerEmail(orderData),
                                customerPhone: extractCustomerPhone(orderData),
                                customerAddress: extractCustomerAddress(orderData),
                                paymentMethod: orderData.paymentMethod || 'Not specified',
                                products: orderData.products || orderData.items || [],
                                notes: orderData.notes || orderData.specialInstructions || '',
                                status: orderData.status || 'pending'
                            };
                        }
                    }
                }
                
                hideGlobalLoader();
                
                if (order) {
                    showOrderDetailsModal(order);
                } else {
                    alert('Order not found. The order may have been deleted or does not exist.');
                }
                
            } catch (error) {
                console.error('Error loading order details:', error);
                hideGlobalLoader();
                alert(`Error loading order details: ${error.message}`);
            }
        }

        // Close order details modal
        function closeOrderModal() {
            const modal = document.getElementById('orderDetailsModal');
            if (modal) {
                // Add closing animation
                modal.style.transition = 'opacity 0.3s ease, backdrop-filter 0.3s ease';
                modal.style.opacity = '0';
                modal.style.backdropFilter = 'blur(0px)';
                
                const modalContent = modal.querySelector('div[style*="background: white"]');
                if (modalContent) {
                    modalContent.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                    modalContent.style.transform = 'scale(0.9)';
                    modalContent.style.opacity = '0';
                }
                
                // Remove modal after animation
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }

        // Show order details modal (used by both viewOrderDetails and showOrderDetailsFromNotification)
        function showOrderDetailsModal(order) {
            console.log('Showing order details modal for order:', order);

            // Create modal HTML with complete order data
            const modalHTML = `
                <div id="orderDetailsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0); backdrop-filter: blur(0px); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease, backdrop-filter 0.3s ease;">
                    <div style="background: white; padding: 32px; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.15); transform: scale(0.9); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 16px;">
                            <h2 style="margin: 0; color: #1e293b; font-size: 24px;">Order Details</h2>
                            <button onclick="closeOrderModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; line-height: 1;">&times;</button>
                        </div>

                        <!-- Order Header -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                            <h3 style="margin: 0 0 8px 0; color: #2563eb; font-size: 18px;">Order #${order.orderReference}</h3>
                            <p style="margin: 0 0 8px 0; color: #64748b;">Date: ${order.date.toLocaleDateString('en-IN')} ${order.date.toLocaleTimeString('en-IN')}</p>
                            <p style="margin: 0; color: #64748b;">Status: <span style="background: ${order.status === 'confirmed' ? '#dcfce7; color: #166534' : order.status === 'cancelled' ? '#fee2e2; color: #991b1b' : '#fef3c7; color: #92400e'}; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; text-transform: uppercase;">${order.status}</span></p>
                        </div>

                        <!-- Customer Information -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="margin: 0 0 16px 0; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Customer Information</h4>
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
                                <p style="margin: 0 0 8px 0;"><strong>Name:</strong> ${order.customerName}</p>
                                <p style="margin: 0 0 8px 0;"><strong>Email:</strong> ${order.customerEmail}</p>
                                <p style="margin: 0 0 8px 0;"><strong>Phone:</strong> ${order.customerPhone}</p>
                                <p style="margin: 0;"><strong>Address:</strong> ${order.customerAddress}</p>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="margin: 0 0 16px 0; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Order Items</h4>
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                                ${order.products.map((item, index) => {
                                    const itemPrice = parseFloat(item.price || 0);
                                    const itemQuantity = parseInt(item.quantity || 1);
                                    const itemTotal = itemPrice * itemQuantity;

                                    return `
                                        <div style="padding: 16px; border-bottom: ${index < order.products.length - 1 ? '1px solid #e2e8f0' : 'none'};">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div style="flex: 1;">
                                                    <h5 style="margin: 0 0 4px 0; color: #1e293b;">${item.name || item.productName || 'Product'}</h5>
                                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Quantity: ${itemQuantity} × ₹${itemPrice.toLocaleString('en-IN')}</p>
                                                </div>
                                                <div style="text-align: right;">
                                                    <p style="margin: 0; font-weight: 600; color: #059669;">₹${itemTotal.toLocaleString('en-IN')}</p>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div style="margin-bottom: 24px;">
                            <h4 style="margin: 0 0 16px 0; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Payment Information</h4>
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px;">
                                <p style="margin: 0 0 12px 0;"><strong>Method:</strong> ${order.paymentMethod}</p>
                                <p style="margin: 0; font-size: 18px;"><strong>Total Amount:</strong> <span style="color: #059669; font-size: 20px;">₹${order.amount.toLocaleString('en-IN')}</span></p>
                            </div>
                        </div>

                        <!-- Order Notes -->
                        ${order.notes ? `
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin: 0 0 16px 0; color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">Order Notes</h4>
                                <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px;">
                                    <p style="margin: 0; color: #92400e;">${order.notes}</p>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                            <button onclick="closeOrderModal()" class="btn btn-secondary">Close</button>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Trigger animation after modal is in DOM
            setTimeout(() => {
                const modal = document.getElementById('orderDetailsModal');
                if (modal) {
                    modal.style.opacity = '1';
                    modal.style.background = 'rgba(0,0,0,0.5)';
                    modal.style.backdropFilter = 'blur(5px)';
                    
                    const modalContent = modal.querySelector('div[style*="background: white"]');
                    if (modalContent) {
                        modalContent.style.transform = 'scale(1)';
                        modalContent.style.opacity = '1';
                    }
                }
            }, 10);
        }

        // Create notification for admin actions only (confirm/cancel orders)
        async function addOrderStatusNotification(orderId, newStatus, orderDetails) {
            try {
                // Check if notification already exists for this order status change
                const existingNotification = notifications.find(n =>
                    n.relatedData?.orderId === orderId &&
                    n.type === `admin-order-${newStatus}`
                );

                if (existingNotification) {
                    console.log(`Notification already exists for ${newStatus} action on order ${orderId}`);
                    return;
                }

                let statusMessage = '';
                if (newStatus === 'confirmed') {
                    statusMessage = `Order confirmed: ${orderDetails.customerName} - ₹${orderDetails.amount.toLocaleString('en-IN')}`;
                } else if (newStatus === 'cancelled') {
                    statusMessage = `Order cancelled: ${orderDetails.customerName} - ₹${orderDetails.amount.toLocaleString('en-IN')}`;
                } else if (newStatus === 'pending') {
                    // This notification is specifically for the admin to see pending orders
                    statusMessage = `New order pending confirmation: ${orderDetails.customerName} - ₹${orderDetails.amount.toLocaleString('en-IN')}`;
                } else {
                    // Don't create notifications for other statuses
                    return;
                }

                // Create new notification for admin action or pending order
                const statusNotification = {
                    id: ++notificationIdCounter,
                    message: statusMessage,
                    timestamp: new Date().toISOString(),
                    type: `admin-order-${newStatus}`, // Changed prefix to indicate admin action or pending status
                    read: false,
                    relatedData: {
                        orderId: orderId,
                        userId: orderDetails.userId,
                        orderReference: orderDetails.orderReference,
                        customerName: orderDetails.customerName,
                        customerEmail: orderDetails.customerEmail,
                        customerPhone: orderDetails.customerPhone,
                        customerAddress: orderDetails.customerAddress,
                        amount: orderDetails.amount,
                        paymentMethod: orderDetails.paymentMethod,
                        orderDate: typeof orderDetails.orderDate === 'string' ? orderDetails.orderDate : new Date().toISOString(),
                        status: newStatus,
                        products: orderDetails.products,
                        notes: orderDetails.notes,
                        orderDetails: {
                            formattedDate: orderDetails.orderDate ? new Date(orderDetails.orderDate).toLocaleDateString('en-IN') : 'N/A',
                            formattedTime: orderDetails.orderDate ? new Date(orderDetails.orderDate).toLocaleTimeString('en-IN') : 'N/A',
                            formattedAmount: `₹${orderDetails.amount.toLocaleString('en-IN')}`,
                            itemCount: orderDetails.products ? orderDetails.products.length : 0,
                            totalItemValue: orderDetails.products ? orderDetails.products.reduce((sum, item) => sum + (parseFloat(item.price || 0) * parseInt(item.quantity || 1)), 0) : 0
                        }
                    },
                    category: newStatus === 'pending' ? 'action-required' : 'admin-action', // Categorize pending orders
                    priority: newStatus === 'pending' ? 'high' : 'medium',
                    source: 'admin-dashboard',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Add to notifications array
                notifications.unshift(statusNotification);

                // Save to Firebase
                try {
                    await db.collection('adminNotifications').doc(statusNotification.id.toString()).set(statusNotification);
                    console.log(`✅ Created notification for ${newStatus} on order ${orderId}`);
                } catch (firebaseError) {
                    console.warn(`⚠️ Failed to save notification to Firestore:`, firebaseError);
                }

                // Update localStorage backup
                try {
                    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                } catch (error) {
                    console.warn('⚠️ Failed to update localStorage:', error);
                }

                // Refresh notification display
                updateNotificationDisplay();
            } catch (error) {
                console.error('❌ Error creating status notification:', error);
            }
        }

        // Load notifications from Firebase Firestore with localStorage backup
        async function loadNotifications() {
            const notificationsLoading = document.getElementById('notifications-loading');
            const notificationsList = document.getElementById('notifications-list');

            console.log('🔄 Loading notifications from Firestore...');

            if (notificationsLoading) notificationsLoading.style.display = 'block';
            if (notificationsList) notificationsList.style.display = 'none';

            try {
                // Always try to load from Firebase first for deployed sites
                const notificationsSnapshot = await db.collection('adminNotifications')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();

                notifications = [];
                notificationIdCounter = 0;

                notificationsSnapshot.forEach(doc => {
                    const notificationData = doc.data();
                    notifications.push({
                        id: parseInt(doc.id) || notificationData.id,
                        message: notificationData.message,
                        timestamp: notificationData.timestamp,
                        type: notificationData.type || 'info',
                        read: notificationData.read || false,
                        relatedData: notificationData.relatedData || null
                    });
                    notificationIdCounter = Math.max(notificationIdCounter, parseInt(doc.id) || notificationData.id || 0);
                });

                console.log(`✅ Successfully loaded ${notifications.length} notifications from Firestore`);

                // Update localStorage backup with latest Firebase data
                try {
                    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                    console.log('✅ Updated localStorage backup with Firestore data');
                } catch (localError) {
                    console.warn('⚠️ Could not update localStorage backup:', localError);
                }

            } catch (firebaseError) {
                console.error('❌ Failed to load from Firestore:', firebaseError);

                // Fallback to localStorage only if Firebase completely fails
                try {
                    const stored = localStorage.getItem('adminNotifications');
                    if (stored) {
                        notifications = JSON.parse(stored);
                        notificationIdCounter = Math.max(...notifications.map(n => n.id || 0), 0);
                        console.log(`⚠️ Loaded ${notifications.length} notifications from localStorage fallback`);
                    } else {
                        notifications = [];
                        notificationIdCounter = 0;
                        console.log('📦 No stored notifications found, starting fresh');
                    }
                } catch (localError) {
                    console.error('❌ Error loading from localStorage fallback:', localError);
                    notifications = [];
                    notificationIdCounter = 0;
                }
            }

            // Auto-generate notifications for pending orders during load
            // This ensures pending orders are reflected in the notification list immediately
            if (newOrders && newOrders.length > 0) {
                console.log(`Checking ${newOrders.length} new orders for pending notifications...`);
                for (const order of newOrders) {
                    const existingPendingNotification = notifications.find(n =>
                        n.relatedData?.orderId === order.orderId &&
                        n.type === 'admin-order-pending'
                    );

                    if (!existingPendingNotification) {
                        console.log(`Creating notification for pending order: ${order.orderId}`);
                        await addOrderStatusNotification(order.orderId, 'pending', order);
                    }
                }
            }

            // Always update display
            updateNotificationDisplay();

            // Hide loading and show notifications list
            if (notificationsLoading) notificationsLoading.style.display = 'none';
            if (notificationsList) notificationsList.style.display = 'block';

            console.log(`🎯 Notification loading complete. Total notifications: ${notifications.length}`);
        }

        // Helper to show a generic notification details modal (for non-order notifications)
        function showNotificationDetailsModal(notification) {
            const modalHTML = `
                <div id="notificationDetailsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0); backdrop-filter: blur(0px); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease, backdrop-filter 0.3s ease;">
                    <div style="background: white; padding: 32px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.15); transform: scale(0.9); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 16px;">
                            <h2 style="margin: 0; color: #1e293b; font-size: 20px;">Notification Details</h2>
                            <button onclick="closeNotificationModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; line-height: 1;">&times;</button>
                        </div>
                        <p style="color: #1e293b; font-weight: 500; margin-bottom: 12px;">${notification.message}</p>
                        <p style="color: #64748b; font-size: 13px;">${new Date(notification.timestamp).toLocaleString('en-IN')}</p>
                        <div style="margin-top: 24px; text-align: right;">
                            <button onclick="closeNotificationModal()" class="btn btn-secondary">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Trigger animation after modal is in DOM
            setTimeout(() => {
                const modal = document.getElementById('notificationDetailsModal');
                if (modal) {
                    modal.style.opacity = '1';
                    modal.style.background = 'rgba(0,0,0,0.5)';
                    modal.style.backdropFilter = 'blur(5px)';
                    
                    const modalContent = modal.querySelector('div[style*="background: white"]');
                    if (modalContent) {
                        modalContent.style.transform = 'scale(1)';
                        modalContent.style.opacity = '1';
                    }
                }
            }, 10);
        }

        // Helper to format time ago with better error handling
        function formatTimeAgo(timestampInput) {
            try {
                let date;

                // Handle different timestamp formats
                if (timestampInput instanceof Date) {
                    date = timestampInput;
                } else if (typeof timestampInput === 'string') {
                    date = new Date(timestampInput);
                } else if (typeof timestampInput === 'number') {
                    date = new Date(timestampInput);
                } else {
                    console.warn('Invalid timestamp format:', timestampInput);
                    return 'Unknown time';
                }

                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date created from:', timestampInput);
                    return 'Unknown time';
                }

                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);

                // Handle future dates
                if (seconds < 0) {
                    return 'Just now';
                }

                let interval = Math.floor(seconds / 31536000);
                if (interval > 1) return interval + " years ago";
                if (interval === 1) return interval + " year ago";

                interval = Math.floor(seconds / 2592000);
                if (interval > 1) return interval + " months ago";
                if (interval === 1) return interval + " month ago";

                interval = Math.floor(seconds / 86400);
                if (interval > 1) return interval + " days ago";
                if (interval === 1) return interval + " day ago";

                interval = Math.floor(seconds / 3600);
                if (interval > 1) return interval + " hours ago";
                if (interval === 1) return interval + " hour ago";

                interval = Math.floor(seconds / 60);
                if (interval > 1) return interval + " minutes ago";
                if (interval === 1) return interval + " minute ago";

                return Math.floor(seconds) + " seconds ago";
            } catch (error) {
                console.error('Error formatting time ago:', error, timestampInput);
                return 'Unknown time';
            }
        }

        // Helper to show a generic notification details modal (for non-order notifications)
        function showNotificationDetailsModal(notification) {
            const modalHTML = `
                <div id="notificationDetailsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0); backdrop-filter: blur(0px); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease, backdrop-filter 0.3s ease;">
                    <div style="background: white; padding: 32px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.15); transform: scale(0.9); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 16px;">
                            <h2 style="margin: 0; color: #1e293b; font-size: 20px;">Notification Details</h2>
                            <button onclick="closeNotificationModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #64748b; line-height: 1;">&times;</button>
                        </div>
                        <p style="color: #1e293b; font-weight: 500; margin-bottom: 12px;">${notification.message}</p>
                        <p style="color: #64748b; font-size: 13px;">${new Date(notification.timestamp).toLocaleString('en-IN')}</p>
                        <div style="margin-top: 24px; text-align: right;">
                            <button onclick="closeNotificationModal()" class="btn btn-secondary">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Trigger animation after modal is in DOM
            setTimeout(() => {
                const modal = document.getElementById('notificationDetailsModal');
                if (modal) {
                    modal.style.opacity = '1';
                    modal.style.background = 'rgba(0,0,0,0.5)';
                    modal.style.backdropFilter = 'blur(5px)';
                    
                    const modalContent = modal.querySelector('div[style*="background: white"]');
                    if (modalContent) {
                        modalContent.style.transform = 'scale(1)';
                        modalContent.style.opacity = '1';
                    }
                }
            }, 10);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Professional Admin Dashboard initialized');

            // Check admin verification first
            if (!checkAdminSession()) {
                // Show verification modal and focus on input
                const modal = document.getElementById('verificationModal');
                if (modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => {
                        const input = document.getElementById('verificationCode');
                        if (input) input.focus();
                    }, 100);
                }
                return; // Don't initialize dashboard until verified
            }

            // Add click event listeners to navigation items
            document.querySelectorAll('.nav-item[onclick]').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Extract section name from onclick attribute
                    const onclickAttr = this.getAttribute('onclick');
                    const match = onclickAttr.match(/showSection\('([^']+)'\)/);
                    if (match) {
                        const sectionName = match[1];
                        showSection(sectionName);

                        // Close sidebar on mobile after navigation
                        if (window.innerWidth <= 768) {
                            const sidebar = document.getElementById('sidebar');
                            sidebar.classList.remove('show');
                        }
                    }
                });
            });

            // Add click outside to close sidebar on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const mobileToggle = document.querySelector('.mobile-toggle');

                    // Close sidebar if clicking outside of it and not on the toggle button
                    if (!sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });

            // Initialize dashboard with authentication
            await initializeAuthenticatedDashboard();

            // Setup permanent scrollbars after content is loaded
            setTimeout(() => {
                setupPermanentScrollbars();
            }, 1000);
        });

        // Initialize dashboard with authentication
        async function initializeAuthenticatedDashboard() {
            try {
                console.log('🔄 Initializing admin dashboard...');

                // Try authentication first
                const authSuccess = await initializeAdminAuth();

                if (authSuccess) {
                    console.log('✅ Authentication successful - loading data with authenticated access');
                } else {
                    console.log('⚠️ Authentication failed - proceeding with unauthenticated access (rules allow this)');
                }

                // Load all dashboard data (works with or without authentication due to updated rules)
                console.log('📋 Loading orders from Firestore...');
                await loadOrders();

                console.log('👥 Loading customers from Firestore...');
                await loadCustomers();

                console.log('📦 Loading inventory data...');
                await loadInventoryData();

                console.log('🔔 Loading notifications...');
                await loadNotifications();

                console.log('✅ Dashboard initialization complete');

                // Update all displays
                updateOrdersDisplay();
                updateNewOrdersDisplay();
                updateCustomersDisplay();
                updateNotificationDisplay();

            } catch (error) {
                console.error('❌ Critical error during dashboard initialization:', error);

                // Initialize empty state to prevent crashes
                allOrders = [];
                newOrders = [];
                confirmedOrders = [];
                cancelledOrders = [];
                allCustomers = [];

                // Still try to load inventory and notifications (these should work independently)
                try {
                    await loadInventoryData();
                    await loadNotifications();
                } catch (fallbackError) {
                    console.error('❌ Even fallback loading failed:', fallbackError);
                }

                // Update displays with empty state
                updateOrdersDisplay();
                updateNewOrdersDisplay();
                updateCustomersDisplay();
                updateNotificationDisplay();

                console.log('📊 Dashboard showing empty state due to initialization errors');
            }
        }

        // Ensure permanent scrollbars without top indicators
        function setupPermanentScrollbars() {
            const tableContainers = document.querySelectorAll('.table-container');

            tableContainers.forEach(container => {
                // Force scrollbar visibility
                container.style.setProperty('overflow-x', 'scroll', 'important');
                container.style.setProperty('scrollbar-width', 'auto', 'important');
                container.style.setProperty('-webkit-overflow-scrolling', 'touch', 'important');

                // Force scrollbar to remain visible by adding periodic interaction
                setInterval(() => {
                    if (container.scrollWidth > container.clientWidth) {
                        // Trigger a minimal scroll to keep scrollbar active
                        const currentScroll = container.scrollLeft;
                        container.scrollLeft = currentScroll + 0.1;
                        container.scrollLeft = currentScroll;
                    }
                }, 2000);
            });
        }

        // Set session flag for products admin panel
        function setProductsAdminSession() {
            sessionStorage.setItem('fromAdminPanel', 'true');
        }

        // Verify the entered code
        function verifyCode() {
            const enteredCode = document.getElementById('verificationCode').value;
            const errorDiv = document.getElementById('verificationError');
            
            if (enteredCode === ADMIN_CODE) {
                // Save session
                localStorage.setItem(SESSION_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    verified: true
                }));
                
                // Hide modal and show admin panel
                document.getElementById('verificationModal').style.display = 'none';
                
                // Show success message briefly
                showSuccessMessage();
            } else {
                // Show error
                errorDiv.style.display = 'block';
                document.getElementById('verificationCode').value = '';
                document.getElementById('verificationCode').style.borderColor = '#dc2626';
                document.getElementById('verificationCode').focus();
                
                // Reset border color after 2 seconds
                setTimeout(() => {
                    document.getElementById('verificationCode').style.borderColor = '#e2e8f0';
                    errorDiv.style.display = 'none';
                }, 2000);
            }
        }

        // Handle code input (auto-format and limit to 4 digits)
        function handleCodeInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '').substring(0, 4);
            
            // Auto-verify when 4 digits are entered
            if (input.value.length === 4) {
                setTimeout(() => verifyCode(), 200);
            }
        }

        // Handle enter key
        function handleCodeKeydown(event) {
            if (event.key === 'Enter') {
                verifyCode();
            }
        }

        // Open products admin with session flag
        function openProductsAdmin() {
            // Set session flag to indicate user is coming from verified admin panel
            sessionStorage.setItem('fromAdminPanel', 'true');
            sessionStorage.setItem('adminVerified', 'true');
            sessionStorage.setItem('adminVerifyTime', Date.now().toString());

            // Open products admin panel
            window.open('products-admin-panel.html', '_blank');
        }


        /* Shiprocket Integration Functions - TEMPORARILY COMMENTED OUT
        async function createShipment(orderId, userId) {
            try {
                console.log('Creating shipment for order:', orderId);

                // Find the order in our data
                const order = allOrders.find(o => o.orderId === orderId && o.userId === userId);
                if (!order) {
                    alert('Order not found');
                    return;
                }

                // Show loading state
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

                // Enhanced address parsing function
                function parseCustomerAddress(address, customerData) {
                    console.log('Parsing address:', address);

                    // Initialize with defaults
                    let parsedData = {
                        address: address || 'Address not provided',
                        city: 'Mumbai',
                        state: 'Maharashtra',
                        pinCode: '400001' // Default Mumbai pincode
                    };

                    if (address) {
                        // Look for pincode patterns (6 digits)
                        const pinMatch = address.match(/\b(\d{6})\b/);
                        if (pinMatch) {
                            parsedData.pinCode = pinMatch[1];
                        }

                        // Split by comma and try to extract city/state
                        const parts = address.split(',').map(part => part.trim());
                        if (parts.length >= 2) {
                            // Last part often contains pincode and state
                            const lastPart = parts[parts.length - 1];
                            const secondLastPart = parts[parts.length - 2];

                            // Check if last part contains state names
                            const stateNames = ['Maharashtra', 'Delhi', 'Karnataka', 'Tamil Nadu', 'Gujarat', 'West Bengal', 'Rajasthan', 'Uttar Pradesh', 'Madhya Pradesh', 'Haryana', 'Punjab', 'Kerala', 'Andhra Pradesh', 'Telangana', 'Odisha', 'Jharkhand', 'Assam', 'Chhattisgarh', 'Himachal Pradesh', 'Uttarakhand', 'Goa', 'Tripura', 'Meghalaya', 'Manipur', 'Nagaland', 'Arunachal Pradesh', 'Mizoram', 'Sikkim'];

                            for (const state of stateNames) {
                                if (lastPart.toLowerCase().includes(state.toLowerCase())) {
                                    parsedData.state = state;
                                    if (secondLastPart && !secondLastPart.match(/\d{6}/)) {
                                        parsedData.city = secondLastPart;
                                    }
                                    break;
                                }
                            }

                            // If no state found, assume second last is city
                            if (parsedData.state === 'Maharashtra' && secondLastPart) {
                                parsedData.city = secondLastPart;
                            }
                        }
                    }

                    console.log('Parsed address data:', parsedData);
                    return parsedData;
                }

                // Parse customer address
                const addressData = parseCustomerAddress(order.customerAddress);

                // Clean and validate phone number
                const cleanPhone = (order.customerPhone || '').replace(/[^0-9]/g, '');
                const validPhone = cleanPhone.length >= 10 ? cleanPhone.slice(-10) : '9999999999';

                // Prepare shipment data with proper validation
                const shipmentData = {
                    order_id: order.orderReference || order.orderId,
                    order_date: order.date.toISOString().split('T')[0],
                    customer: {
                        firstName: order.customerName.split(' ')[0] || 'Customer',
                        lastName: order.customerName.split(' ').slice(1).join(' ') || 'Name',
                        email: order.customerEmail || 'customer@example.com',
                        phone: validPhone,
                        address: addressData.address,
                        city: addressData.city,
                        state: addressData.state,
                        pinCode: addressData.pinCode
                    },
                    items: order.products.map(product => ({
                        id: product.id || product.productId || `item-${Math.random().toString(36).substr(2, 9)}`,
                        name: product.name || product.productName || 'Product',
                        price: parseFloat(product.price) || 100,
                        quantity: parseInt(product.quantity) || 1
                    })),
                    total: parseFloat(order.amount) || 100,
                    payment_method: order.paymentMethod === 'Cash on Delivery' ? 'COD' : 'Prepaid'
                };

                console.log('Sending shipment data:', shipmentData);

                try {
                    const response = await fetch('/.netlify/functions/shiprocket-create-order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(shipmentData)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('Shipment creation result:', result);

                    if (result.success && result.data) {
                        const shipmentData = result.data;
                        let successMessage = `✅ Shipment created successfully!\n`;
                        successMessage += `📋 Shipment ID: ${shipmentData.shipment_id}\n`;
                        successMessage += `📦 Order ID: ${shipmentData.order_id}\n`;

                        if (shipmentData.awb_code) {
                            successMessage += `🏷️ AWB Code: ${shipmentData.awb_code}\n`;
                        }
                        if (shipmentData.courier_name) {
                            successMessage += `🚚 Courier: ${shipmentData.courier_name}\n`;
                        }
                        if (shipmentData.workflow_completed) {
                            successMessage += `✨ Complete workflow finished automatically!`;
                        } else {
                            successMessage += `⏳ AWB and pickup will be processed automatically.`;
                        }

                        alert(successMessage);

                        // Update order status in the table
                        const orderRow = button.closest('tr');
                        if (orderRow) {
                            const statusCell = orderRow.querySelector('.order-status'); // Ensure this class exists or change selector
                            if (statusCell) {
                                statusCell.innerHTML = '<span class="status-badge shipped">Shipment Created</span>';
                            }
                            // Also update the shipment column if possible
                            const shipmentCell = orderRow.querySelector('td:nth-child(7)'); // Assuming shipment is the 7th column
                            if (shipmentCell) {
                                shipmentCell.innerHTML = `
                                    <div>
                                        <span class="status-badge status-confirmed" style="font-size: 10px;">SHIPPED</span>
                                        <br><small style="color: #64748b;">AWB: ${shipmentData.awb_code || 'N/A'}</small>
                                    </div>
                                `;
                            }
                        }
                    } else {
                        throw new Error(result.error || 'Unknown error occurred');
                    }

                } catch (fetchError) {
                    console.error('Network/API error creating shipment:', fetchError);

                    // Parse the error message to provide better user feedback
                    let errorMessage = fetchError.message;
                    if (errorMessage.includes('Serviceability check failed')) {
                        errorMessage = 'Service not available for the delivery pincode. Please check the customer address.';
                    } else if (errorMessage.includes('Required field missing')) {
                        errorMessage = 'Required shipping information is missing. Please check customer address details.';
                    } else if (errorMessage.includes('Authentication failed')) {
                        errorMessage = 'Shiprocket authentication failed. Please check credentials.';
                    }

                    // Show user-friendly error modal
                    const errorModal = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                            <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
                                <h3 style="color: #dc2626; margin-bottom: 20px;">🚫 Failed to create shipment</h3>
                                <p style="color: #374151; margin-bottom: 20px; line-height: 1.5;">${errorMessage}</p>
                                <div style="margin-bottom: 20px; background: #fef3c7; padding: 15px; border-radius: 8px; color: #92400e; font-size: 14px; text-align: left;">
                                    <strong>Please check:</strong><br>
                                    • Network connection<br>
                                    • Shiprocket credentials<br>
                                    • Order data validity<br>
                                    • Customer address format<br>
                                    • Serviceability to pincode: ${shipmentData.customer.pinCode}
                                </div>
                                <button onclick="this.closest('div').remove()" style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">OK</button>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', errorModal);
                }

            } catch (error) {
                console.error('Critical error creating shipment:', error);
                alert(`❌ Critical error creating shipment: ${error.message}`);
            } finally {
                // Restore button state
                if (button) {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }
        }
        */

        /* TEMPORARILY COMMENTED OUT
        async function trackShipment(awbNumber) {
            try {
                console.log('Tracking shipment:', awbNumber);

                // Show loading state
                const loadingModal = document.createElement('div');
                loadingModal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                `;
                loadingModal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #2563eb; margin-bottom: 15px;"></i>
                        <p style="margin: 0; color: #1e293b;">Tracking shipment...</p>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                // Use the correct Netlify function endpoint
                const response = await fetch(`/.netlify/functions/shiprocket-track-order/${awbNumber}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to track shipment`);
                }

                const result = await response.json();
                console.log('Tracking result:', result);

                // Remove loading modal
                loadingModal.remove();

                if (result.success) {
                    // Open tracking page in new tab
                    window.open('/track-order.html?tracking=' + awbNumber, '_blank');
                } else {
                    throw new Error(result.error || 'Failed to track shipment');
                }

            } catch (error) {
                console.error('Error tracking shipment:', error);

                // Remove loading modal if it exists
                const loadingModal = document.querySelector('[style*="position: fixed"]');
                if (loadingModal) loadingModal.remove();

                // Show user-friendly error
                let errorMessage = error.message;
                if (error.message.includes('HTTP 404')) {
                    errorMessage = 'AWB number not found in tracking system.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error: Please check your internet connection.';
                }

                const errorModal = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; text-align: center;">
                            <h3 style="color: #dc2626; margin-bottom: 15px;">🚫 Tracking Failed</h3>
                            <p style="color: #374151; margin-bottom: 20px;">${errorMessage}</p>
                            <p style="font-size: 14px; color: #64748b; margin-bottom: 20px;">AWB: ${awbNumber}</p>
                            <button onclick="this.closest('div').remove()" style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">OK</button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', errorModal);
            }
        }
        */

        /* BULK ORDER SELECTION FUNCTIONS - TEMPORARILY COMMENTED OUT
        function toggleAllOrderSelection() {
            const selectAllCheckbox = document.getElementById('selectAllOrders');
            const isChecked = selectAllCheckbox.checked;

            // Clear existing selections
            selectedOrderIds.clear();

            // Select/deselect all visible orders
            document.querySelectorAll('#orders-section-tbody tr input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) {
                    // Extract orderId from the parent row's context if possible or from data attribute
                    const orderId = checkbox.closest('tr')?.querySelector('td:nth-child(2) strong')?.textContent.replace('#', '').split('...')[0]?.trim(); // Adjust selector as needed
                    if (orderId) {
                        selectedOrderIds.add(orderId);
                    }
                }
            });
            console.log('Selected Order IDs:', Array.from(selectedOrderIds));
        }

        function toggleOrderSelection(orderId) {
            if (selectedOrderIds.has(orderId)) {
                selectedOrderIds.delete(orderId);
            } else {
                selectedOrderIds.add(orderId);
            }
            console.log('Selected Order IDs:', Array.from(selectedOrderIds));

            // Update select all checkbox if needed
            const selectAllCheckbox = document.getElementById('selectAllOrders');
            if (selectAllCheckbox) {
                const allVisibleOrdersSelected = Array.from(document.querySelectorAll('#orders-section-tbody tr input[type="checkbox"]')).every(cb => cb.checked);
                selectAllCheckbox.checked = allVisibleOrdersSelected;
            }
        }
        */

        /* TEMPORARILY COMMENTED OUT
        async function createShipmentForVisibleOrders() {
            if (selectedOrderIds.size === 0) {
                alert('Please select at least one order to create shipment for.');
                return;
            }

            if (!confirm(`Create shipments for ${selectedOrderIds.size} selected order(s)?`)) {
                return;
            }

            // Get the currently displayed (filtered and searched) orders
            let currentlyDisplayedOrders = [];
            if (searchTerm) {
                currentlyDisplayedOrders = filteredOrders;
            } else {
                currentlyDisplayedOrders = allOrders; // Default to all orders if no search
                if (currentOrderFilter !== 'all') {
                    // Re-apply filter if necessary
                    currentlyDisplayedOrders = currentlyDisplayedOrders.filter(order => {
                        if (currentOrderFilter === 'pending') return order.status === 'pending';
                        if (currentOrderFilter === 'confirmed') return order.status === 'confirmed';
                        if (currentOrderFilter === 'cancelled') return order.status === 'cancelled';
                        return true;
                    });
                }
            }

            let shipmentsCreated = 0;
            let shipmentsFailed = 0;

            for (const orderId of selectedOrderIds) {
                // Find the order details from the currently displayed orders
                const orderToShip = currentlyDisplayedOrders.find(o => o.orderId === orderId);
                if (!orderToShip) {
                    console.warn(`Order ${orderId} not found in current display, skipping.`);
                    shipmentsFailed++;
                    continue;
                }

                try {
                    // Call the createShipment function for each selected order
                    await createShipment(orderToShip.orderId, orderToShip.userId);
                    shipmentsCreated++;
                } catch (error) {
                    console.error(`Failed to create shipment for order ${orderId}:`, error);
                    shipmentsFailed++;
                }
            }

            alert(`Shipment creation process completed.\n\nSuccess: ${shipmentsCreated}\nFailed: ${shipmentsFailed}`);

            // Clear selection after process
            selectedOrderIds.clear();
            document.getElementById('selectAllOrders').checked = false;
            updateOrdersSectionDisplay(); // Refresh display to show updated statuses
        }
        */
    </script>
</body>
</html>