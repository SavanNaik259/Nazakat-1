<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>My Profile - Auric - Timeless & Classic Jewellery</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.min.css" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpLGCJKypKP/lLCgB9MlH/lX+/Pvw2DNA" crossorigin="anonymous">
    <!-- Fallback font awesome icons if CDN fails -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Lato:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css?v=1.0.4">
    <link rel="stylesheet" href="css/responsive.css?v=1.0.4">
    <link rel="stylesheet" href="css/navbar.css?v=1.1.3">
    <link rel="stylesheet" href="css/cart.css?v=1.0.2">
    <link rel="stylesheet" href="css/auth.css">

    <!-- Simple Initialization Script -->
    <script>
        // Simple script with no storage dependencies
        (function() {
            console.log('Flag check: No persistence needed');
        })();
    </script>
    <style>
      /* Navigation links in desktop */
      .nav-link {
          color: #000 !important;
      }

      /* Navigation links hover state */
      .nav-link:hover {
          color: #333 !important;
      }

      /* Dropdown arrow icons */
      .dropdown-toggle i {
          color: #000 !important;
      }

      /* Mobile menu close button */
      .meenu-close {
          color: #000 !important;
      }

      /* Mobile navigation links */
      .mobile-account-link {
          color: #000 !important;
      }

      /* Mobile navigation link text */
      .mobile-account-links .mobile-account-link {
          color: #000 !important;
      }

      /* Navigation icons - all icon images */
      .nav-icons .icon-link img {
          filter: brightness(0) !important;
      }

      /* Hamburger menu icon */
      .hamburger img {
          filter: brightness(0) !important;
      }

      /* Cart and wishlist count badges *
      .cart-count,
      .wishlist-count,
      .mobile-cart-count,
      .mobile-wishlist-count {
          background-color: #000 !important;
          color: #fff !important;
      }

      /* Dropdown menu items */
      .dropdown-menu li a {
          color: #000 !important;
      }

      /* Dropdown menu items hover */
      .dropdown-menu li a:hover {
          color: #333 !important;
          background-color: #f5f5f5 !important;
      }

      /* Mobile menu background text color */
      .nav-menu {
          color: #000 !important;
      }

      /* Ensure all text in mobile menu is black */
      .nav-menu * {
          color: #000 !important;
      }

      /* Mobile account links images */
      .mobile-account-link img {
          filter: brightness(0) !important;
      }

      /* Hide mobile menu close button on large devices */
      @media (min-width: 769px) {
          #closeMenu {
              display: none !important;
          }
      }
      @media (min-width: 769px) {
          .nav-link {
              text-shadow: none !important;
              box-shadow: none !important;
          }

          .nav-link:hover {
              text-shadow: none !important;
              box-shadow: none !important;
          }
      }
      .profile-container {
        max-width: 1000px;
        margin: 200px auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .profile-header {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: #c8a97e;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        color: white;
        font-size: 36px;
      }

      .profile-info h1 {
        font-family: 'Playfair Display', serif;
        font-size: 28px;
        margin: 0 0 5px 0;
      }

      .profile-info p {
        color: #777;
        margin: 0;
      }

      .profile-nav {
        display: flex;
        justify-content: center;
        border-bottom: 1px solid #eee;
        margin-bottom: 30px;
      }

      .profile-nav-item {
        padding: 15px 20px;
        font-family: 'Lato', sans-serif;
        font-weight: 600;
        color: #777;
        cursor: pointer;
      }

      .profile-nav-item.active {
        color: #c8a97e;
        border-bottom: 2px solid #c8a97e;
      }

      .profile-section {
        display: none;
      }

      .profile-section.active {
        display: block;
      }

      .order-card {
        border: 1px solid #eee;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .order-header {
        display: flex;
        justify-content: space-between;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
      }

      .order-id {
        font-weight: bold;
      }

      .order-date {
        color: #777;
      }

      .order-item {
        display: flex;
        padding: 10px 0;
      }

      .order-item-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        margin-right: 15px;
      }

      .order-item-details h4 {
        margin: 0 0 5px 0;
      }

      .order-item-price {
        color: #c8a97e;
        font-weight: bold;
      }

      .order-item-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-top: 5px;
      }

      .order-item-quantity {
        color: #777;
        font-size: 0.9em;
        background-color: #f5f5f5;
        padding: 2px 8px;
        border-radius: 12px;
      }

      .order-total {
        text-align: right;
        font-weight: bold;
        padding-top: 10px;
        border-top: 1px solid #eee;
        margin-top: 10px;
      }

      .address-card {
        border: 1px solid #eee;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .address-header {
        display: flex;
        justify-content: space-between;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
      }

      .address-title {
        font-weight: bold;
      }

      .address-actions a {
        color: #c8a97e;
        text-decoration: none;
        margin-left: 10px;
      }

      .logout-button {
        background-color: #c8a97e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        font-family: 'Lato', sans-serif;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-top: 20px;
      }

      .logout-button:hover {
        background-color: #b39063;
      }

      .error-message {
        background-color: #fdecea;
        color: #e74c3c;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        text-align: center;
        border: 1px solid #f5c6cb;
      }

      .empty-section-message {
        text-align: center;
        color: #777;
        margin: 30px 0;
        font-style: italic;
      }

      .shop-now-button {
        display: inline-block;
        background-color: #c8a97e;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        text-decoration: none;
        margin-top: 15px;
        transition: background-color 0.3s ease;
      }

      .shop-now-button:hover {
        background-color: #b39063;
        color: white;
        text-decoration: none;
      }

      .avatar-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }

      /* Address Management Styles */
      .address-card {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        transition: box-shadow 0.3s ease;
      }

      .address-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .address-card.default-address {
        border-color: #c8a97e;
        background-color: #fefcf8;
      }

      .address-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .address-title {
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
      }

      .default-badge {
        background-color: #c8a97e;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 10px;
      }

      .address-actions {
        display: flex;
        gap: 15px;
      }

      .address-actions a {
        color: #c8a97e;
        text-decoration: none;
        font-size: 14px;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .address-actions a:hover {
        color: #b39063;
        text-decoration: underline;
      }

      .address-content {
        color: #555;
        line-height: 1.6;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .modal-overlay.show {
        display: flex;
      }

      .address-modal {
        background: white;
        border-radius: 8px;
        padding: 30px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 10000;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .modal-header h3 {
        margin: 0;
        color: #333;
        font-family: 'Playfair Display', serif;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        transition: color 0.3s ease;
      }

      .close-modal:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 25px;
        position: relative;
        z-index: 1;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        position: relative;
        z-index: 1;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        position: relative;
        z-index: 1;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #c8a97e;
      }

      .form-row {
        display: flex;
        gap: 15px;
      }

      .form-row .form-group {
        flex: 1;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        margin-top: 20px;
      }

      .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
      }

      .modal-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: flex-end;
        position: relative;
        z-index: 10003;
      }

      .btn-secondary {
        background-color: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .btn-secondary:hover {
        background-color: #e9ecef;
      }

      .btn-primary {
        background-color: #c8a97e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .btn-primary:hover {
        background-color: #b39063;
      }

      .btn-primary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #c8a97e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
        <!-- Promo Banner -->
        <div class="promo-banner">
            <button class="banner-arrow banner-prev">
                <i class="fas fa-chevron-left"></i>
            </button>
            <p>Save 21% on exclusive selections - <a href="#">Shop Now</a></p>
            <button class="banner-arrow banner-next">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <!-- New Responsive Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <!-- Logo -->
                <a href="index.html" class="brand">
                    <img src="images/logos/IMG_20250801_204447.jpg" alt="Nazakat" class="brand-logo">
                </a>

                <!-- Mobile Toggle Button -->
                <div class="hamburger" id="navToggle"><img src="images/icons/bars-staggered (2).png" alt="SP Jewellers"style="width: 25px; height: 25px;">
                </div>
              <!--  <div class="hamburger" id="navToggle">
                    <i class="fas fa-bars"></i>
                </div>-->

                <!-- Navigation Links -->
                <div class="nav-menu" id="navMenu">
                    <!-- Close button for mobile menu in the top right corner -->
                    <i id="closeMenu" class="fa-solid fa-xmark meenu-close" onclick="closeMobileMenu()" style="font-size: 24px; margin-left: 90%; color: #333;" ></i>

                    <ul class="nav-list">
                        <li class="nav-item"><a href="new-arrivals.html" class="nav-link">New Arrivals</a></li>
                        <li class="nav-item dropdown">
                            <a href="#" class="nav-link dropdown-toggle">Collections <i class="fas fa-chevron-down"></i></a>
                            <ul class="dropdown-menu">
                                <li><a href="shop.html">All Collection</a></li>
                                <li><a href="featured-collection.html">Featured Collection</a></li>
                                <li><a href="saree-collection.html">Saree Collection</a></li>
                            </ul>
                        </li>
                        <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
                        <li class="nav-item"><a href="index.html#customer-reviews" class="nav-link">Testimonials</a></li>
                        <li class="nav-item"><a href="order-track.html" class="nav-link">Order Track</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">Contact</a></li>
                    </ul>

                    <!-- Mobile account links in separate div after Contact -->
                    <div class="mobile-account-links mobile-special">
                        <a href="#" class="mobile-account-link">
                            <img src="images/icons/user.png" alt="Cart" style="width: 18px; height: 18px;">  &nbsp; Account
                        </a>
                        <a href="#" class="mobile-account-link wishlist-toggle">
                            <img src="images/icons/heart.png" alt="Cart" style="width: 18px; height: 18px;"> &nbsp;   Wishlist (<span class="mobile-wishlist-count">0</span>)
                        </a>
                        <a href="#" class="mobile-account-link mobile-cart-toggle">
                            <img src="images/icons/cart-minus.png" alt="Cart" style="width:18px; height: 18px; vertical-align: middle;">  &nbsp; Shopping Bag (<span class="mobile-cart-count">0</span>)
                        </a>
                    </div>
                </div>

                <!-- Navigation Icons -->
                <div class="nav-icons">
                    <a href="#" class="icon-link search-icon">
                        <img src="images/icons/search.png" alt="Search" style="width: 20px; height: 20px;">
                    </a>
                    <a href="login.html" class="icon-link account-icon" id="user-icon">
                        <img src="images/icons/user.png" alt="User" style="width: 25px; height: 25px;">
                    </a>
                    <a href="#" class="icon-link wishlist-icon-container wishlist-toggle">
                        <img src="images/icons/heart.png" alt="Wishlist" style="width: 20px; height: 20px;">
                        <div class="wishlist-count">0</div>
                    </a>
                    <a href="#" class="icon-link cart-icon-container cart-toggle" id="cartToggleButton">
                        <img src="images/icons/cart-minus.png" alt="Cart" style="width: 20px; height: 20px;">
                        <div class="cart-count">0</div>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Overlay for menu background -->
    <div class="menu-overlay" id="menuOverlay"></div>

    <!-- Hero Section with Slider -->
    <!-- Profile Section -->
    <section class="profile-container">
        <!-- Error message container -->
        <div id="error-message" class="error-message" style="display: none; margin-bottom: 20px; text-align: center; color: #e74c3c; padding: 10px; border-radius: 4px; background-color: #fdecea;"></div>

        <div class="profile-header">
            <div class="profile-avatar" id="profileAvatar">A</div>
            <div class="profile-info">
                <h1 id="profileName">Loading...</h1>
                <p id="profileEmail">Loading...</p>
            </div>
        </div>

        <div class="profile-nav">
            <div class="profile-nav-item active" data-target="orders">My Orders</div>
            <div class="profile-nav-item" data-target="addresses">Addresses</div>
            <div class="profile-nav-item" data-target="settings">Account Settings</div>
        </div>

        <div class="profile-section active" id="orders">
            <h2>My Orders</h2>
            <div class="loading-message" style="text-align: center; color: #777; margin: 30px 0;">
                Loading your orders...
            </div>
        </div>

        <div class="profile-section" id="addresses">
            <h2>My Addresses</h2>
            <div id="addresses-container">
                <div class="loading-message" style="text-align: center; color: #777; margin: 30px 0;">
                    Loading your addresses...
                </div>
            </div>
            <button id="add-new-address-btn" class="logout-button" style="background-color: #c8a97e; margin-top: 20px;">
                <i class="fas fa-plus"></i> Add New Address
            </button>
        </div>



        <div class="profile-section" id="settings">
            <h2>Account Settings</h2>
            <button id="logout-button" class="logout-button">Log Out</button>
        </div>
    </section>

  <!-- Footer Toggle Script -->
    <script src="js/footer-toggle.js"></script>

<!-- Minimalist Collapsible Footer -->
    <footer class="footer-minimalist">
        <div class="container">
            <!-- Info Section -->
            <div class="footer-section">
                <button class="footer-toggle" data-section="info-content">
                    <span class="footer-title">Info</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="footer-content" id="info-content">
                    <ul>
                        <li><a href="#">Our Story</a></li>
                        <li><a href="#">Shipping Policy</a></li>
                        <li><a href="#">Returns & Exchanges</a></li>
                        <li><a href="#">Size Guide</a></li>
                        <li><a href="#">Care Instructions</a></li>
                        <li><a href="#">Terms and Conditions</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>

            <!-- Categories Section -->
            <div class="footer-section">
                <button class="footer-toggle" data-section="categories-content">
                    <span class="footer-title">Categories</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="footer-content" id="categories-content">
                    <ul>
                        <li><a href="#">Saree</a></li>
                        <li><a href="#">Lehenga</a></li>
                        <li><a href="#">Suit</a></li>
                    </ul>
                </div>
            </div>

            <!-- Collection Section -->
            <div class="footer-section">
                <button class="footer-toggle" data-section="collection-content">
                    <span class="footer-title">Collection</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="footer-content" id="collection-content">
                    <ul>

                        <li><a href="#">New Arrivals</a></li>
                        <li><a href="#">Saree Collection</a></li>
                        <li><a href="#">Featured Collection</a></li>
                    </ul>
                </div>
            </div>

            <!-- Exclusive Benefits Section -->
            <div class="footer-section">
                <button class="footer-toggle" data-section="benefits-content">
                    <span class="footer-title">Exclusive benefits</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="footer-content" id="benefits-content">
                    <ul>
                        <li><a href="#">VIP Customer Program</a></li>
                        <li><a href="#">Free Shipping</a></li>
                        <li><a href="#">30-Day Returns</a></li>
                        <li><a href="#">Lifetime Warranty</a></li>
                        <li><a href="#">Personal Styling</a></li>
                        <li><a href="#">Early Access</a></li>
                        <li><a href="#">Member Discounts</a></li>
                    </ul>
                </div>
            </div>
        <div class="footer-bottom">
            <div class="container">
                <div class="footer-info">
                    <div class="copyright">
                        <p>&copy; 2025 SP Jewellers. All rights reserved. | Developed by <a href="https://savannaik.netlify.app/" target="_blank" style="color: #9c7c38; text-decoration: none; font-weight: 500;">Savan Naik</a></p>
                    </div>

                    <div class="footer-links">
                        <a href="terms-conditions.html">Terms and Conditions</a>
                        <a href="privacy-policy.html">Privacy Policy</a>
                    </div>

                    <div class="payment-methods">
                        <span><i class="fab fa-cc-amex"></i></span>
                       <!-- <span><i class="fab fa-apple-pay"></i></span>
                        <span><i class="fab fa-cc-diners-club"></i></span>-->
                        <span><i class="fab fa-cc-discover"></i></span>
                        <span><i class="fab fa-google-pay"></i></span>
                        <span><i class="fab fa-cc-mastercard"></i></span>
                        <span><i class="fab fa-cc-paypal"></i></span>
                        <span class="union-pay">UP</span>
                        <span><i class="fab fa-cc-visa"></i></span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Navigation script -->
    <script src="js/navigation.js?v=1.0.4"></script>
    <script src="js/banner-rotator.js?v=1.0.1"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCrLCButDevLeILcBjrUCd9e7amXVjW-uI",
        authDomain: "auric-a0c92.firebaseapp.com",
        projectId: "auric-a0c92",
        storageBucket: "auric-a0c92.appspot.com",
        messagingSenderId: "878979958342",
        appId: "1:878979958342:web:e6092f7522488d21eaec47",
        measurementId: "G-ZYZ750JHMB"
      };
    </script>

    <!-- Firebase Initialization Module -->
    <script src="js/firebase/firebase-init.js"></script>

    <!-- Firebase Auth Global Module -->
    <script src="js/firebase/firebase-auth.js"></script>

    <!-- Firebase Orders Module -->
    <script src="js/firebase/firebase-orders.js"></script>

    <!-- Firebase Address Manager -->
    <script src="js/firebase/firebase-address-manager.js"></script>

    <!-- Cart System -->
    <script src="js/cart-local-storage.js?v=1.0.0"></script>
    <script src="js/firebase/firebase-cart-manager.js?v=1.0.0"></script>
    <script src="js/cart-manager.js?v=1.0.1"></script>

    <!-- Wishlist Scripts -->
    <script src="js/wishlist-local-storage.js?v=1.0.0"></script>
    <script src="js/firebase/firebase-wishlist-manager.js?v=1.0.0"></script>
    <script src="js/wishlist-manager.js?v=1.0.0"></script>
    <script src="js/main.js"></script>

    <!-- Profile Script -->
    <script>

      // DOM elements for profile sections
      const profileName = document.getElementById('profileName');
      const profileEmail = document.getElementById('profileEmail');
      const profileAvatar = document.getElementById('profileAvatar');

      // Main initialization
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize Firebase first
        setTimeout(() => {
          initializeProfile();
        }, 100);
      });

      function initializeProfile() {
        // Check if Firebase is properly initialized
        if (!window.firebase) {
          console.error('Firebase not loaded');
          showError('Failed to initialize. Please refresh the page.');
          return;
        }

        // Wait for Firebase auth to be ready with timeout handling
        const authStateTimeout = setTimeout(() => {
          console.warn("Firebase auth state taking too long, checking session");
          const session = FirebaseAuth && FirebaseAuth.getSession();
          if (session && session.uid && session.loggedIn) {
            console.log("Using session data as fallback");
            loadUserProfileFromSession(session);
            setupProfilePage();
          } else {
            showError('Connection timeout. Please check your internet connection and try again.');
            addRetryButton();
          }
        }, 10000); // 10 second timeout

        firebase.auth().onAuthStateChanged((user) => {
          clearTimeout(authStateTimeout);
          if (user) {
            console.log("Auth state: user is signed in:", user.uid);
            loadUserProfile(user);
            setupProfilePage();
          } else {
            console.log("Auth state: user is signed out");
            // Check session as fallback
            const session = FirebaseAuth && FirebaseAuth.getSession();
            if (session && session.uid && session.loggedIn) {
              console.log("Found user in session, attempting to restore auth");
              // Try to restore auth state or redirect to login
              setTimeout(() => {
                if (!firebase.auth().currentUser) {
                  window.location.href = "login.html";
                }
              }, 1000);
            } else {
              console.log("No authenticated user found, redirecting to login");
              window.location.href = "login.html";
            }
          }
        });
      }

      // Load user profile from session data (offline fallback)
      function loadUserProfileFromSession(session) {
        console.log("Loading profile from session data:", session);

        // Display user information from session
        const userData = {
          displayName: session.displayName || session.email?.split('@')[0] || 'User',
          email: session.email || '',
          photoURL: session.photoURL
        };

        displayUserInfo(userData);
        displayEmptyOrdersSection();
        displayUserAddresses([]);

        // Show offline notice
        showError('You are currently offline. Some features may be limited. Orders and settings will sync when connection is restored.');
      }

      // Load user profile data
      async function loadUserProfile(userOrUserId) {
        let userId;
        let currentUser;

        // Handle both user object and string userId
        if (typeof userOrUserId === 'string') {
          userId = userOrUserId;
          currentUser = firebase.auth().currentUser;
        } else if (userOrUserId && userOrUserId.uid) {
          userId = userOrUserId.uid;
          currentUser = userOrUserId;
        } else {
          currentUser = firebase.auth().currentUser;
          if (currentUser) {
            userId = currentUser.uid;
          }
        }

        // If we still don't have a user ID, redirect to login
        if (!userId) {
          console.error("No valid user ID found");
          window.location.href = "login.html";
          return;
        }

        console.log("Loading profile for user:", userId);

        try {
          // Try to get user profile directly from Firestore
          const userDoc = await firebase.firestore().collection("users").doc(userId).get();

          if (userDoc.exists) {
            const userData = userDoc.data();
            console.log("User profile loaded from Firestore:", userData);

            // Display user information
            displayUserInfo(userData);

            // Load user orders
            await loadUserOrders(userId);

            // Display addresses
            displayUserAddresses(userData.addresses || []);
          } else {
            // Profile doesn't exist, create one
            console.log("Creating new user profile in Firestore...");

            if (currentUser) {
              const nameFromEmail = currentUser.email ? currentUser.email.split('@')[0] : '';
              const userData = {
                uid: currentUser.uid,
                email: currentUser.email,
                displayName: currentUser.displayName || nameFromEmail || 'User',
                photoURL: currentUser.photoURL,
                createdAt: firebase.firestore.Timestamp.now(),
                updatedAt: firebase.firestore.Timestamp.now(),
                addresses: [],
                paymentMethods: []
              };

              // Create user profile in Firestore
              await firebase.firestore().collection("users").doc(currentUser.uid).set(userData);

              console.log("Successfully created user profile");
              displayUserInfo(userData);
              displayUserAddresses([]);
              displayEmptyOrdersSection();
            } else {
              console.error("No current user available for profile creation");
              showError("Session error. Please log in again.");
              setTimeout(() => window.location.href = "login.html", 2000);
            }
          }
        } catch (error) {
          console.error("Error loading profile:", error);

          // Handle permission denied errors specifically
          if (error.code === 'permission-denied') {
            console.error("Permission denied - user may not be properly authenticated");
            showError("Access denied. Please log in again.");
            // Clear any stale auth data and redirect
            if (FirebaseAuth && FirebaseAuth.clearSession) {
              FirebaseAuth.clearSession();
            }
            setTimeout(() => window.location.href = "login.html", 2000);
          } else if (error.code === 'unavailable' || error.message?.includes('Backend didn\'t respond')) {
            console.log("Firebase unavailable, attempting to use session data");
            const session = FirebaseAuth && FirebaseAuth.getSession();
            if (session && session.uid && session.loggedIn) {
              loadUserProfileFromSession(session);
              return;
            }
            showError("Connection problem detected. Please check your internet connection.");
            addRetryButton();
          } else {
            showError("Failed to load profile. Please try again.");
            addRetryButton();
          }
        }
      }

      function addRetryButton() {
        const errorMsg = document.getElementById('error-message');
        if (errorMsg && !errorMsg.querySelector('#retry-profile-load')) {
          errorMsg.innerHTML += '<br><button id="retry-profile-load" class="auth-button" style="margin-top:10px; width:auto; padding:5px 10px;">Retry Connection</button>';

          setTimeout(() => {
            const retryBtn = document.getElementById('retry-profile-load');
            if (retryBtn) {
              retryBtn.addEventListener('click', () => {
                errorMsg.style.display = 'none';
                const currentUser = firebase.auth().currentUser;
                if (currentUser) {
                  loadUserProfile(currentUser);
                } else {
                  const session = FirebaseAuth && FirebaseAuth.getSession();
                  if (session && session.uid && session.loggedIn) {
                    loadUserProfileFromSession(session);
                  } else {
                    window.location.reload();
                  }
                }
              });
            }
          }, 100);
        }
      }

      // Display empty orders section
      function displayEmptyOrdersSection() {
        const ordersContainer = document.getElementById('orders');
        if (ordersContainer) {
          ordersContainer.innerHTML = `
            <h2>My Orders</h2>
            <p class="empty-section-message">You haven't placed any orders yet.</p>
            <a href="index.html" class="shop-now-button">Start Shopping</a>
          `;
        }
      }

      // Display user information on the profile page
      function displayUserInfo(profile) {
        // Use email as fallback if no display name, and extract name part from email
        const nameFromEmail = profile.email ? profile.email.split('@')[0] : '';
        const displayName = profile.displayName || nameFromEmail || 'User';

        if (profileName) {
          profileName.textContent = displayName;
        }

        if (profileEmail) {
          profileEmail.textContent = profile.email || '';
        }

        if (profileAvatar) {
          if (profile.photoURL) {
            // If user has a photo URL, display it
            profileAvatar.innerHTML = `<img src="${profile.photoURL}" alt="${displayName}" class="avatar-image">`;
          } else {
            // Show the first letter of their name or email
            profileAvatar.textContent = displayName.charAt(0).toUpperCase();
          }
        }
      }

      // Load and display user orders
      async function loadUserOrders(userId) {
        const ordersContainer = document.getElementById('orders');
        if (!ordersContainer) return;

        // Clear container and add heading
        ordersContainer.innerHTML = '<h2>My Orders</h2>';

        if (!userId) {
          console.error("No user ID provided for loading orders");
          displayEmptyOrdersSection();
          return;
        }

        try {
          // Get orders from Firestore at path: users/{userId}/orders
          const ordersSnapshot = await firebase.firestore()
            .collection("users")
            .doc(userId)
            .collection("orders")
            .orderBy("timestamp", "desc")
            .get();

          if (ordersSnapshot.empty) {
            displayEmptyOrdersSection();
            return;
          }

          const orders = ordersSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));

          console.log(`Loaded ${orders.length} orders for user`);

          // Display each order
          orders.forEach(order => {
            // Format date for display
            let orderDate;
            if (order.timestamp && order.timestamp.seconds) {
              orderDate = new Date(order.timestamp.seconds * 1000);
            } else if (order.timestamp && typeof order.timestamp === 'string') {
              orderDate = new Date(order.timestamp);
            } else if (order.orderDate) {
              orderDate = new Date(order.orderDate);
            } else {
              orderDate = new Date();
            }

            const formattedDate = orderDate.toLocaleDateString('en-US', {
              year: 'numeric', month: 'long', day: 'numeric'
            });

            let orderHTML = `
              <div class="order-card">
                <div class="order-header">
                  <span class="order-id">Order #${order.orderId || order.orderReference || order.id}</span>
                  <span class="order-date">${formattedDate}</span>
                </div>
            `;

            // Add order items
            const items = order.products || order.items || [];
            if (items.length > 0) {
              items.forEach(item => {
                orderHTML += `
                  <div class="order-item">
                    <img src="${item.image || '/images/newarrivals/IMG_20250504_150241.jpg'}" 
                        alt="${item.name || 'Product'}" 
                        class="order-item-image"
                        onerror="this.src='/images/newarrivals/IMG_20250504_150241.jpg';">
                    <div class="order-item-details">
                      <h4>${item.name || 'Product'}</h4>
                      <div class="order-item-info">
                        <span class="order-item-price">₹${parseFloat(item.price || 0).toFixed(2)}</span>
                        ${item.quantity ? `<span class="order-item-quantity">Qty: ${item.quantity}</span>` : ''}
                      </div>
                    </div>
                  </div>
                `;
              });
            }

            // Add order total
            const orderTotal = parseFloat(order.orderTotal || order.total || 0).toFixed(2);
            orderHTML += `
                <div class="order-total">Total: ₹${orderTotal}</div>
              </div>
            `;

            ordersContainer.insertAdjacentHTML('beforeend', orderHTML);
          });

        } catch (error) {
          console.error("Error loading orders:", error);

          if (error.code === 'permission-denied') {
            ordersContainer.innerHTML = `
              <h2>My Orders</h2>
              <p class="error-message">Unable to access order history. Please log in again.</p>
            `;
          } else {
            ordersContainer.innerHTML = `
              <h2>My Orders</h2>
              <p class="error-message">Failed to load orders. Please try again later.</p>
            `;
          }
        }
      }

      // Load and display user addresses from Firestore
      async function loadAndDisplayAddresses() {
        const addressesContainer = document.getElementById('addresses-container');
        if (!addressesContainer) return;

        // Show loading state
        addressesContainer.innerHTML = `
          <div class="loading-message" style="text-align: center; color: #777; margin: 30px 0;">
            <div class="loading-spinner"></div>Loading your addresses...
          </div>
        `;

        try {
          const result = await FirebaseAddressManager.loadUserAddresses();

          if (result.success && result.addresses.length > 0) {
            // Display addresses
            addressesContainer.innerHTML = '';
            result.addresses.forEach(address => {
              const addressHTML = `
                <div class="address-card ${address.isDefault ? 'default-address' : ''}" data-address-id="${address.id}">
                  <div class="address-header">
                    <span class="address-title">
                      ${address.addressType ? address.addressType.charAt(0).toUpperCase() + address.addressType.slice(1) : 'Address'}
                      ${address.isDefault ? '<span class="default-badge">Default</span>' : ''}
                    </span>
                    <div class="address-actions">
                      ${!address.isDefault ? '<a href="#" class="set-default-address" data-address-id="' + address.id + '">Set Default</a>' : ''}
                      <a href="#" class="edit-address" data-address-id="${address.id}">Edit</a>
                      <a href="#" class="delete-address" data-address-id="${address.id}">Delete</a>
                    </div>
                  </div>
                  <div class="address-content">
                    <strong>${address.firstName} ${address.lastName}</strong><br>
                    ${address.houseNumber}, ${address.roadName}<br>
                    ${address.city}, ${address.state} ${address.pinCode}<br>
                    Phone: ${address.phone}
                  </div>
                </div>
              `;
              addressesContainer.insertAdjacentHTML('beforeend', addressHTML);
            });

            // Add event listeners for address actions
            setupAddressActionListeners();
          } else if (result.success && result.addresses.length === 0) {
            addressesContainer.innerHTML = `
              <p class="empty-section-message">You haven't added any addresses yet. Add your first address to make checkout faster!</p>
            `;
          } else {
            addressesContainer.innerHTML = `
              <p class="error-message">Failed to load addresses. Please try again later.</p>
            `;
          }
        } catch (error) {
          console.error('Error loading addresses:', error);
          addressesContainer.innerHTML = `
            <p class="error-message">Failed to load addresses. Please check your connection and try again.</p>
          `;
        }
      }

      // Set up event listeners for address actions
      function setupAddressActionListeners() {
        // Edit address buttons
        document.querySelectorAll('.edit-address').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const addressId = this.dataset.addressId;
            editAddress(addressId);
          });
        });

        // Delete address buttons
        document.querySelectorAll('.delete-address').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const addressId = this.dataset.addressId;
            deleteAddress(addressId);
          });
        });

        // Set default address buttons
        document.querySelectorAll('.set-default-address').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const addressId = this.dataset.addressId;
            setDefaultAddress(addressId);
          });
        });
      }

      // Display user addresses (legacy function for compatibility)
      function displayUserAddresses(addresses) {
        // This function is kept for compatibility but addresses are now loaded differently
        console.log('displayUserAddresses called with:', addresses);
        loadAndDisplayAddresses();
      }



      // Set up profile page functionality
      function setupProfilePage() {
        // Profile navigation tabs
        const profileNavItems = document.querySelectorAll('.profile-nav-item');
        const profileSections = document.querySelectorAll('.profile-section');

        profileNavItems.forEach(item => {
          item.addEventListener('click', function() {
            // Remove active class from all items
            profileNavItems.forEach(navItem => navItem.classList.remove('active'));
            profileSections.forEach(section => section.classList.remove('active'));

            // Add active class to clicked item
            this.classList.add('active');

            // Show corresponding section
            const targetSection = document.getElementById(this.dataset.target);
            if (targetSection) {
              targetSection.classList.add('active');

              // Load addresses when addresses section is shown
              if (this.dataset.target === 'addresses') {
                loadAndDisplayAddresses();
              }
            }
          });
        });

        // Logout functionality
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
          logoutButton.addEventListener('click', logoutUser);
        }

        // Add new address button
        const addNewAddressBtn = document.getElementById('add-new-address-btn');
        if (addNewAddressBtn) {
          addNewAddressBtn.addEventListener('click', function() {
            openAddressModal();
          });
        }

        // Address form submission
        const addressForm = document.getElementById('address-form');
        if (addressForm) {
          addressForm.addEventListener('submit', handleAddressFormSubmit);
        }

        // Load addresses initially if addresses section is active
        const addressesSection = document.getElementById('addresses');
        if (addressesSection && addressesSection.classList.contains('active')) {
          loadAndDisplayAddresses();
        }
      }

      // Global variable to track if we're editing an address
      let editingAddressId = null;

      // Open address modal for adding new address
      function openAddressModal(addressData = null) {
        const modal = document.getElementById('address-modal');
        const modalTitle = document.getElementById('modal-title');
        const saveBtnText = document.getElementById('save-btn-text');

        // Set up validation when modal opens
        setTimeout(() => {
          setupAddressFormValidation();
        }, 100);

        if (addressData) {
          // Editing existing address
          editingAddressId = addressData.id;
          modalTitle.textContent = 'Edit Address';
          saveBtnText.textContent = 'Update Address';

          // Populate form with existing data
          document.getElementById('modal-firstName').value = addressData.firstName || '';
          document.getElementById('modal-lastName').value = addressData.lastName || '';
          document.getElementById('modal-email').value = addressData.email || '';
          document.getElementById('modal-phone').value = addressData.phone || '';
          document.getElementById('modal-houseNumber').value = addressData.houseNumber || '';
          document.getElementById('modal-roadName').value = addressData.roadName || '';
          document.getElementById('modal-city').value = addressData.city || '';
          document.getElementById('modal-state').value = addressData.state || '';
          document.getElementById('modal-pinCode').value = addressData.pinCode || '';
          document.getElementById('modal-addressType').value = addressData.addressType || 'home';
          document.getElementById('modal-isDefault').checked = addressData.isDefault || false;
        } else {
          // Adding new address
          editingAddressId = null;
          modalTitle.textContent = 'Add New Address';
          saveBtnText.textContent = 'Save Address';

          // Clear form
          document.getElementById('address-form').reset();

          // Pre-fill email from user profile
          const profileEmail = document.getElementById('profileEmail');
          if (profileEmail) {
            document.getElementById('modal-email').value = profileEmail.textContent;
          }
        }

        modal.classList.add('show');
      }

      // Close address modal
      function closeAddressModal() {
        const modal = document.getElementById('address-modal');
        modal.classList.remove('show');
        editingAddressId = null;
        document.getElementById('address-form').reset();
      }

      // Set up real-time validation for address form
      function setupAddressFormValidation() {
        const form = document.getElementById('address-form');
        if (!form) return;

        // Add event listeners for real-time validation
        const fields = [
          { id: 'modal-firstName', validator: validateFirstName },
          { id: 'modal-lastName', validator: validateLastName },
          { id: 'modal-email', validator: validateEmail },
          { id: 'modal-phone', validator: validatePhone },
          { id: 'modal-pinCode', validator: validatePinCode },
          { id: 'modal-houseNumber', validator: validateHouseNumber },
          { id: 'modal-roadName', validator: validateRoadName },
          { id: 'modal-city', validator: validateCity },
          { id: 'modal-state', validator: validateState }
        ];

        fields.forEach(field => {
          const input = document.getElementById(field.id);
          if (input) {
            input.addEventListener('blur', () => field.validator(input));
            input.addEventListener('input', () => {
              // Clear error state on typing
              clearFieldError(input);
            });
          }
        });
      }

      // Validation functions
      function validateFirstName(input) {
        const value = input.value.trim();
        if (value.length < 2) {
          showFieldError(input, 'First name must be at least 2 characters long');
          return false;
        }
        clearFieldError(input);
        return true;
      }

      function validateLastName(input) {
        const value = input.value.trim();
        if (value.length < 2) {
          showFieldError(input, 'Last name must be at least 2 characters long');
          return false;
        }
        clearFieldError(input);
        return true;
      }

      function validateEmail(input) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(input.value)) {
          showFieldError(input, 'Please enter a valid email address');
          return false;
        }
        clearFieldError(input);
        return true;
      }

      function validatePhone(input) {
        const phoneRegex = /^\d{10}$/;
        const phoneNumber = input.value.replace(/\D/g, '');
        if (!phoneRegex.test(phoneNumber)) {
          showFieldError(input, 'Please enter a valid 10-digit phone number');
          return false;
        }
        clearFieldError(input);
        return true;
      }

      function validatePinCode(input) {
        const pinCodeRegex = /^\d{6}$/;
        if (!pinCodeRegex.test(input.value)) {
          showFieldError(input, 'Please enter a valid 6-digit PIN code');
          return false;
        }
        clearFieldError(input);
        return true;
      }

      function validateHouseNumber(input) {
        const value = input.value.trim();
        if (value.length < 1) {
          showFieldError(input, 'House/Building number is required');
          return false;
        }
        
        // Check for invalid patterns
        if (/^0+$/.test(value)) {
          showFieldError(input, 'Please enter a valid house/building number (cannot be all zeros)');
          return false;
        }
        
        // Check for minimum meaningful length
        if (value.length < 1 || (value.length === 1 && value === '0')) {
          showFieldError(input, 'Please enter a valid house/building number');
          return false;
        }
        
        // Check for valid characters (alphanumeric, dash, slash, space allowed)
        if (!/^[a-zA-Z0-9\-\/\s]+$/.test(value)) {
          showFieldError(input, 'House/Building number can only contain letters, numbers, hyphens, slashes, and spaces');
          return false;
        }
        
        clearFieldError(input);
        return true;
      }

      function validateRoadName(input) {
        const value = input.value.trim();
        if (value.length < 5) {
          showFieldError(input, 'Road name/Area must be at least 5 characters long');
          return false;
        }
        clearFieldError(input);
        return true;
      }

      function validateCity(input) {
        const value = input.value.trim();
        if (value.length < 2) {
          showFieldError(input, 'City name must be at least 2 characters long');
          return false;
        }
        clearFieldError(input);
        return true;
      }

      function validateState(input) {
        const value = input.value.trim();
        if (value === "") { // Check if a state is selected
          showFieldError(input, 'Please select a State');
          return false;
        }
        clearFieldError(input);
        return true;
      }

      // Helper functions for error display
      function showFieldError(input, message) {
        const errorId = input.id.replace('modal-', '') + '-error';
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add('show');
          
          // Auto hide after 8 seconds
          setTimeout(() => {
            errorElement.classList.remove('show');
          }, 8000);
        }
        input.classList.add('error');
        input.classList.remove('valid');
      }

      function clearFieldError(input) {
        const errorId = input.id.replace('modal-', '') + '-error';
        const errorElement = document.getElementById(errorId);
        if (errorElement) {
          errorElement.classList.remove('show');
        }
        input.classList.remove('error');
        input.classList.add('valid');
      }

      // Validate entire form
      function validateAddressForm() {
        const fields = [
          document.getElementById('modal-firstName'),
          document.getElementById('modal-lastName'),
          document.getElementById('modal-email'),
          document.getElementById('modal-phone'),
          document.getElementById('modal-pinCode'),
          document.getElementById('modal-houseNumber'),
          document.getElementById('modal-roadName'),
          document.getElementById('modal-city'),
          document.getElementById('modal-state')
        ];

        const validators = [
          validateFirstName,
          validateLastName,
          validateEmail,
          validatePhone,
          validatePinCode,
          validateHouseNumber,
          validateRoadName,
          validateCity,
          validateState
        ];

        let isValid = true;
        fields.forEach((field, index) => {
          if (field && !validators[index](field)) {
            isValid = false;
          }
        });

        return isValid;
      }

      // Handle address form submission
      async function handleAddressFormSubmit(e) {
        e.preventDefault();

        // Validate form first
        if (!validateAddressForm()) {
          showNotification('Please fix the errors in the form before submitting', 'error');
          return;
        }

        const saveBtn = document.getElementById('save-address-btn');
        const saveBtnText = document.getElementById('save-btn-text');
        const originalText = saveBtnText.textContent;

        // Show loading state
        saveBtn.disabled = true;
        saveBtnText.innerHTML = '<div class="loading-spinner"></div>Saving...';

        try {
          // Get form data
          const formData = new FormData(e.target);
          const addressData = {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            houseNumber: formData.get('houseNumber'),
            roadName: formData.get('roadName'),
            city: formData.get('city'),
            state: formData.get('state'),
            pinCode: formData.get('pinCode'),
            addressType: formData.get('addressType'),
            isDefault: formData.get('isDefault') === 'on'
          };

          let result;
          if (editingAddressId) {
            // Update existing address
            result = await FirebaseAddressManager.updateAddress(editingAddressId, addressData);
          } else {
            // Save new address
            result = await FirebaseAddressManager.saveAddress(addressData);
          }

          if (result.success) {
            showNotification(editingAddressId ? 'Address updated successfully!' : 'Address saved successfully!', 'success');
            closeAddressModal();
            loadAndDisplayAddresses();
          } else {
            showNotification('Failed to save address: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error saving address:', error);
          showNotification('An error occurred while saving the address', 'error');
        } finally {
          // Reset button state
          saveBtn.disabled = false;
          saveBtnText.textContent = originalText;
        }
      }

      // Edit address function
      async function editAddress(addressId) {
        try {
          const result = await FirebaseAddressManager.loadUserAddresses();
          if (result.success) {
            const address = result.addresses.find(addr => addr.id === addressId);
            if (address) {
              openAddressModal(address);
            } else {
              showNotification('Address not found', 'error');
            }
          } else {
            showNotification('Failed to load address details', 'error');
          }
        } catch (error) {
          console.error('Error loading address for editing:', error);
          showNotification('Failed to load address details', 'error');
        }
      }

      // Delete address function
      async function deleteAddress(addressId) {
        if (!confirm('Are you sure you want to delete this address?')) {
          return;
        }

        try {
          const result = await FirebaseAddressManager.deleteAddress(addressId);
          if (result.success) {
            showNotification('Address deleted successfully!', 'success');
            loadAndDisplayAddresses();
          } else {
            showNotification('Failed to delete address: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error deleting address:', error);
          showNotification('An error occurred while deleting the address', 'error');
        }
      }

      // Set default address function
      async function setDefaultAddress(addressId) {
        try {
          const result = await FirebaseAddressManager.setDefaultAddress(addressId);
          if (result.success) {
            showNotification('Default address updated!', 'success');
            loadAndDisplayAddresses();
          } else {
            showNotification('Failed to set default address: ' + result.error, 'error');
          }
        } catch (error) {
          console.error('Error setting default address:', error);
          showNotification('An error occurred while updating default address', 'error');
        }
      }

      // Show notification function
      function showNotification(message, type = 'info') {
        // Remove existing notification
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
          existingNotification.remove();
        }

        // Create new notification
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;

        // Add to page (use modal container if it exists, otherwise body)
        const modalContainer = document.querySelector('.modal-overlay.show');
        if (modalContainer) {
          modalContainer.appendChild(notification);
        } else {
          document.body.appendChild(notification);
        }

        // Show notification
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);

        // Hide notification after 6 seconds (longer for error messages)
        const hideDelay = type === 'error' ? 6000 : 4000;
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, hideDelay);
      }

      // Make functions global for onclick handlers
      window.openAddressModal = openAddressModal;
      window.closeAddressModal = closeAddressModal;

      // Logout function
      async function logoutUser() {
        try {
          // Sign out with Firebase
          await firebase.auth().signOut();

          // Clear session data
          FirebaseAuth.clearSession();

          // Redirect to login
          window.location.href = 'login.html';
        } catch (error) {
          console.error("Logout error:", error);
          showError("An error occurred during logout. Please try again.");
        }
      }

      // Show error message
      function showError(message) {
        // Try to show error in the UI first
        const errorElement = document.getElementById('error-message');
        if (errorElement) {
          errorElement.innerHTML = message;
          errorElement.style.display = 'block';

          // Scroll to the top of the page to make sure error is visible
          window.scrollTo(0, 0);

          // Hide error after some time (unless it contains a button)
          if (!message.includes('button')) {
            setTimeout(() => {
              errorElement.style.display = 'none';
            }, 8000);
          }
        } else {
          // Fallback to alert if no error element is available
          alert(message);
        }
      }
    </script>

    <!-- Address Management Modal -->
    <div id="address-modal" class="modal-overlay">
      <div class="address-modal">
        <div class="modal-header">
          <h3 id="modal-title">Add New Address</h3>
          <button class="close-modal" onclick="closeAddressModal()">&times;</button>
        </div>
        <form id="address-form">
          <div class="form-row">
            <div class="form-group">
              <label for="modal-firstName">First Name *</label>
              <input type="text" id="modal-firstName" name="firstName" required minlength="2" maxlength="50">
              <div class="error-text" id="firstName-error">Please enter a valid first name</div>
            </div>
            <div class="form-group">
              <label for="modal-lastName">Last Name *</label>
              <input type="text" id="modal-lastName" name="lastName" required minlength="2" maxlength="50">
              <div class="error-text" id="lastName-error">Please enter a valid last name</div>
            </div>
          </div>

          <div class="form-group">
            <label for="modal-email">Email Address *</label>
            <input type="email" id="modal-email" name="email" required>
            <div class="error-text" id="email-error">Please enter a valid email address</div>
          </div>

          <div class="form-group">
            <label for="modal-phone">Phone Number *</label>
            <input type="tel" id="modal-phone" name="phone" required pattern="[0-9]{10}" maxlength="10" placeholder="1234567890">
            <div class="error-text" id="phone-error">Please enter a valid 10-digit phone number</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="modal-houseNumber">House/Building Number *</label>
              <input type="text" id="modal-houseNumber" name="houseNumber" required maxlength="50">
              <div class="error-text" id="houseNumber-error">House/Building number is required</div>
            </div>
            <div class="form-group">
              <label for="modal-pinCode">PIN Code *</label>
              <input type="text" id="modal-pinCode" name="pinCode" required pattern="[0-9]{6}" maxlength="6" placeholder="123456">
              <div class="error-text" id="pinCode-error">Please enter a valid 6-digit PIN code</div>
            </div>
          </div>

          <div class="form-group">
            <label for="modal-roadName">Road Name/Area/Colony *</label>
            <textarea id="modal-roadName" name="roadName" rows="2" required minlength="5" maxlength="200"></textarea>
            <div class="error-text" id="roadName-error">Road name/Area must be at least 5 characters long</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="modal-city">City *</label>
              <input type="text" id="modal-city" name="city" required minlength="2" maxlength="50">
              <div class="error-text" id="city-error">City name must be at least 2 characters long</div>
            </div>
            <div class="form-group">
              <label for="modal-state">State *</label>
              <select id="modal-state" name="state" required>
                <option value="">Select State</option>
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Bihar</option>
                <option value="Chhattisgarh">Chhattisgarh</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
                <option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option>
                <option value="Jharkhand">Jharkhand</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option>
                <option value="Madhya Pradesh">Madhya Pradesh</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option>
                <option value="Meghalaya">Meghalaya</option>
                <option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option>
                <option value="Odisha">Odisha</option>
                <option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option>
                <option value="Sikkim">Sikkim</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option>
                <option value="Tripura">Tripura</option>
                <option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttarakhand">Uttarakhand</option>
                <option value="West Bengal">West Bengal</option>
                <option value="Delhi">Delhi</option>
                <option value="Puducherry">Puducherry</option>
                <option value="Chandigarh">Chandigarh</option>
                <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                <option value="Ladakh">Ladakh</option>
                <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                <option value="Lakshadweep">Lakshadweep</option>
                <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
              </select>
              <div class="error-text" id="state-error">Please select a State</div>
            </div>
          </div>

          <div class="form-group">
            <label for="modal-addressType">Address Type</label>
            <select id="modal-addressType" name="addressType">
              <option value="home">Home</option>
              <option value="office">Office</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="modal-isDefault" name="isDefault">
            <label for="modal-isDefault">Set as default address</label>
          </div>

          <div class="modal-buttons">
            <button type="button" class="btn-secondary" onclick="closeAddressModal()">Cancel</button>
            <button type="submit" class="btn-primary" id="save-address-btn">
              <span id="save-btn-text">Save Address</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add spinner and notification styles -->
    <style>
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .notification {
        position: fixed;
        top: 80px; /* Lower position to be more visible on mobile/modals */
        right: 20px;
        left: 20px; /* Full width on mobile */
        max-width: 400px;
        margin: 0 auto; /* Center on small screens */
        background-color: #333;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        z-index: 10001; /* Higher than modal overlay (9999) to appear above forms */
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.3s, transform 0.3s;
        font-size: 14px;
        line-height: 1.4;
        text-align: center;
      }

      @media (min-width: 768px) {
        .notification {
          left: auto; /* Reset for desktop */
          max-width: none;
          margin: 0;
          text-align: left;
        }
      }

      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }

      .notification.success {
        background-color: #4CAF50;
      }

      .notification.error {
        background-color: #F44336;
      }

      .error-text {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        display: none;
        position: static;
        z-index: 1000;
        background: #ffebee;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #e74c3c;
        border-left: 4px solid #e74c3c;
        box-shadow: 0 2px 4px rgba(231, 76, 60, 0.1);
      }

      .error-text.show {
        display: block;
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group input.error,
      .form-group textarea.error,
      .form-group select.error {
        border-color: #e74c3c !important;
        background-color: #fdf2f2 !important;
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.1) !important;
      }

      .form-group input.valid,
      .form-group textarea.valid,
      .form-group select.valid {
        border-color: #27ae60 !important;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.1) !important;
      }
    </style>

    <!-- Cart Panel -->
    <div id="auricCartPanel" class="cart-panel" style="position:fixed !important; top:0 !important; right:-400px !important; width:400px !important; max-width:90% !important; height:100% !important; background:#ffffff !important; box-shadow:-2px 0 10px rgba(0,0,0,0.3) !important; z-index:999999 !important; transition:right 0.3s ease-in-out !important; display:flex !important; flex-direction:column !important; overflow:hidden !important; visibility:visible !important; pointer-events:auto !important;">
      <div class="cart-panel-header">
        <h3>Your Shopping Bag</h3>
        <button class="close-cart-btn" onclick="closeCartDirectly(); return false;">×</button>
      </div>
      <div class="cart-items">
        <!-- Cart items will be inserted here by JavaScript -->
        <div class="empty-cart-message">Your cart is empty</div>
      </div>
      <div class="cart-panel-footer">
        <div class="cart-panel-subtotal">
          <span>Subtotal:</span>
          <span class="subtotal-amount">₹0.00</span>
        </div>
        <div class="cart-panel-buttons">
          <button class="view-cart-btn continue-shopping-btn" onclick="closeCartDirectly(); return false;">Continue Shopping</button>
          <a href="checkout.html" class="checkout-btn">Checkout</a>
        </div>
      </div>
    </div>

    <!-- Ultra-direct Cart Overlay with ALL inline styles -->
    <div id="auricCartOverlay" class="cart-overlay" onclick="closeCartDirectly(); return false;" style="position:fixed !important; top:0 !important; left:0 !important; width:100% !important; height:100% !important; background:rgba(0,0,0,0.5) !important; z-index:999998 !important; display:none !important; visibility:hidden !important;"></div>

    <!-- WhatsApp Button -->
    <a href="https://wa.me/919310250047?text=Hi! I need help with my profile or orders. Can you assist me?" class="whatsapp-btn" onclick="openWhatsAppChat()">
        <i class="fab fa-whatsapp"></i>
    </a>

    <script>
        function openWhatsAppChat() {
            // Open WhatsApp with pre-filled message
            window.open('https://wa.me/919310250047?text=Hi! I need help with my profile or orders. Can you assist me?', '_blank');
        }
    </script>
  </body>
  <!-- Fix for closeCartDirectly error -->
  <script>
    // Define the missing closeCartDirectly function
    window.closeCartDirectly = function() {
      // Call the regular closeCart function
      if (window.closeCart) {
        return window.closeCart();
      }
    };
  </script>
</html>